function getTranslatedTag(tag,language){var name=null;return null==tag.data.name[language]&&(name=tag.data.name[language]),null==name&&(name=tag.data.name.en_US),name||tag.name||tag.slug}function prepareKeywordList(rawKeywords,language){if(0!==rawKeywords.length){var res=[],sizeSteps=rawKeywords.length/5;return rawKeywords.forEach(function(tag,i){var currentStep=0===i?0:parseInt(i*sizeSteps/rawKeywords.length),size=7-currentStep,name=getTranslatedTag(tag,language);res.push([name,size,'/publications?orderby=-date,-date_last_modified&filters={"tags__slug__and":["'+tag.slug+'"]}'])}),res}}function drawWordCloud(keywords,language){var canvas=document.getElementById("tagcloud"),allTags=prepareKeywordList(keywords,language);WordCloud(canvas,{list:allTags,classes:"force-pointer",click:function(item){window.location.href=item[2]},color:function(word,weight){return weight>=7?"#4ECDC4":weight>=5?"#225a54":"#1d4d48"},gridSize:Math.round(12*canvas.width/1024),weightFactor:function(size){return Math.pow(size,2.3)*canvas.width/1024},rotateRatio:0})}function prepareTagsContext(splitted){function prepareTagsContextSplitted(story){var context=function(){if(null===story._tags.writing||void 0===story._tags.writing)return"related-publications";for(var i;i<story._tags.writing.length;i++)if("revue-ecu-euro"===story._tags.writing[i].slug)return"publications";return"related-publications"}();Object.values(story._tags).forEach(function(tags){if(null!=tags){var ts=Array.isArray(tags)?tags:Object.values(tags);ts.forEach(function(tag){tag.context=context})}})}function prepareTagsContextFlat(story){var context=story.tags.findIndex(function(tag){return"revue-ecu-euro"===tag.slug})===-1?"related-publications":"publications";story.tags.forEach(function(tag){tag.context=context})}return splitted?prepareTagsContextSplitted:prepareTagsContextFlat}angular.module("miller",["ui.router","ngResource","ngSanitize","ngCookies","ngTagsInput","mgcrea.ngStrap","monospaced.elastic","LocalStorageModule","pascalprecht.translate","angularLoad","angularLazyImg","ngFileUpload","720kb.socialshare"]).constant("LOCALES",{locales:{en_US:"English"},preferredLocale:"en_US"}).constant("EVENTS",{SAVE:"save",PARAMS_CHANGED:"params_changed",DOWNLOAD:"download",MESSAGE:"message",BAD_REQUEST:"bad_request",PERMISSION_DENIED:"permission_denied",RESIZED:"resized",MARKDOWNIT_FULLSIZE:"markdownit_fullsize",MARKDOWNIT_RESOLVE:"markdownit_resolve",MARKDOWNIT_FOCUS:"markdownit_focus",STORY_SET_DOCUMENTS:"story_set_documents",SOCKET_USER_COMMENTED_STORY:"socket_user_commented_story",SOCKET_USER_UNCOMMENTED_STORY:"socket_user_uncommented_story",RANGY_FOCUS:"rangy_focus",RANGY_REFRESH:"rangy_refresh",LANGUAGE_CHANGED:"language_changed"}).config(function($logProvider,RUNTIME){console.log("ENABLE DEBUG:",!!RUNTIME.settings.debug),$logProvider.debugEnabled(!!RUNTIME.settings.debug)}).config(function($locationProvider){$locationProvider.hashPrefix("!")}).config(function(tagsInputConfigProvider,RUNTIME){tagsInputConfigProvider.setDefaults("tagsInput",{replaceSpacesWithDashes:!1,template:RUNTIME["static"]+"templates/partials/tag.input.html"}).setDefaults("autoComplete",{loadOnDownArrow:!0})}).config(function(lazyImgConfigProvider){lazyImgConfigProvider.setOptions({offset:200,errorClass:"error",successClass:"loaded"})}).config(function($translateProvider,RUNTIME){$translateProvider.useSanitizeValueStrategy(null),$translateProvider.useStaticFilesLoader({prefix:RUNTIME["static"]+"locale/locale-",suffix:".json"}),$translateProvider.preferredLanguage("en_US")}).config(function(localStorageServiceProvider){localStorageServiceProvider.setPrefix("miller")}).config(function($resourceProvider){$resourceProvider.defaults.stripTrailingSlashes=!1}).config(function($httpProvider){$httpProvider.defaults.xsrfCookieName="Miller",$httpProvider.defaults.xsrfHeaderName="X-CSRFToken",$httpProvider.interceptors.push(function($q,$rootScope,EVENTS){return{responseError:function(rejection){return 400==rejection.status?$rootScope.$emit(EVENTS.BAD_REQUEST,rejection):403==rejection.status&&$rootScope.$emit(EVENTS.PERMISSION_DENIED,rejection),$q.reject(rejection)}}})}).config(function($locationProvider){$locationProvider.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}).config(function($stateProvider,$urlRouterProvider,RUNTIME){$urlRouterProvider.otherwise("/"),$stateProvider.state("notfound",{url:"/not-found",controller:function($log){$log.warn("requested page not found.")},templateUrl:RUNTIME["static"]+"templates/index.html"}),$stateProvider.state("index",{url:"/",reloadOnSearch:!1,controller:"IndexCtrl",templateUrl:RUNTIME["static"]+"templates/index.html",resolve:{writings:function(StoryFactory){return StoryFactory.get({filters:JSON.stringify({tags__slug:"highlights",status:"public"}),limit:9,orderby:"-priority,-date"}).$promise},news:function(StoryFactory){return StoryFactory.get({filters:JSON.stringify({tags__category:"blog",status:"public"}),orderby:"-date"}).$promise},keywords:function(TagFactory){return TagFactory.get({used_keywords:!0,limit:20}).$promise.then(function(response){return response.results})}}}).state("index.signup",{url:"/",reloadOnSearch:!1,controller:"SignupCtrl",templateUrl:RUNTIME["static"]+"templates/signup.html"}).state("draft",{url:"/create",reloadOnSearch:!1,controller:"DraftCtrl",templateUrl:RUNTIME["static"]+"templates/draft.html"}).state("archives",{url:"/archives-resume","abstract":!0,reloadOnSearch:!1,controller:"ArchiveCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html"}).state("archives.all",{url:"",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:{tags__slug:"archives"},limit:100,orderby:"-date,-date_last_modified"}},items:function(StoryFactory,djangoFiltersService,initials){return StoryFactory.get(djangoFiltersService(initials)).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}).state("upload",{url:"/upload",reloadOnSearch:!1,controller:"UploadCtrl",templateUrl:RUNTIME["static"]+"templates/upload.html"}).state("uploaded",{url:"/uploaded/:storyId",reloadOnSearch:!1,controller:"UploadedCtrl",templateUrl:RUNTIME["static"]+"templates/uploaded.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.storyId}).$promise}}}).state("writing",{url:"/writing/:storyId?collection",reloadOnSearch:!1,controller:"WritingCtrl",templateUrl:RUNTIME["static"]+"templates/writings.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.storyId,nocache:!0}).$promise}}}).state("writing.live",{url:"/live",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/writings.live.html"}).state("writing.compare",{url:"/compare/:tag",reloadOnSearch:!1,controller:function($scope,version){$scope.version=version},templateUrl:RUNTIME["static"]+"templates/writings.compare.html",resolve:{version:function(StoryGitFactory,$stateParams){return StoryGitFactory.getByGitTag({id:$stateParams.storyId,commit:$stateParams.tag}).$promise}}}).state("writing.compare.diff",{url:"/diff",reloadOnSearch:!1,controller:function($scope,diff,story,StoryGitFactory,$stateParams){$scope.diff=diff.results.diff,$scope.hash=story.version,$scope.$watch("story",function(v){v.version&&v.version!=$scope.hash&&StoryGitFactory.getDiff({id:$stateParams.storyId,commit:$stateParams.tag},function(res){$scope.diff=res.results.diff})},!0)},templateUrl:RUNTIME["static"]+"templates/writings.compare.diff.html",resolve:{diff:function(StoryGitFactory,$stateParams){return StoryGitFactory.getDiff({id:$stateParams.storyId,commit:$stateParams.tag}).$promise}}}).state("writing.compare.preview",{url:"/preview",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/writings.compare.preview.html"}),$stateProvider.state("author",{"abstract":!0,reloadOnSearch:!1,url:"/author/{slug:[0-9a-zA-Z\\.\\-_]+}",controller:"AuthorCtrl",templateUrl:RUNTIME["static"]+"templates/author.html",resolve:{author:function(AuthorFactory,$stateParams){return AuthorFactory.get({slug:$stateParams.slug}).$promise}}}).state("author.publications",{url:"/related-publications","abstract":!0,reloadOnSearch:!1,controller:function($scope){$scope.urls=RUNTIME.stories},templateUrl:RUNTIME["static"]+"templates/author.publications.html"}).state("author.publications.drafts",{url:"/drafts",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(author){return{filters:{status:"draft",authors__slug:author.slug},orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}).state("author.publications.bin",{url:"/bin",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(author){return{filters:{status:"deleted",authors__slug:author.slug},orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}).state("author.publications.all",{url:"/",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(author){return{filters:{authors__slug:author.slug},orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}),_.each(RUNTIME.routes.publications.writing.concat(RUNTIME.routes.publications.tags),function(d){$stateProvider.state("author.publications."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(author){return{filters:d.slug?{tags__category__in:["writing","blog"],tags__slug:d.slug,authors__slug:author.slug}:{tags__category__in:["writing","blog"],authors__slug:author.slug},limit:10,orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}})}),$stateProvider.state("modifyauthor",{url:"/author/{slug:[0-9a-zA-Z\\.\\-_]+}/edit",controller:"AuthorEditCtrl",templateUrl:RUNTIME["static"]+"templates/author.edit.html",resolve:{author:function(AuthorFactory,$stateParams){return AuthorFactory.get({slug:$stateParams.slug}).$promise}}}),$stateProvider.state("profile",{url:"/profile/{username:[0-9a-zA-Z\\.\\-_]+}",controller:"ProfileCtrl",templateUrl:RUNTIME["static"]+"templates/profile.html",reloadOnSearch:!1,resolve:{profile:function(ProfileFactory,$stateParams){return ProfileFactory.get({username:$stateParams.username}).$promise},authors:function(ProfileFactory,$stateParams){return ProfileFactory.authors({username:$stateParams.username}).$promise}}}).state("profile.publications",{url:"/related-publications",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(profile){return{filters:{authors__user__username:profile.username},orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}),$stateProvider.state("assign",{"abstract":!0,url:"/assign",controller:"AssignCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html",reloadOnSearch:!1}),_.each(RUNTIME.routes.assign,function(d){$stateProvider.state("assign."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:{status__in:"all"==d.slug?["pending","review","editing","reviewdone"]:[d.slug]},orderby:"-date_last_modified"}},items:function(StoryFactory,djangoFiltersService,initials){return StoryFactory.pending(djangoFiltersService(initials)).$promise},model:function(){return"story.pending"},factory:function(StoryFactory){return StoryFactory.pending}}})}),$stateProvider.state("reviews",{"abstract":!0,url:"/reviews",controller:"ReviewsCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html",reloadOnSearch:!1}),_.each(RUNTIME.routes.reviews,function(d){$stateProvider.state("reviews."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:d.filters||{},orderby:"-date_last_modified"}},items:function(ReviewFactory,djangoFiltersService,initials){return ReviewFactory.get(djangoFiltersService(initials)).$promise},model:function(){return"review"},factory:function(ReviewFactory){return ReviewFactory.get}}})}),$stateProvider.state("reviews.reports",{url:"/reports",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{}},items:function(ReviewFactory){return ReviewFactory.reports(initials).$promise},model:function(){return"report"},factory:function(ReviewFactory){return ReviewFactory.reports}}}),$stateProvider.state("review",{url:"/review/{id:[0-9]+}",controller:"ReviewCtrl",templateUrl:RUNTIME["static"]+"templates/review.html",resolve:{review:function(ReviewFactory,$stateParams){return ReviewFactory.get({id:$stateParams.id}).$promise}}}).state("review.story",{url:"/story",controller:"StoryCtrl",templateUrl:RUNTIME["static"]+"templates/story.html",resolve:{story:function(review){return review.story}}}),$stateProvider.state("report",{url:"/report/{id:[0-9]+}",controller:"ReviewCtrl",templateUrl:RUNTIME["static"]+"templates/review.html",resolve:{review:function(ReviewFactory,$stateParams){return ReviewFactory.report({id:$stateParams.id}).$promise}}}),$stateProvider.state("blog",{url:"/blog",reloadOnSearch:!1,"abstract":!0,controller:"BlogCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html"}),_.each(RUNTIME.routes.blog,function(d){$stateProvider.state("blog."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:"all"!=d.slug?{tags__slug:d.slug}:{tags__category:"blog"},orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}})}),$stateProvider.state("authors",{url:"/authors",reloadOnSearch:!1,"abstract":!0,controller:"AuthorsCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html"}),_.each([{slug:"all",url:""}].concat(RUNTIME.routes.authors.tags,RUNTIME.routes.authors.writing),function(d){$stateProvider.state("authors."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:d.filters?d.filters:{},exclude:{data__num_stories:0},limit:20,orderby:"data__lastname"}},items:function(AuthorFactory,djangoFiltersService,initials){return AuthorFactory.get(djangoFiltersService(initials)).$promise},model:function(){return"author.item"},factory:function(AuthorFactory){return AuthorFactory.get}}})}),$stateProvider.state("euro-publications",{url:"/publications","abstract":!0,reloadOnSearch:!1,controller:"EuroPublicationsCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html",resolve:{keywords:function(TagFactory){return TagFactory.get({used_keywords:!0,limit:100}).$promise.then(function(response){return response.results})}}}).state("euro-publications.all",{url:"",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:{tags__category:"writing",tags__slug:"revue-ecu-euro"},limit:10,orderby:"-date,-date_last_modified"}},items:function(StoryFactory,djangoFiltersService,initials){return StoryFactory.get(djangoFiltersService(initials)).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}).state("publications",{url:"/related-publications","abstract":!0,reloadOnSearch:!1,controller:"PublicationsCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html",resolve:{keywords:function(TagFactory){return TagFactory.get({used_keywords:!0,limit:100}).$promise.then(function(response){return response.results})}}}).state("publications.tags",{url:"/tags/:slug",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:{tags__category:"writing"},limit:10,orderby:"-date,-date_last_modified"}},items:function(StoryFactory,$stateParams,djangoFiltersService,initials){return initials.filters.tags__slug__all=[$stateParams.slug],StoryFactory.get(djangoFiltersService(initials)).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}),_.each(RUNTIME.routes.publications.all.concat(RUNTIME.routes.publications.writing,RUNTIME.routes.publications.specials,RUNTIME.routes.publications.tags,RUNTIME.routes.publications.status),function(d){$stateProvider.state("publications."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:d.filters?d.filters:d.slug?{tags__category:"writing",tags__slug:d.slug}:{tags__category:"writing"},exclude:{tags__slug:"revue-ecu-euro"},limit:10,orderby:d.orderby?d.orderby:"-date,-date_last_modified"}},items:function(StoryFactory,djangoFiltersService,initials){return StoryFactory.get(djangoFiltersService(initials)).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}})}),$stateProvider.state("search",{url:"/search",controller:"SearchCtrl",reloadOnSearch:!1,"abstract":!0,templateUrl:RUNTIME["static"]+"templates/search.html"}).state("search.story",{url:"?q",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{}},items:function(StoryFactory,$stateParams,initials,djangoFiltersService){return StoryFactory.search(djangoFiltersService($stateParams)).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.search}}}),$stateProvider.state("story",{url:"/story/:postId",controller:"StoryCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/story.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.postId}).$promise}}}).state("storygit",{url:"/story/:id/git/:commit",controller:"StoryCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/story.html",resolve:{story:function(StoryGitFactory,$stateParams){return StoryGitFactory.getByGitTag({id:$stateParams.id,commit:$stateParams.commit}).$promise}}}).state("story.story",{url:"/:chapterId",controller:"ChapterCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/story.chapter.html",resolve:{chapter:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.chapterId}).$promise}}}),$stateProvider.state("notifications",{"abstract":!0,url:"/notifications",controller:"NotificationsCtrl",templateUrl:RUNTIME["static"]+"templates/notifications.html"}).state("notifications.activities",{url:"/activities",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{}},items:function(PulseFactory,initials){return PulseFactory.activities(initials).$promise},model:function(){return"action"},factory:function(PulseFactory){return PulseFactory.get}}}),$stateProvider.state("page",{url:"/:name",controller:"PageCtrl",templateUrl:RUNTIME["static"]+"templates/md.html",resolve:{page:function(PageFactory,$stateParams){return PageFactory.get({name:$stateParams.name}).$promise}}})}).run(function($window,$log,RUNTIME){$log.log("☕ app run, version: Kidding Tiger; analytics:",RUNTIME.settings.analytics?"enabled":"disabled"),RUNTIME.settings.analytics&&$window.ga("create",RUNTIME.settings.analytics||"UA-XXXXXXXX-X","auto")}),angular.module("miller").filter("prefixTemplate",function(RUNTIME){return function(input){return RUNTIME["static"]+input}}).filter("bibtex",function(){return function(text){return text?text.replace(/[\{\}]/g,""):""}}).filter("inArray",function(){return function(arr,value){return Array.isArray(arr)&&arr.indexOf(value)!==-1}}).filter("smartUrl",function(){return function(text){return(text||"").replace(/^https?:\/\/(www)?\.?([^\/]*)\/(.*)$/,function(m,www,domain,path){return domain+"/..."+path.substr(-25)})}}).filter("multilanguage",function($rootScope){return function(obj){return"object"!=typeof obj?obj:obj[$rootScope.language]}}).filter("tokenize",function(){return function(text,maxwords){if(!text)return"";var words=text.split(/(?!=\.\s)\s/),sentence=_.take(words,maxwords).join(" ");return sentence.length<text.length&&(sentence.match(/\?\!\.$/)||(sentence+=" "),sentence+="..."),sentence}}).filter("coverage",function(){return function(cover,hifi){var url,_hifi="hifi"==hifi;return"object"!=typeof cover?"":url=cover.data?_hifi?cover.data.media_url||_.get(cover,"data.urls.Publishable")||cover.data.thumbnail_url||cover.data.preview||cover.data.url||cover.attachment||cover.snapshot:cover.data.thumbnail_url||cover.data.preview||_.get(cover,"data.urls.Preview")||cover.snapshot||cover.attachment||cover.data.url:_hifi?cover.attachment||cover.snapshot:cover.snapshot||cover.attachment}}).filter("substr",function(){return function(text,start,end){return text.substr(start,end)}}).filter("statetoclass",function(){return function(text){return(text||"").split(".").join(" ")}}).filter("quotes",function(){return function(text,language){var st={lq:{en_US:{"«":"“",'"':"“"},fr_FR:{"“":"«",'"':"«"}},rq:{en_US:{"»":"”",'"':"”"},fr_FR:{"”":"»",'"':"»"}}};return st.rq[language]?(text||"").replace(/([\s,;\?\.\!\[\]\(\)])(["«“])([^"»”]*)(["»”])([\s,;\?\.\!\[\]\(\)])/g,function(m,left,lq,quote,rq,right){return[left,st.lq[language][lq]||lq,quote,st.rq[language][rq]||rq,right].join("")}):text}}).filter("slugify",function(){return function(text){for(var strip=/[^\w\s-]/g,hyphen=/[-\s]+/g,slug=text.toLowerCase(),map={from:"àáäãâèéëêìíïîòóöôõùúüûñç·/_,:;",to:"aaaaaeeeeiiiiooooouuuunc------"},i=0,j=map.from.length;i<j;i++)slug=slug.replace(new RegExp(map.from.charAt(i),"g"),map.to.charAt(i));return slug.replace(strip,"").trim().replace(hyphen,"-")}}),angular.module("miller").service("parseHeaderFilename",function(){return function(headers){var header=headers("content-disposition"),result=header.split(";")[1].trim().split("=")[1];return result.replace(/"/g,"")}}).factory("AuthFactory",function($resource){return $resource("/auth/:fn/",{},{login:{method:"POST",params:{fn:"login"}},register:{method:"POST",fn:"register"}})}).factory("CrossRefFactory",function($http){return{search:function(query,page,rows){return $http.get("http://search.crossref.org/dois",{params:{q:query,header:"true",page:page||1,rows:rows||8}})}}}).factory("StoryFactory",function($resource,parseHeaderFilename){return $resource("/api/story/:id/:fn/",{},{update:{method:"PUT"},publish:{method:"POST",params:{fn:"publish"}},search:{method:"GET",params:{fn:"search"}},patch:{method:"PATCH"},getComments:{params:{fn:"comments"},method:"GET"},featured:{params:{fn:"featured"},method:"GET"},getNeighbors:{params:{fn:"neighbors"},method:"GET"},pending:{params:{fn:"pending"},method:"GET"},download:{params:{fn:"download"},method:"GET",responseType:"arraybuffer",transformResponse:function(data,headers){return{data:data,filename:parseHeaderFilename(headers)}}}})}).factory("StoryDOIMetadataFactory",function($resource){return $resource("/api/story/:id/doi/:fn/",{},{getMetadata:{method:"GET",params:{fn:"metadata"}},updateMetadata:{method:"POST",params:{fn:"metadata"}}})}).factory("StoryGitFactory",function($resource,parseHeaderFilename){return $resource("/api/story/:id/git/:fn/:commit/",{},{getByGitTag:{params:{fn:"tag"},method:"GET"},getDiff:{params:{fn:"diff"},method:"GET"},saveVersion:{params:{fn:"tag"},method:"POST"}})}).factory("StoryTagsFactory",function($resource){return $resource("/api/story/:id/tags/",{},{update:{method:"PUT"}})}).factory("StoryDocumentsFactory",function($resource){return $resource("/api/story/:id/documents/",{},{update:{method:"PUT"}})}).factory("ProfileFactory",function($resource){return $resource("/api/profile/:username/:related",{},{authors:{method:"GET",params:{related:"authors/"}},update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("UserFactory",function($resource){return $resource("/api/user/:fn",{},{getReviewers:{method:"GET",params:{fn:"reviewers"}}})}).factory("PulseFactory",function($resource){return $resource("/api/pulse/:fn/",{},{activities:{method:"GET"},unread:{method:"GET",params:{fn:"unread"}},noise:{method:"GET",params:{fn:"noise"}},reset:{method:"POST",params:{fn:"reset"}}})}).factory("CollectionFactory",function($resource){return $resource("/api/collection/:id/",{},{})}).factory("AuthorFactory",function($resource){return $resource("/api/author/:slug/:fn/",{},{update:{method:"PUT"},patch:{method:"PATCH"},hallOfFame:{method:"GET",params:{fn:"hallOfFame"}}})}).factory("DocumentFactory",function($resource){return $resource("/api/document/:id/:fn",{},{update:{method:"PUT"},suggest:{method:"GET",params:{fn:"suggest"}},oembed:{method:"GET",params:{fn:"oembed/"}}})}).factory("MentionFactory",function($resource){return $resource("/api/mention/:id/")}).factory("CaptionFactory",function($resource){return $resource("/api/caption/:id/",{},{update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("CommentFactory",function($resource){return $resource("/api/comment/:id/",{},{})}).factory("ReviewFactory",function($resource){return $resource("/api/review/:id/:fn",{},{patch:{method:"PATCH"},close:{method:"POST",params:{fn:"close/"}},report:{method:"GET",params:{fn:"report/"}},reports:{method:"GET",params:{fn:"reports/"}}})}).factory("TagFactory",function($resource){return $resource("/api/tag/:id/:fn/",{},{update:{method:"PUT"},hallOfFame:{method:"GET",params:{fn:"hallOfFame"}}})}).factory("PageFactory",function($resource,RUNTIME){return $resource("/api/page/:name/",{},{})}).service("QueryParamsService",function($filter){return function(queryparams){var params={};return queryparams.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(str,key,value){params[key]=decodeURIComponent(value)}),params}}).service("djangoFiltersService",function($location){return function(params){var _params=angular.copy(params),qs=$location.search();if(qs.filters)try{_params.filters=JSON.stringify(angular.merge(_params.filters||{},JSON.parse(qs.filters||"{}"))),_params.exclude=JSON.stringify(angular.merge(_params.exclude||{},JSON.parse(qs.exclude||"{}")))}catch(e){$log.warn("ItemsCtrl @EVENTS.PARAMS_CHANGED wrong filters provided!")}return qs.orderby&&(_params.orderby=qs.orderby),_params}}).service("bibtexService",function($filter){return function(json){}}).service("markdownItLanguageService",function($filter){return function(value,language){var candidate;return value?(candidate=_(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/)).compact().chunk(2).fromPairs().value(),candidate["lang:"+language]?candidate["lang:"+language]:value):""}}).service("markdownItChaptersService",function($filter,markdownItLanguageService){return function(value,language){var links=[],linkIndex=0,md=new window.markdownit;return md.renderer.rules.link_open=function(tokens,idx){var url=tokens[idx].attrGet("href").trim();0===url.indexOf("voc/")&&(linkIndex++,links.push({_index:linkIndex,citation:tokens[idx+1].content,slug:url.replace("voc/","").split(",")[0],type:"chapter"}))},md.render(markdownItLanguageService(value,language)),links}}).service("markdownItService",function($filter){return function(value,language,disableLazyPlaceholders){var results,md=new window.markdownit({html:!0}),linkIndex=0;if(results={md:value,html:"",ToC:[],docs:[],paragraphs:0,footnotes:{}},md.use(window.markdownitFootnote).use(window.markdownitContainer,"profile").use(window.markdownitContainer,"profile-committee").use(window.markdownitContainer,"profile-others").use(window.markdownitContainer,"abstract").use(window.markdownItAttrs),md.renderer.rules.link_open=function(tokens,idx){var url=tokens[idx].attrGet("href").trim(),klass=tokens[idx].attrGet("class")||"";if(0===url.indexOf("doc/")){var doc=url.trim().replace("doc/","").replace(/\//g,"-").split(",")[0];return linkIndex++,results.docs.push({_index:linkIndex,_type:tokens[idx+1].content.length?"doc":"block-doc",citation:tokens[idx+1].content,slug:doc}),disableLazyPlaceholders||tokens[idx+1].content.length?'<a id="item-'+linkIndex+'" class="special-link'+(tokens[idx+1].content.length?"":" block")+'" name="'+doc+'" ng-click="focus(\''+linkIndex+"','"+url+"', 'doc')\"><span hold slug=\""+doc+'" type="doc"  class="anchor-wrapper"></span><span class="icon icon-eye"></span>':'<span id="item-'+linkIndex+'" class="lazy-placeholder '+klass+'" type="doc" lazy-placeholder="'+doc+'"></span><a>'}if(0===url.trim().indexOf("voc/")){var terms=url.trim().replace("voc/","").split(",");for(var ind in terms)linkIndex++,results.docs.push({_index:linkIndex,_type:"voc",citation:tokens[idx+1].content,slug:terms[ind],type:"glossary"});return tokens[idx].attrSet("class","glossary"),'<a id="item-'+linkIndex+'" class="special-link glossary"  ng-click="focus(\''+linkIndex+'\')"><span hold slug="'+terms[0]+'" type="voc" class="anchor-wrapper"></span><span class="icon icon-arrow-right-circle"></span>'+(disableLazyPlaceholders||tokens[idx+1].content.length?"":"&nbsp;")}return'<a href="'+url+'" target="_blank">'},md.renderer.rules.table_open=function(tokens,idx){return'<table class="table">'},md.renderer.rules.heading_open=function(tokens,idx){var text=tokens[idx+1].content,h={text:text,level:tokens[idx].tag.replace(/[^\d]/g,""),slug:$filter("slugify")(text)};return results.ToC.push(h),"<"+tokens[idx].tag+'><a name="'+h.slug+'" id="h-'+h.slug+'" class="anchor" href="#'+h.slug+'"><span class="header-link"></span></a>'},console.log("rules",md.renderer.rules),md.renderer.rules.image=function(tokens,idx){var src=tokens[idx].attrGet("src"),title=tokens[idx].attrGet("title"),alt=tokens[idx].content;return 0===alt.indexOf("profile/")?'<div class="profile-thumb" style="background-image:url('+src+')"></div>':'<img src="'+src+'" title="'+title+'" alt="'+alt+'"/>'},md.renderer.rules.footnote_anchor=function(tokens,idx,options,env,slf){var caption=slf.rules.footnote_caption(tokens,idx,options,env,slf);return'<span class="footnote-anchor">'+caption.replace(/[\[\]]/g,"")+"</span>"},md.renderer.rules.footnote_ref=function(tokens,idx,options,env,slf){var id=slf.rules.footnote_anchor_name(tokens,idx,options,env,slf),caption=slf.rules.footnote_caption(tokens,idx,options,env,slf);return linkIndex++,results.docs.push({_index:linkIndex,_type:"footnote",id:id,caption:caption}),"<span  ng-click=\"focus('"+linkIndex+'\')" id="item-'+linkIndex+'" class="footnote-ref"><span class="footnote"><a>'+caption+"</a></span></span>"},value.replace(/[\n\s\r]*---[\n\r]((.|[\n\r])+)\.{3}[\n\s\r]*/m,function(d,m){return results.meta=m,""}),language){var candidate=_(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/)).compact().chunk(2).fromPairs().value();candidate["lang:"+language]?value=candidate["lang:"+language]:candidate["lang:en_US"]&&(value=candidate["lang:en_US"]),value=$filter("quotes")(value,language)}return results.html=md.render(value),results}}).service("extendItem",function($injector){return function(item,model,options){return"story"==model?$injector.get("extendStoryItem")(item,options.language):item}}).service("extendStoryItem",function(markdownItChaptersService){return function(story,language){story._chapters=[],story._biography=null,story._isBiography=!1,story._isCollection=!1,story._tags={};for(var i=0,j=story.tags.length;i<j;i++){if("writing"==story.tags[i].category&&"collection"==story.tags[i].slug){var links=markdownItChaptersService(story.contents,language),stories=_.keyBy(story.stories,"slug");
story._chapters=_(links).map(function(d){return stories[d.slug]?stories[d.slug]:void console.warn("chapter with slug: ",d.slug,"was not found in related stories!!!")}).compact().value(),story._isCollection=!0}else"writing"==story.tags[i].category&&"biography"==story.tags[i].slug&&(story._isBiography=!0);story._tags[story.tags[i].category]||(story._tags[story.tags[i].category]={}),story.tags[i].status&&(story._tags[story.tags[i].category][story.tags[i].id]=story.tags[i])}if(story.data._ordering||(story.data._ordering={}),story.data._ordering.authors){var authors=_.keyBy(story.authors,"id");story.authors=story.data._ordering.authors.map(function(d){return authors[d]})}else story.data._ordering.authors=_.map(story.authors,"id");if(story.data._ordering.tags)for(var category in story.data._ordering.tags)story._tags[category]=_(story.data._ordering.tags[category]).uniq().map(function(d){return!(!story._tags[category]||!story._tags[category][d])&&story._tags[category][d]}).filter(function(d){return d!==!1}).value(),story.tags=_(story._tags).map(_.identity).flatten().compact().value();else story.data._ordering.tags=_.mapValues(story._tags,function(d){return _.map(d,"id")});return story.covers=story.covers.filter(function(doc){return story._isBiography&&"entity"==doc.type&&"person"==doc.data.type&&(story._biography=doc),"entity"!=doc.type}),story._isBiography=!!story._biography&&!!story._biography.data.activities&&!!story._biography.data.activities.length,story}}).factory("metadataFactory",function($log){return{parse:function(story){$log.info("[service] metadata.parse")},create:function(story){}}}),angular.module("miller").controller("ArchiveCtrl",function($scope,$log,$state,$timeout,$q,AuthorFactory,TagFactory,RUNTIME,EVENTS){$scope.rootStatename="archives",$scope.mainStatename="archives.all"}),angular.module("miller").controller("AssignCtrl",function($scope,$log,$modal,ReviewFactory,UserFactory,RUNTIME,EVENTS){$log.log("⏱ AssignCtrl ready");var addReviewModal,finalDecisionModal;$scope.mainStatename="assign.all",$scope.availableRoutes=[{state:"assign",urls:RUNTIME.routes.assign}],$scope.availabileOrderby=[{label:"newest",value:"-date,-date_last_modified"},{label:"oldest",value:"date,-date_last_modified"},{label:"titleaz",value:"title"},{label:"titleza",value:"-title"}],$scope.sync=function(){$scope.ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label")||"newest"},$scope.suggestReviewer=function(query,options){$log.log("⏱ AssignCtrl -> suggestReviewer",query,options);return UserFactory.getReviewers({}).$promise.then(function(response){return response.results})},$scope.addReview=function(story){$log.log("⏱ AssignCtrl -> open addReviewModal."),addReviewModal=$modal({scope:$scope,controller:"AddReviewModalCtrl",resolve:{story:function(){return story}},templateUrl:RUNTIME["static"]+"templates/partials/modals/add-review.html",id:"addReview"}),addReviewModal.$promise.then(addReviewModal.show)},$scope.finalDecision=function(story){$log.log("⏱ AssignCtrl -> open finalDecisionModal."),finalDecisionModal=$modal({scope:$scope,controller:"FinalDecisionModalCtrl",resolve:{story:function(){return story}},templateUrl:RUNTIME["static"]+"templates/partials/modals/final-decision.html",id:"addReview"}),finalDecisionModal.$promise.then(finalDecisionModal.show)},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("⏱ AssignCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()})}),angular.module("miller").controller("AuthorCtrl",function($scope,$log,author){$scope.isMe=!!author.profile&&$scope.user.username==author.profile.username,$log.log("AuthorCtrl ready, author:",author.fullname),$scope.author=author}).controller("AuthorEditCtrl",function($scope,$state,$log,AuthorFactory,author,EVENTS){$log.log("AuthorEditCtrl ready, author:",author,$scope.previousState),$scope.author=author,$scope.isSaving=!1,$scope.save=function(){return $log.log("AuthorEditCtrl -> save()",$scope.author),$scope.isSaving?void $log.warn("wait, try again in. Is still saving."):($scope.isSaving=!0,void AuthorFactory.patch({slug:$scope.author.id},{fullname:[$scope.author.data.firstname,$scope.author.data.lastname].join(" "),data:$scope.author.data,affiliation:$scope.author.affiliation},function(res){$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.isSaving=!1,$scope.previousState.from&&$scope.previousState.from.name&&$scope.previousState.from.name.length?$state.go($scope.previousState.from.name,$scope.previousState.fromParams):$state.go("author.publications.all",{slug:$scope.author.slug})},function(err){$log.error("error:",err.data),$scope.isSaving=!1}))}}),angular.module("miller").controller("AuthorsCtrl",function($scope,$log,RUNTIME,EVENTS){$log.log("⏱ AuthorsCtrl ready"),$scope.mainStatename="authors.all",$scope.availableRoutes=[{state:"authors",urls:RUNTIME.routes.authors.writing},{state:"authors",urls:RUNTIME.routes.authors.tags}],$scope.availabileOrderby=[{label:"publishedrecently",value:"-stories__date"},{label:"lastnameaz",value:"data__lastname"},{label:"lastnameza",value:"-data__lastname"}],$scope.sync=function(){$scope.ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label")||"lastnameaz"},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("⏱ AuthorsCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()})}),angular.module("miller").controller("BlogCtrl",function($scope,$log,RUNTIME,EVENTS){$log.log("⏱ BlogCtrl ready"),$scope.mainStatename="blog.all",$scope.availableRoutes=[{state:"blog",urls:RUNTIME.routes.blog}],$scope.availabileOrderby=[{label:"newest",value:"-date,-date_last_modified"},{label:"oldest",value:"date,-date_last_modified"},{label:"titleaz",value:"title"},{label:"titleza",value:"-title"}],$scope.sync=function(){$scope.ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label")||"newest"},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("⏱ BlogCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()})}),angular.module("miller").controller("ChapterCtrl",function($log,$scope,$timeout,chapter,EVENTS){$scope.chapter=chapter,$scope.chapter.isWritable=$scope.hasWritingPermission($scope.user,$scope.chapter),$scope.isChapter=!0,$scope.setDocuments=function(items){var documents=[];$scope.sidedocuments=0,documents=_(items).map(function(d){for(var i=0;i<chapter.documents.length;i++)if(chapter.documents[i].slug==d.slug)return $scope.sidedocuments+=d.citation.length,angular.extend({_type:d._type,_index:d._index,citation:d.citation},chapter.documents[i]);for(i=0;i<chapter.stories.length;i++)if(chapter.stories[i].slug==d.slug)return $scope.sidedocuments+=d.citation.length,angular.extend({_type:d._type,_index:d._index,citation:d.citation},chapter.stories[i]);return d}).value(),$timeout(function(){$log.log("ChapterCtrl > setDocuments items n.:",documents.length,$scope.sidedocuments>0?"WITH":"NO","sideDocuments."),documents.length>0&&$scope.$emit(EVENTS.STORY_SET_DOCUMENTS,documents)},1e3)}}),angular.module("miller").controller("CollectionCtrl",function($scope,$rootScope,$log,collection,EVENTS,StoryFactory,markdownItChaptersService){$log.log("CollectionCtrl ready",$scope.user.username,$scope.language),$scope.collection=collection,$scope.collection.isWritable=$scope.hasWritingPermission($scope.user,$scope.collection),collection.covers.length&&($scope.collection.cover=_.first(collection.covers)),$scope.setStatus=function(status){$log.debug("CollectionCtrl -> setStatus - status:",status),$scope.user.is_staff&&($scope.$emit(EVENTS.MESSAGE,"saving"),StoryFactory.update({id:$scope.collection.id},{title:$scope.collection.title,status:status},function(res){$scope.collection.status=res.status,$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock()}))};var links=markdownItChaptersService(collection.contents,$scope.language),stories=_.keyBy(collection.stories,"slug");$scope.chapters=_(links).map(function(d){return stories[d.slug]?stories[d.slug]:void $log.warn("chapter with slug: ",d.slug,"was not found in related stories!!!")}).compact().value()}),angular.module("miller").controller("CoreCtrl",function($rootScope,$scope,$log,$location,$window,$anchorScroll,$state,$modal,$alert,localStorageService,$filter,$translate,$timeout,StoryFactory,DocumentFactory,TagFactory,UserFactory,AuthorFactory,RUNTIME,EVENTS){$log.log("🍔 CoreCtrl ready, user:",RUNTIME.user.username,RUNTIME),$scope.user=$rootScope.user=RUNTIME.user,$scope.userGroups=_.map(RUNTIME.user.profile.groups,"name"),$scope.user.is_reviewer=$scope.userGroups.indexOf("reviewers")!=-1,$scope.user.is_chief_reviewer=$scope.userGroups.indexOf("chief-reviewers")!=-1,$scope.settings=RUNTIME.settings,$rootScope.page="index",$scope.hasToC=!1,$scope.ToCEnabled=!1,$scope.stopStateChangeStart=!1,$scope.toggleTableOfContents=function(e){$scope.hasToC=!$scope.hasToC,e&&e.stopImmediatePropagation()},$scope.locationPath="",$scope.toggleStopStateChangeStart=function(value){$log.debug("🍔 CoreCtrl > toggleStopStateChangeStart value:",value,"- current:",$scope.stopStateChangeStart),$scope.stopStateChangeStart="boolean"==typeof value?value:!$scope.stopStateChangeStart},$scope.setToC=function(ToC){$log.log("🍔 CoreCtrl > setToC data:",ToC),$scope.ToC=ToC},$scope.disableToC=function(){$scope.ToCDisabled=!0},$scope.search=function(searchquery){$log.log("🍔 CoreCtrl > search() searchquery:",searchquery),$state.go("search.story",{q:searchquery})},$scope.setDocuments=function(documents){$log.log("🍔 CoreCtrl > setDocuments items n.:",documents.length,documents),$scope.documents=_.uniq(documents,"id")},$scope.$on(EVENTS.STORY_SET_DOCUMENTS,function(e,documents){$log.log("🍔 CoreCtrl @EVENTS.STORY_SET_DOCUMENTS setDocuments documents n.:",documents.length),$scope.setDocuments(documents)}),$rootScope.resolve=function(slug,type,callback){if("voc"==type)$log.log("🍔 CoreCtrl > $scope.resolve [requesting] voc slug:",slug),StoryFactory.get({id:slug},callback);else{var matching=$scope.documents.filter(function(d){return d.slug==slug});matching.length?($log.log("🍔 CoreCtrl > $scope.resolve [cached] doc slug:",slug),callback(matching[0])):($log.log("🍔 CoreCtrl > $scope.resolve [requesting] doc slug:",slug),DocumentFactory.get({id:slug},callback))}},$scope.save=function(){$log.log("🍔 CoreCtrl > @SAVE ..."),$scope.$broadcast(EVENTS.SAVE)},$scope.params={},$scope.filters={},$scope.changeOrderby=function(orderby){$log.log("🍔 CoreCtrl > @changeOrderby ..."),$location.search("orderby",orderby)};var setNewLocation=function(location){var params=$location.search();null!==location&&void 0!==location&&$location.path()!==location&&$location.path(location),"orderby"in params&&params.orderby&&"featured"!==params.orderby?$location.search("filters",angular.equals({},$scope.filters)?null:JSON.stringify($scope.filters)):(params.orderby="-date,-date_last_modified",params.filters=JSON.stringify($scope.filters),$location.search(params))};$scope.toggleFilter=function(key,value){$log.log("🍔 CoreCtrl > @setFilters ..."),$scope.filters[key]==value?delete $scope.filters[key]:$scope.filters[key]=value,setNewLocation()},$rootScope.getTagRoute=function(tag){return void 0===tag.context&&(tag.context="related-publications"),"/"+tag.context+'?orderby=-date,-date_last_modified&filters={"tags__slug__and":["'+tag.slug+'"]}'},$scope.selectTag=function(tag,filterType,location){void 0!==filterType&&null!==filterType||(filterType="tags__slug__and"),filterType in $scope.filters||($scope.filters[filterType]=[]),$scope.filters[filterType].indexOf(tag)!==-1?($scope.filters[filterType].splice($scope.filters[filterType].indexOf(tag),1),0===$scope.filters[filterType].length&&delete $scope.filters[filterType]):$scope.filters[filterType].push(tag),setNewLocation(location)},$scope.selectSingleTag=function(tag,filterType){void 0!==filterType&&(filterType in $scope.filters&&$scope.filters[filterType]===tag?delete $scope.filters[filterType]:$scope.filters[filterType]=tag,setNewLocation())},$scope.isTagActive=function(tag){return $scope.isActive("tags__slug__and",tag)},$scope.isAuthorActive=function(tag){return $scope.isActive("authors__slug__and",tag)},$scope.isActive=function(filterType,tag){return $scope.filters[filterType]&&$scope.filters[filterType].findIndex(function(e){return e===tag})!==-1},$scope.download=function(){$log.log("🍔 CoreCtrl > @DOWNLOAD ..."),$scope.$broadcast(EVENTS.DOWNLOAD)},$scope.update=function(key,value){$log.log("🍔 CoreCtrl > @UPDATE ",key,":",value," ...");var _d={};_d[key]=value,$scope.$broadcast(EVENTS.UPDATE,_d)},$scope.lock=function(){$scope.locked=!0,$log.log("🍔 CoreCtrl > lock .............")},$scope.unlock=function(msg){$scope.locked=!1,$log.log("🍔 CoreCtrl > unlock ............. message:",msg)},$scope.suggestTags=function(query,options,has_create){$log.log("🍔 CoreCtrl -> suggestTags",query,options);var filters=options||{},params={filters:JSON.stringify(filters),limit:7};return query.trim().length>2&&(params.q=query),TagFactory.get(params).$promise.then(function(response){return has_create?response.results.concat([{type:"__new__",name:"createnew",id:"createnew",query:query}]):response.results})},$scope.breakingNews=[],$scope.setBreakingNews=function(breakingNews){$scope.breakingNews=breakingNews.slice(0,3).map(function(d){if(d.covers&&d.covers.length){var cover=d.covers[0];d.cover_url=$filter("coverage")(cover)}return d.isCollection=_.filter(d.tags,{slug:"collection"}).length>0,d})},$rootScope.$on("$stateChangeStart",function(e,state){if($log.log("🍔 CoreCtrl @stateChangeStart new:",state.name,"- previous:",$scope.state),"login"==state.name&&$scope.user.short_url)return $log.warn("... cannot swithc to login, user already logged in:",$scope.user.username),e.preventDefault(),void($scope.state&&"login"!=$scope.state?$state.go($scope.state):$state.go("index"));if($scope.stopStateChangeStart===!0){var answer=confirm("Are you sure you want to leave this page?");answer||e.preventDefault()}}),$rootScope.$on("$stateChangeSuccess",function(e,state,stateParams,from,fromParams){var h=$location.hash();$scope.ToC=[],$scope.documents=[],$scope.state=state.name,$scope.previousState={from:from,fromParams:fromParams},$rootScope.page=_.compact(state.name.split(".").filter(function(d){return["page","all","story"].indexOf(d)==-1}).concat([$state.params.name,$state.params.storyId,$state.params.postId])).join(" - "),$scope.absoluteUrl=$rootScope.absoluteUrl=$state.href($state.current.name,$state.params,{absolute:!0}),$log.debug("🍔 CoreCtrl @stateChangeSuccess - name:",state.name,"- page:",$rootScope.page),h&&h.length&&$timeout($anchorScroll,0),$scope.toggleStopStateChangeStart(!1),$window.ga("send","pageview",$location.path())}),$scope.setHash=function(hash){$location.hash(hash)},$scope.changeLanguage=function(key){$scope.language=key,$rootScope.language=key,localStorageService.set("lang",$scope.language),$log.log("🍔 CoreCtrl -> changeLanguage language:",$scope.language),$translate.use(key),$scope.$broadcast(EVENTS.LANGUAGE_CHANGED,$scope.language)},$scope.isWithoutAuthors=function(story){return 0!==story.authors.length},$scope.hasWritingPermission=function(user,story){return!!user.username&&user.username.length>0&&(user.is_staff||story.owner.username==user.username||_.map(story.authors,"profile.user.username").indexOf(user.username)!==-1)};var fullsizeModal=$modal({scope:$scope,template:RUNTIME["static"]+"templates/partials/modals/fullsize.html",id:"dii",show:!1});$scope.$on("modal.hide",function(e,modal){$scope.fullsized=null}),$rootScope.fullsize=function(slug,type){if($log.log("🍔 CoreCtrl -> fullsize -slug:",slug,"-type:",type),"voc"==type)$state.go("story",{postId:slug});else{for(var _isCached=!1,i=0,j=$scope.documents.length;i<j;i++)if(slug==$scope.documents[i].slug){$scope.fullsized=$scope.documents[i],fullsizeModal.$promise.then(fullsizeModal.show),_isCached=!0;break}_isCached||($log.log("🍔 CoreCtrl -> fullsize, doc slug:",slug,"not found in documents, loading..."),DocumentFactory.get({id:slug},function(res){$scope.fullsized=res,fullsizeModal.$promise.then(fullsizeModal.show)}))}},$scope.suggestUser=function(query,options){$scope.user.is_staff||$log.warn("🍔 CoreCtrl -> suggestUser is avaialble to staff only, you should not be here."),$log.log("🍔 CoreCtrl -> suggestUser",query,options);var filters=options||{};return UserFactory.get({filters:JSON.stringify(filters)}).$promise.then(function(response){return response.results})},window.onbeforeunload=function(event){if($scope.state&&["draft","writing"].indexOf($scope.state)!==-1){var message="Sure you want to leave?";return"undefined"==typeof event&&(event=window.event),event&&(event.returnValue=message),message}},$scope.setOG=function(OG){$log.debug("CoreCtrl -> setOG",OG),$rootScope.OG=angular.extend({title:"",description:"",image:""},OG||{})},$scope.$on("$locationChangeSuccess",function(e,path){$log.debug("🍔 CoreCtrl @locationChangeSuccess",path,$location),$scope.qs=$location.search();try{$scope.filters=$scope.qs.filters?JSON.parse($scope.qs.filters):{},$log.log("🍔 CoreCtrl load filters: ",$scope.filters)}catch(ex){$log.warn("🍔 CoreCtrl couldn't load filters",ex),$scope.filters={}}$scope.locationPath=path,$scope.path=$location.path(),$scope.searchquery=$scope.qs.q,$scope.fullsized&&($scope.fullsized=null,fullsizeModal.hide()),$scope.$broadcast(EVENTS.PARAMS_CHANGED,$scope.qs)}),$scope.setLocationFilter=function(field,value){$location.search(field,value)},$scope.removeLocationFilter=function(field){$location.search(field,null)},$scope.calculateBounds=function(event){$rootScope.isASmallScreen=$window.innerWidth<992},$rootScope.$on(EVENTS.BAD_REQUEST,function(e,rejection){$log.warn("@BAD_REQUEST."),400==rejection.status&&$alert({placement:"top",title:"form errors",animation:"bounceIn",content:_(rejection.data).map(function(d,k){return"<div><b>"+k+"</b>: "+d+"</div>"}).value().join(""),show:!0,type:"error"})}),$rootScope.$on(EVENTS.PERMISSION_DENIED,function(e,rejection){$log.warn("@PERMISSION_DENIED. Should redirect",$location.absUrl())});var timer_event_message;$scope.$on(EVENTS.MESSAGE,function(e,message){$log.log("🍔 CoreCtrl @MESSAGE",message),$scope.message=message,timer_event_message&&$timeout.cancel(timer_event_message),timer_event_message=$timeout(function(){$scope.message=null},2e3)}),angular.element($window).bind("keydown",function(event){if(event.ctrlKey||event.metaKey)switch(String.fromCharCode(event.which).toLowerCase()){case"s":event.preventDefault(),$scope.save()}}),angular.element($window).bind("resize",$scope.calculateBounds),$scope.language=localStorageService.get("lang")||"en_US",$scope.changeLanguage($scope.language),StoryFactory.featured({},function(data){$log.log("🍔 CoreCtrl breaking news loaded",data),$scope.setBreakingNews(data.results)}),$scope.calculateBounds()}),angular.module("miller").controller("DraftCtrl",function($scope,$log,$state,localStorageService,StoryFactory,EVENTS){$log.debug("DraftCtrl welcome"),$scope.isSaving=!1,$scope.save=function(){if($log.log("DraftCtrl -> save()"),$scope.isSaving)return void $log.warn(" .. is still saving, be patient.");$scope.isSaving=!0;var metadata={title:{},"abstract":{}};metadata.title[$scope.language]=$scope.title,metadata["abstract"][$scope.language]=$scope["abstract"],StoryFactory.save({},{title:$scope.title,"abstract":$scope["abstract"],contents:"",data:metadata,status:"draft"},function(res){$scope.isSaving=!1,$scope.$emit(EVENTS.MESSAGE,"saved"),$log.log("DraftCtrl -> @EVENTS.SAVE saved:",res),$state.go("writing",{storyId:res.slug})},function(err){$log.error(err),$scope.isSaving=!1})},$scope.$on(EVENTS.SAVE,function(){$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.save()})}),angular.module("miller").controller("IndexCtrl",function($rootScope,$scope,$log,$filter,$location,writings,news,keywords,RUNTIME){function excerpt(story){story.excerpt={},story.tags&&story.tags.length&&_.filter(story.tags,{slug:"collection",category:"writing"}).length&&(story.is_collection=!0),story.keywords=_.filter(story.tags,{category:"keyword"});for(var i in story.data["abstract"])story.excerpt[i]=$filter("tokenize")(story.data["abstract"][i],38);return story}$log.debug("IndexCtrl welcome",writings,news),$scope.setOG({type:"platform"}),writings.results=writings.results.map(excerpt);var tagsContextFn=prepareTagsContext(!1);writings.results.forEach(tagsContextFn),$scope.coverstories=_.take(writings.results,3),$scope.otherstories=_.takeRight(writings.results,writings.results.length-3),$scope.news=news.results.map(excerpt),$scope.$watch("language",function(newValue,oldValue){newValue!==oldValue&&drawWordCloud(keywords,newValue)}),drawWordCloud(keywords,$rootScope.language),$log.debug("IndexCtrl welcome",$scope.news)}),angular.module("miller").controller("ItemsCtrl",function($scope,$log,$filter,$state,initials,items,model,factory,QueryParamsService,extendItem,EVENTS){function normalizeItems(items){var md=new window.markdownit({breaks:!0,linkify:!0,html:!1}).disable(["image","heading"]);return items.map(function(d){return d.data&&d.data["abstract"]?(d=extendItem(d,$scope.model,{language:$scope.language}),_tag||"publications.tags"!=$scope.state||(_tag=!0,$scope.setTag(_.find(d.tags,{slug:$state.params.slug}))),d.data["abstract"][$scope.language]?(d.excerpt=md.renderInline($filter("tokenize")(d.data["abstract"][$scope.language],32)),d):d):d})}$log.log("🌻 ItemsCtrl ready, n.:",items.count,"- items:",items,"initials:",initials),$scope.model=model.split(".").shift(),$scope.itemTemplate=model,$scope.nextParams={};var _tag;"publications.tags"==$scope.state?initials.filters.tags__slug__all=[$state.params.slug]:initials.filters&&delete initials.filters.tags__slug__all,"search.story"==$scope.state&&$scope.setCount(items.count),"publications.tags"!=$scope.state&&"function"==typeof $scope.setTag&&$scope.setTag(null),$scope.sync=function(res){$scope.isLoadingNextItems=!1,$scope.nextParams=QueryParamsService(res.next||""),$log.log("🌻 ItemsCtrl > sync() next:",$scope.nextParams),$scope.count=res.count,$scope.items=($scope.items||[]).concat(normalizeItems(res.results)),$scope.items.forEach(prepareTagsContext(!1)),$scope.missing=res.count-$scope.items.length},$scope.more=function(){return $scope.isLoadingNextItems?void $log.warn("🌻 is still loading"):($scope.isLoadingNextItems=!0,void factory($scope.nextParams,$scope.sync))},$scope.sync(items),$scope.$on(EVENTS.PARAMS_CHANGED,function(e,newParams){if($scope.isLoadingNextItems)return void $log.warn("🌻 ItemsCtrl @EVENTS.PARAMS_CHANGED wait, is still loading");$log.log("🌻 ItemsCtrl @EVENTS.PARAMS_CHANGED - params:",newParams),$scope.isLoadingNextItems=!0,$scope.items=[];var params=angular.copy(initials);for(var key in newParams)if("filters"==key)try{params.filters=JSON.stringify(angular.merge(params.filters,JSON.parse(newParams.filters)))}catch(e){$log.warn("🌻 ItemsCtrl @EVENTS.PARAMS_CHANGED wrong filters provided!"),params.filters=initials.filters}else params[key]=newParams[key];factory(params,$scope.sync)})}),angular.module("miller").controller("LoginCtrl",function($scope,$log,AuthFactory,$location){$log.log("👉 LoginCtrl ready"),$scope.login=function(){$log.debug("👉 LoginCtrl > login"),$scope.pwd&&$scope.pwd.length&&$scope.username&&$scope.username&&AuthFactory.login({username:$scope.username,password:$scope.pwd},function(res){$location.url("/")},function(err){$log.error("👉 LoginCtrl > login error:",err.data)})}}),angular.module("miller").controller("NotificationsCtrl",function($scope,$log,RUNTIME){$log.log("⏱ NotificationsCtrl ready")}),angular.module("miller").controller("PageCtrl",function($scope,$log,page){$log.log("PageCtrl ready",page.status),$scope.md=page.contents,$scope.setOG()}),angular.module("miller").controller("ProfileCtrl",function($scope,$log,profile,authors){$log.log("ProfileCtrl ready, profile:",profile,authors),$scope.profile=profile,$scope.authors=authors.results}),angular.module("miller").controller("PublicationsCtrl",function($scope,$rootScope,$log,$state,$timeout,$q,AuthorFactory,TagFactory,RUNTIME,EVENTS,keywords){$log.log("🔭 PublicationsCtrl welcome"),$scope.rootStatename="publications",$scope.mainStatename="publications.all",$scope.tagsStateurl="/related-publications",$scope.mainRoutes=$scope.user.is_staff?RUNTIME.routes.publications.status:[],$scope.keywords=keywords;var availableRoutes=RUNTIME.routes.publications.availableRoutes||["writing","tags"];$scope.availableRoutes=availableRoutes.map(function(d){return RUNTIME.routes.publications[d].map(function(o){return o.state="publications",o})}).flat().filter(function(route){return"revue-ecu-euro"!==route.slug}),$scope.availabileOrderby=[{label:"issue",value:"data__issue,-date"},{label:"newest",value:"-date,-date_last_modified"},{label:"oldest",value:"date,-date_last_modified"},{label:"lastmod",value:"-date_last_modified"},{label:"titleaz",value:"title"},{label:"titleza",value:"-title"}],$scope.setTag=function(tag){tag&&$log.log("🔭 PublicationsCtrl -> setTag - slug:",tag.slug,"- name:",tag.name),$scope.tag=tag};var HallOfFames=[];$scope.hallOfFame={},$scope.sync=function(){var ordering,initials=$state.current.resolve.initials(),filters={},exclude={};if(ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label"),!ordering&&initials.orderby&&(ordering=_.get(_.find($scope.availabileOrderby,{value:initials.orderby}),"label")),ordering||(ordering="newest"),$scope.ordering=ordering,initials.filters){"publications.tags"==$scope.state&&(initials.filters.tags__slug__all=[$state.params.slug]);try{filters=angular.extend({},initials.filters,$scope.filters)}catch(e){$log.warn("🔭 PublicationsCtrl sync() cannot parse filters correctly")}}if(initials.exclude)try{exclude=JSON.parse(initials.exclude)}catch(e){$log.warn("🔭 PublicationsCtrl sync() cannot parse filters correctly")}$log.log("🔭 PublicationsCtrl sync()",$scope.state),RUNTIME.monographies.indexOf($scope.state)!==-1?HallOfFames.push(TagFactory.hallOfFame({tag__filters:JSON.stringify({category:"publishing"}),orderby:"slug",filters:JSON.stringify(filters),exclude:JSON.stringify(exclude),limit:100},function(res){$scope.hallOfFame.publishings={count:res.count,results:res.results}},function(){}).$spromise):delete $scope.hallOfFame.publishings,HallOfFames.push(AuthorFactory.hallOfFame({filters:JSON.stringify(filters),exclude:JSON.stringify(exclude),limit:10},function(res){$scope.hallOfFame.topAuthors={count:res.count,results:res.results}}).promise),$q.all(HallOfFames,function(){$log.log("🔭 PublicationsCtrl sync() $q.all() finished",$scope.state)})},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("🔭 PublicationsCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()}),$scope.getTranslatedTag=function(tag){return getTranslatedTag(tag,$rootScope.language)}}).controller("EuroPublicationsCtrl",function($scope,$rootScope,$log,$state,$timeout,$q,AuthorFactory,TagFactory,RUNTIME,EVENTS,keywords){$scope.rootStatename="euro-publications",$scope.mainStatename="euro-publications.all",$scope.tagsStateurl="/publications",$scope.mainRoutes=$scope.user.is_staff?RUNTIME.routes.publications.status:[],$scope.keywords=keywords,$scope.availableRoutes=[],$scope.availabileOrderby=[{label:"issue",value:"data__issue,-date"},{label:"newest",value:"-date,-date_last_modified"},{label:"oldest",value:"date,-date_last_modified"},{label:"lastmod",value:"-date_last_modified"},{label:"titleaz",value:"title"},{label:"titleza",value:"-title"}],$scope.setTag=function(tag){tag&&$log.log("🔭 PublicationsCtrl -> setTag - slug:",tag.slug,"- name:",tag.name),$scope.tag=tag};var HallOfFames=[];$scope.hallOfFame={},$scope.sync=function(){var ordering,initials=$state.current.resolve.initials(),filters={},exclude={};if(ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label"),!ordering&&initials.orderby&&(ordering=_.get(_.find($scope.availabileOrderby,{value:initials.orderby}),"label")),ordering||(ordering="newest"),$scope.ordering=ordering,initials.filters){"publications.tags"==$scope.state&&(initials.filters.tags__slug__all=[$state.params.slug]);try{filters=angular.extend({},initials.filters,$scope.filters)}catch(e){$log.warn("🔭 PublicationsCtrl sync() cannot parse filters correctly")}}if(initials.exclude)try{exclude=JSON.parse(initials.exclude)}catch(e){$log.warn("🔭 PublicationsCtrl sync() cannot parse filters correctly")}$log.log("🔭 PublicationsCtrl sync()",$scope.state),RUNTIME.monographies.indexOf($scope.state)!==-1?HallOfFames.push(TagFactory.hallOfFame({tag__filters:JSON.stringify({category:"publishing"}),orderby:"slug",filters:JSON.stringify(filters),exclude:JSON.stringify(exclude),limit:100},function(res){$scope.hallOfFame.publishings={count:res.count,results:res.results}},function(){}).$spromise):delete $scope.hallOfFame.publishings,HallOfFames.push(AuthorFactory.hallOfFame({filters:JSON.stringify(filters),exclude:JSON.stringify(exclude),limit:10},function(res){$scope.hallOfFame.topAuthors={count:res.count,results:res.results}}).promise),$q.all(HallOfFames,function(){$log.log("🔭 PublicationsCtrl sync() $q.all() finished",$scope.state)})},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("🔭 PublicationsCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()}),$scope.getTranslatedTag=function(tag){return getTranslatedTag(tag,$rootScope.language)}}),angular.module("miller").controller("PulseCtrl",function($scope,$rootScope,$log,PulseFactory,RUNTIME,EVENTS){if($log.log("⚡ PulseCtrl ready"),$scope.pulsationsCount=0,$scope.pulsations=[],!RUNTIME.settings.wshost)return void $log.warn("⚡ PulseCtrl disabled, no wshost received; please check your miller settings.");var socket=window.socket=new ReconnectingWebSocket(RUNTIME.settings.wshost+"?session_key="+RUNTIME.settings.session_key);socket.onmessage=function(e){$log.log("⚡ PulseCtrl @onmessage raw data:",e.data);var d=e.data;if("object"!=typeof e.data)try{d=JSON.parse(e.data)}catch(err){return void $log.log("⚡ PulseCtrl @onmessage: unable to json parse data: ",e.data,"- error received:",err)}switch($scope.user&&d.actor&&d.actor.username!=$scope.user.username&&$scope.pulsationsCount++,d.verb){case"commented":$rootScope.$emit(EVENTS.SOCKET_USER_COMMENTED_STORY,d),$scope.pulsations.unshift(d);break;case"uncommented":$rootScope.$emit(EVENTS.SOCKET_USER_UNCOMMENTED_STORY,d)}$scope.$apply()},socket.onopen=function(){$log.log("⚡ PulseCtrl online"),$scope.user.username&&PulseFactory.unread({},function(res){$scope.pulsationsCount=res.count})},socket.onclose=function(e){$log.warn("⚡ PulseCtrl socket closed.",e)},socket.onerror=function(e){$log.error("⚡ PulseCtrl socket error",e)},socket.readyState==WebSocket.OPEN&&socket.onopen(),$scope.resetPulsations=function(){return $scope.isLoading?void $log.warn("⚡ PulseCtrl > resetPulsations() still loading..."):($log.log("⚡ PulseCtrl > resetPulsations()"),$scope.isLoading=!0,void PulseFactory.reset({},function(res){$scope.pulsationsCount=0,$scope.isLoading=!1,$scope.pulsations=[]},function(err){$log.warn("⚡ PulseCtrl > loadPulsations() failed!",err),$scope.isLoading=!1}))},$scope.loadPulsations=function(){return $scope.isLoading?void $log.warn("⚡ PulseCtrl > loadPulsations() still loading..."):($log.log("⚡ PulseCtrl > loadPulsations()"),$scope.isLoading=!0,void PulseFactory.noise({},function(res){$scope.pulsations=res.results,$scope.isLoading=!1,$log.log("⚡ PulseCtrl > loadPulsations() success!")},function(err){$log.warn("⚡ PulseCtrl > loadPulsations() failed!",err)}))},$scope.rangyHighlight=function(highlight){$log.log("⚡ PulseCtrl > rangyHighlight()"),$rootScope.$emit(EVENTS.RANGY_FOCUS,highlight)}}),angular.module("miller").controller("ReviewCtrl",function($scope,$rootScope,$log,$state,review,ReviewFactory,RUNTIME,EVENTS){$log.log("⏱ ReviewCtrl ready"),$scope.fields=["thematic","interest","originality","innovation","interdisciplinarity","methodology","clarity","argumentation","structure","references","pertinence"],$scope.availableStatuses=["draft","approved","refusal","bounce"],$scope.reviewStatus=""+review.status,$scope.is_assignee=review.assignee.username==$scope.user.username,$scope.is_reviewed=["complete","refusal","bounce"].indexOf(review.status)!==-1,
$scope.is_editable=$scope.is_assignee&&("draft"==review.status||"initial"==review.status),$scope.save=function(){if($log.debug("⏱ ReviewCtrl @SAVE"),$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.lock(),$scope.isSaving)return void $log.warn("wait, try again in. Is still saving.");$scope.isSaving=!0,answers={};for(s in $scope.fields){var field=$scope.fields[s];answers[field]=$scope.review[field],answers[field+"_score"]=$scope.review[field+"_score"]||0}answers.contents=$scope.review.contents,answers.status="draft",ReviewFactory.patch({id:review.id},answers,function(review){$scope.review=review,$log.debug("⏱ ReviewCtrl @SAVE: success"),$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock(),$scope.isSaving=!1,$scope.toggleStopStateChangeStart(!1)},function(err){$log.warn("⏱ ReviewCtrl @SAVE: error",err),$scope.$emit(EVENTS.MESSAGE,"error!"),$scope.unlock(),$scope.isSaving=!1})},$scope.finalize=function(status){if($log.debug("⏱ ReviewCtrl -> finalize() status:",status),$scope.$emit(EVENTS.MESSAGE,"closing the review"),$scope.is_editable=!1,$scope.lock(),$scope.isSaving)return void $log.warn("wait, try again in. Is still saving.");$scope.isSaving=!0;var answers={};for(s in $scope.fields){var field=$scope.fields[s];answers[field]=$scope.review[field],answers[field+"_score"]=$scope.review[field+"_score"]||0}answers.contents=$scope.review.contents,answers.status=status,ReviewFactory.patch({id:review.id},answers,function(res){$log.debug("⏱ ReviewCtrl -> finalize(): success",res),$scope.unlock(),$scope.isSaving=!1,$state.go("report",{id:review.id})},function(err){$log.warn("⏱ ReviewCtrl @SAVE: error",err),$scope.$emit(EVENTS.MESSAGE,"Your request cannot be resolved. Is the review submitted already?"),$scope.unlock(),$scope.isSaving=!1})};var autosave=_.debounce(function(){$scope.save()},5e3,{leading:!0}),__first=!0;$scope.$watch("review",function(r,p){if(r){var filledIn=_.filter(r,function(d,k){return k.indexOf("_score")!=-1});$scope.points=filledIn.reduce(function(a,b){return a+b}),$scope.is_valid=_.compact(filledIn).length==$scope.fields.length&&(r.contents||"").trim().length>0,$log.log("⏱ ReviewCtrl @review - points:",$scope.points,"- can be submitted:",$scope.is_valid,"- filled in fields:",_.compact(filledIn).length),!__first&&$scope.is_editable&&autosave(),__first=!1}},!0),$scope.review=review,$scope.$on(EVENTS.SAVE,$scope.save)}),angular.module("miller").controller("ReviewsCtrl",function($scope,$log,RUNTIME,EVENTS){$log.log("⏱ ReviewsCtrl ready"),$scope.mainStatename="reviews.all",$scope.availableRoutes=[{state:"reviews",urls:RUNTIME.routes.reviews}],$scope.availabileOrderby=[{label:"newest",value:"-date_last_modified"},{label:"oldest",value:"date_last_modified"},{label:"statusaz",value:"status"},{label:"statusza",value:"-status"},{label:"typeaz",value:"category"},{label:"typeza",value:"-category"}],$scope.sync=function(){$scope.ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label")||"newest"},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("⏱ ReviewsCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()})}),angular.module("miller").controller("SearchCtrl",function($scope,$log,$stateParams,$location,StoryFactory){console.log("SearchCtrl welcome",$stateParams.query),$scope.setCount=function(count){$scope.count=count}}),angular.module("miller").controller("SignupCtrl",function($scope,$log){$log.debug("SignupCtrl welcome")}),angular.module("miller").controller("StoryCtrl",function($rootScope,$scope,$log,$filter,$timeout,$modal,story,StoryFactory,StoryGitFactory,CommentFactory,QueryParamsService,extendStoryItem,EVENTS,RUNTIME){story=extendStoryItem(story,$scope.language),prepareTagsContext(!0)(story),$scope.story=story,$scope.story.isWritable=$scope.hasWritingPermission($scope.user,$scope.story),$scope.story.isReviewable=_.get($scope,"review.assignee.username")==$scope.user.username,$scope.story.isUnderReview=["review","editing","pending"].indexOf(story.status)!==-1,$scope.layout="inline",$scope.isLoading=!1,$scope.setOG({title:story.data.title[$scope.language]||story.title,description:story.data["abstract"][$scope.language]||story["abstract"],image:_(story.covers).map(function(d){return _.get(d,"snapshot")||_.get(d,"metadata.thumbnail_url")||_.get(d,"metadata.urls.Publishable")||_.get(d,"metadata.urls.Preview")||_.get(d,"metadata.url")}).first()}),$scope.setStatus=function(status){return $scope.user.is_staff||"public"!=status?($log.debug("StoryCtrl -> setStatus - status:",status),$scope.$emit(EVENTS.MESSAGE,"saving"),void StoryFactory.update({id:$scope.story.id},{title:$scope.story.title,status:status},function(res){console.log("StoryCtrl -> setStatus - new status:",res),$scope.story.status=res.status,$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock()})):void $log.warn("StoryCtrl -> setStatus failed:",status)},$scope.publish=function(){if($scope.isLoading)return void $log.warn("StoryCtrl > publish() is busy...");$modal({controller:function($scope){$scope.language=$scope.$parent.language,$scope.title="confirm.publish.title",$scope.question="confirm.publish.question",$scope.confirm=function(){$scope.isLoading=!0,StoryFactory.publish({id:$scope.story.id},{},function(res){$scope.story.status=res.status,$scope.story.isUnderReview=["review","editing","pending"].indexOf(res.status)!==-1,$scope.$hide()},$scope.unlock)},$scope.dismiss=function(){$scope.setStatus("draft")}},placement:"confirm",templateUrl:RUNTIME["static"]+"templates/partials/modals/confirm.html",show:!0,scope:$scope})},$scope.comments=[],$scope.commentsCount=0,$scope.isLoadingComments=!1,$scope.commentsNextParams={},$scope.loadComments=function(){return $scope.isLoadingComments?void $log.warn("StoryCtrl > loadComments() is busy loading...!"):($scope.isLoadingComments=!0,$log.log("StoryCtrl > loadComments() loading..."),void StoryFactory.getComments(angular.extend({id:story.id,filters:JSON.stringify({version:story.version}),orderby:"-date_created"},$scope.commentsNextParams),function(res){$scope.comments=($scope.comments||[]).concat(res.results),$scope.commentsCount=res.count,$scope.commentsNextParams=QueryParamsService(res.next||""),$scope.isLoadingComments=!1,$log.log("StoryCtrl > loadComments() loaded. Next:",$scope.commentsNextParams)},function(e){$scope.isLoadingComments=!1,$log.error(e)}))},$scope.moreComments=function(){$scope.loadComments()},$scope.commented=function(error,comment){$log.log("StoryCtrl > commented() deprecaed")},$scope.removeComment=function(comment){return comment.disappear=!0,$scope.isLoadingComments?void $log.warn("StoryCtrl > removeComment() is busy loading...!"):($log.log("StoryCtrl > removeComment() comment:",comment.short_url),$scope.isLoadingComments=!0,void CommentFactory["delete"]({id:comment.short_url},function(res){$scope.isLoadingComments=!1,$log.log("StoryCtrl > removeComment() success!",comment.short_url)},function(){$scope.isLoadingComments=!1}))},$scope.loadNeighbors=function(){StoryFactory.getNeighbors({id:story.id},function(res){$scope.neighbors=res})},$timeout($scope.loadNeighbors(),2e3),$scope.versions=[],$scope.isLoadingVersions=!1,$scope.loadVersions=function(){$scope.isLoadingVersions=!0,StoryGitFactory.getByGitTag({id:story.id},function(res){console.log(res),$scope.isLoadingVersions=!1,$scope.versions=res.results},function(err){console.error(err),$scope.isLoadingVersions=!1})},$scope.createReview=function(){$scope.setStatus("review")},$scope.download=function(){StoryFactory.download({id:$scope.story.id}).$promise.then(function(result){var url=URL.createObjectURL(new Blob([result.data])),a=document.createElement("a");a.href=url,a.download=result.filename,a.target="_blank",a.click()})["catch"](function(error){console.log(error)})},$scope.listener=function(event,data,callback){switch($log.log("StoryCtrl > listener, event:",event,data),event){case EVENTS.MARKDOWNIT_FOCUS:$scope.focusedIdx=data.idx;break;case EVENTS.MARKDOWNIT_FULLSIZE:$rootScope.fullsize(data.slug.replace(/\//g,"-"),data.type);break;case EVENTS.MARKDOWNIT_RESOLVE:$rootScope.resolve(data.slug.replace(/\//g,"-"),data.type,callback)}},$log.log("StoryCtrl ready, title:",story.title,"isWritable:",$scope.story.isWritable),$scope.setDocuments=function(items){$log.log("StoryCtrl > setDocuments items n.:",items.length,items);var documents=[];$scope.sidedocuments=0,documents=_(items).map(function(d){for(var i=0;i<story.documents.length;i++)if(story.documents[i].slug==d.slug)return $scope.sidedocuments+=!!d.citation.length,angular.extend({_type:d._type,_index:d._index,citation:d.citation},story.documents[i]);for(i=0;i<story.stories.length;i++)if(story.stories[i].slug==d.slug)return $scope.sidedocuments+=!!d.citation.length,angular.extend({_type:d._type,_index:d._index,citation:d.citation},story.stories[i]);return $scope.sidedocuments++,d}).value(),$log.log("StoryCtrl > setDocuments items n.:",items.length,"- documents n:",documents.length,"- sideDocuments:",$scope.sidedocuments),$scope.$parent.setDocuments(documents)},$scope.commentsSelected=function(uids){$log.log("StoryCtrl > commentsSelected uids:",uids)},$rootScope.$on(EVENTS.SOCKET_USER_COMMENTED_STORY,_.debounce(function(e,data){data.target.id==story.id&&($log.log("StoryCtrl @SOCKET_USER_COMMENTED_STORY, update the comment list!"),data.info.comment.highlights&&$scope.story.highlights.push(data.info.comment.highlights),data.info.comment.unread=!0,$scope.comments.unshift(data.info.comment),$scope.commentsCount++,$scope.commentsNextParams.offset&&$scope.commentsNextParams.offset++,$scope.$apply())},200)),$rootScope.$on(EVENTS.SOCKET_USER_UNCOMMENTED_STORY,function(event,data){data.target.id==story.id&&($log.log("StoryCtrl @SOCKET_USER_UNCOMMENTED_STORY, update the comment list!",$scope.comments),$scope.commentsCount--,$scope.comments=_.filter($scope.comments,function(d){return d.short_url!=data.info.comment.short_url}),data.info.comment.highlights&&data.info.comment.highlights.length&&($scope.story.highlights=_.filter($scope.story.highlights,function(d){return d!=data.info.comment.highlights})),$scope.$apply())})}),angular.module("miller").controller("UploadCtrl",function($scope,$state,$log,Upload,EVENTS){$log.debug("UploadCtrl welcome"),$scope.uploadable={title:"","abstract":""},$scope.$watch("docx",function(v){v&&($log.debug("UploadCtrl @docx",v.name,v.size),$scope.uploadable.docx=v,$scope.uploadable.name=v.name,$scope.uploadable.size=v.size)}),$scope.upload=function(){return $log.debug("UploadCtrl -> upload()"),$scope.createForm.$valid?!$scope.uploadable.docx||$scope.uploadable.docx.$error?void $log.warn("UploadCtrl -> upload() cannot find a valid docx file"):void Upload.upload({url:"/api/story/",data:{title:$scope.uploadable.title,"abstract":$scope.uploadable["abstract"],source:$scope.uploadable.docx}}).then(function(res){$log.debug("UploadCtrl -> upload() status:",res.status),201==res.status&&($log.debug("UploadCtrl -> upload() status:","success!",res.data),$state.go("story",{postId:res.data.slug}))},null,function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);$log.log("progress: "+progressPercentage+"% "+evt.config.data.source.name)}):void $log.warn("UploadCtrl -> upload() errors:",$scope.createForm.$error)}}),angular.module("miller").controller("UploadedCtrl",function($scope,$log,story){$log.debug("UploadedCtrl welcome",story),$scope.story=story}),angular.module("miller").controller("WritingCtrl",function($rootScope,$scope,$log,$q,$modal,$filter,$timeout,story,StoryGitFactory,localStorageService,extendStoryItem,StoryFactory,StoryTagsFactory,StoryDocumentsFactory,CaptionFactory,MentionFactory,DocumentFactory,AuthorFactory,TagFactory,EVENTS,RUNTIME){$log.debug("WritingCtrl writing title:",story.title,"-id:",story.id,"- current language:",$scope.language),story=extendStoryItem(story,$scope.language),$scope.story=story,$scope.isSaving=!1,["title","abstract"].forEach(function(field){$scope.language&&!$scope.story.data[field][$scope.language]&&($scope.story.data[field][$scope.language]=story[field])}),$scope.id=story.id,$scope.title=$scope.story.data.title[$scope.language],$scope["abstract"]=$scope.story.data["abstract"][$scope.language],$scope.contents=story.contents,$scope.tagFields=RUNTIME.writings.tags;for(var i=0,j=$scope.tagFields.length;i<j;i++)$scope.tagFields[i].tags=_.filter(story.tags,$scope.tagFields[i].lambda);$scope.metadata={status:story.status,owner:story.owner},$scope.setStatus=function(status){$scope.metadata.status=status,$scope.save()};var initialItems={doc:_.map(story.documents,"slug"),voc:_.map(story.stories,"slug")};$scope.sideItems=[],$scope.setDocuments=function(items){$log.log("WritingCtrl -> setDocuments()",items.length);for(var tobesaved={doc:[],voc:[]},tobedeleted={doc:[],voc:[]},tobekept={doc:[],voc:[]},i=0;i<items.length;i++){var t="block-doc"==items[i]._type?"doc":items[i]._type;initialItems[t]&&(initialItems[t].indexOf(items[i].slug)===-1?tobesaved[t].push(items[i].slug):tobekept[t].push(items[i].slug))}tobedeleted.doc=_.difference(initialItems.doc,tobekept.doc,tobesaved.doc),tobedeleted.voc=_.difference(initialItems.voc,tobekept.voc,tobesaved.voc),$log.log("... tobesaved:",tobesaved),$log.log("... tobedeleted:",tobedeleted),$log.log("... tobekept:",tobekept),$q.all(_.compact(_.uniq(tobesaved.doc).map(function(slug){var p=CaptionFactory.save({story:story.id,document:slug},function(res){$log.warn("... CaptionFactory.save success",res)},function(err){$log.warn("... CaptionFactory.save failed",err)}).promise;return p}).concat(_.uniq(tobesaved.voc).map(function(slug){$log.log("... saving voc->story slug:",slug);var p=MentionFactory.save({from_story:story.id,to_story:{slug:slug}},function(res){$log.log("... saving voc->story success",res)},function(err){$log.warn("... saving voc->story success failed miserably: ",err)}).promise;return p})).concat(_.uniq(tobedeleted.doc).map(function(slug){$log.log("... deleting doc->story slug:",slug)})).concat(_.uniq(tobedeleted.voc).map(function(slug){$log.log("... deleting voc->story slug:",slug)})))).then(function(results){$log.log("... setDocuments() done. Results:",results),results.length&&$scope.save(),$scope.sideItems=items})};var refresh;$scope.setMarked=function(marked){$log.log("WritingCtrl > setMarked()"),$scope.marked=marked,refresh&&$timeout.cancel(refresh),refresh=$timeout(function(){$rootScope.$emit(EVENTS.RANGY_REFRESH)},1e3)},$scope.setCover=function(doc){$log.debug("WritingCtrl -> setCover() doc:",doc.id),$scope.isSaving=!0,$scope.lock(),StoryFactory.patch({id:story.id},{covers:$scope.biography?[$scope.biography.id,doc.id]:[doc.id]}).$promise.then(function(res){$log.debug("WritingCtrl -> setCover() doc success",res),$scope.story.covers=[doc],$scope.unlock(),$scope.isSaving=!1})},$scope.removeCover=function(doc){return $log.debug("WritingCtrl -> removeCover() doc:",doc.id),$scope.isSaving?void $log.warn("wait, try again in. Is still saving."):($scope.isSaving=!0,$scope.lock(),void StoryFactory.patch({id:story.id},{covers:$scope.biography?[$scope.biography.id]:[]}).$promise.then(function(res){$log.debug("WritingCtrl -> removeCover() doc success",res),$scope.story.covers=[],$scope.unlock(),$scope.isSaving=!1},function(err){$log.error("WritingCtrl -> removeCover() doc error",err),$scope.unlock(),$scope.isSaving=!1}))},$scope.references=[],$scope.lookups=[],$scope.attachTag=function(tag){return $log.debug("WritingCtrl -> attachTag() tag",arguments),$scope.isSaving?void $log.warn("wait, try again in. Is still saving."):tag.id?($scope.isSaving=!0,$scope.lock(),$scope.story.data._ordering.tags[tag.category]||($scope.story.data._ordering.tags[tag.category]=[]),$scope.story.data._ordering.tags[tag.category].push(tag.id),StoryFactory.patch({id:story.id},{tags:_($scope.tagFields).map("tags").flatten().map("id").concat([tag.id]).uniq().value(),data:$scope.story.data}).$promise.then(function(res){return $log.debug("WritingCtrl -> attachTag() tag success",res),$scope.unlock(),$scope.isSaving=!1,!0},function(){return $scope.unlock(),$scope.isSaving=!1,!1})):void $log.error("wait, there is no tag.id...",tag)},$scope.setToC=function(){},$scope.beforeAttachTag=function(tag,el){return $log.log("WritingCtrl -> beforeAttachTag() tag",tag),"__new__"==tag.type?($scope.openAddTagModal(tag.query),!1):$scope.attachTag(tag)},$scope.detachTag=function(tag){return $log.debug("WritingCtrl -> detachTag() tag",arguments,$scope.displayedTags),$scope.isSaving=!0,$scope.lock(),$scope.story.data._ordering.tags[tag.category]=_($scope.tagFields).map("tags").flatten().filter({category:tag.category}).map("id").value(),StoryFactory.patch({id:story.id},{tags:_($scope.tagFields).map("tags").flatten().map("id").uniq().value(),data:$scope.story.data}).$promise.then(function(res){return $log.debug("WritingCtrl -> detachTag() tag success",res),$scope.unlock(),$scope.isSaving=!1,!0},function(){return!1})};var addTagModal=$modal({scope:$scope,controller:function($scope,TagFactory){$log.log("addTagModalCtrl is ready. Initial value:",$scope.keywordToAttach),$scope.name=$scope.keywordToAttach||"",$scope.data={provider:"",creator:$scope.user.username,name:{}},$scope.conflicts={},$scope.update=function(){TagFactory.update({id:$scope.tag.id},{name:$scope.name,category:"keyword",data:$scope.data},function(tag){$log.debug("addTagModalCtrl -> update() tag updated."),$scope.$parent.attachTag(tag),$scope.$hide()})},$scope.confirm=function(){$log.debug("addTagModalCtrl -> confirm() saving tag..."),TagFactory.save({name:$scope.name,category:"keyword",data:$scope.data},function(tag){if(tag.created)$log.debug("addTagModalCtrl -> confirm() tag created!"),$scope.attachTag(tag),$scope.$hide();else{$log.debug("addTagModalCtrl -> confirm() tag exists. Update before use."),$scope.tag=tag;for(var i in $scope.settings.languages)_key=$scope.settings.languages[i],$scope.data.name[_key]&&$scope.data.name[_key]!=$scope.tag.data.name[_key]&&($scope.conflicts[_key]=$scope.tag.data.name[_key]),$scope.data.name[_key]=$scope.data.name[_key]||$scope.tag.data.name[_key]}},function(){})}},template:RUNTIME["static"]+"templates/partials/modals/add-tag.html",id:"writing.addtag",show:!1});$scope.openAddTagModal=function(value){$scope.keywordToAttach=value,addTagModal.$promise.then(function(){$log.log("WritingCtrl -> openAddTagModal()"),addTagModal.show()})};var saveDoiModal=$modal({template:RUNTIME["static"]+"templates/partials/modals/save-doi.html",id:"writing.savedoi",controller:"SaveDoiModalCtrl",scope:$scope,resolve:{storyId:function(){return story.id}},show:!1});$scope.openSaveDoiModal=function(value){saveDoiModal.$promise.then(function(){$log.log("WritingCtrl -> openSaveDoiModal()"),saveDoiModal.show()})},$scope.localUpdateDoi=function(doi){$scope.story.data.doi=doi};var saveVersionModal=$modal({template:RUNTIME["static"]+"templates/partials/modals/save-version.html",id:"writing.saveversion",controller:function($scope,$log,StoryGitFactory){$scope.version={tag:"",message:""},$scope.is_saving=!1,$scope.confirm=function(){$scope.is_saving=!0,StoryGitFactory.saveVersion({id:story.id},{tag:$scope.version.tag.trim(),message:$scope.version.message.trim()},function(res){$log.debug(res),$scope.is_saving=!1,$scope.$hide()},function(err){$log.error(err),err.data&&($scope.errors=err.data),$scope.is_saving=!1})}},show:!1});$scope.openSaveVersionModal=function(value){$scope.save(function(){saveVersionModal.$promise.then(function(){$log.log("WritingCtrl -> openSaveVersionModal()"),saveVersionModal.show()})})},$scope.suggestAuthors=function(query,options){$log.log("WritingCtrl -> suggestAuthors",query,options);var filters=angular.extend(options||{},{fullname__icontains:query});return console.log(filters),$log.log("FILTERS:",filters),AuthorFactory.get({filters:JSON.stringify(filters),exclude:JSON.stringify({id__in:_.map($scope.story.authors,"id")})}).$promise.then(function(response){return response.results})},$scope.suggestReferences=function(service){service||DocumentFactory.get(function(){console.log("list")})};var coversModal=$modal({controller:"CoversModalCtrl",templateUrl:RUNTIME["static"]+"templates/partials/modals/covers.html",show:!1,scope:$scope});$scope.openCoversModal=function(){coversModal.$promise.then(function(){$log.log("WritingCtrl -> openCoversModal()"),coversModal.show()})},$scope.save=function(next){if($log.debug("WritingCtrl @SAVE"),$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.lock(),$scope.isSaving)return void $log.warn("wait, try again in. Is still saving.");$scope.isSaving=!0,$scope.story.data._ordering.authors=_.map($scope.story.authors,"id");var update=angular.extend({title:$scope.title,"abstract":$scope["abstract"],contents:$scope.contents,data:$scope.story.data,date:$scope.date,authors:_.map($scope.story.authors,"id")},$scope.metadata);StoryFactory.update({id:story.id},update,function(res){$scope.story.version=res.version,$scope.story.logs=res.logs,$log.debug("WritingCtrl @SAVE: success"),$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock(),$scope.isSaving=!1,$scope.toggleStopStateChangeStart(!1),"function"==typeof next&&next()},function(){$scope.isSaving=!1})},$scope.versions=[],$scope.isLoadingVersions=!1,$scope.loadVersions=function(){$scope.isLoadingVersions=!0,StoryGitFactory.getByGitTag({id:story.id},function(res){console.log(res),$scope.isLoadingVersions=!1,$scope.versions=res.results},function(err){console.error(err),$scope.isLoadingVersions=!1})},$scope.toolboxing=function(action){$log.debug("WritingCtrl °°toolboxing:",action),$scope.$broadcast("mde.toolbox",{action:action})},$scope.activeStates=[],$scope.$on("mde.activestates",function(e,activestates){$scope.activeStates=activestates}),$scope.$on(EVENTS.SAVE,$scope.save),$rootScope.$on(EVENTS.SOCKET_USER_COMMENTED_STORY,function(e,data){data.target.id==story.id&&($log.log("StoryCtrl @SOCKET_USER_COMMENTED_STORY, update the comment list!"),data.info.comment.highlights&&$scope.story.highlights.push(data.info.comment.highlights),data.info.comment.unread=!0,$scope.$apply())}),$scope.$on(EVENTS.PARAMS_CHANGED,function(e,qs){qs.collection&&qs.collection.match(/^[a-zA-Z\-\_\d]+$/)&&($scope.collection=qs.collection)}),$scope.$watch("contents",function(v,p){v&&v!=p&&$scope.toggleStopStateChangeStart(!0)}),$scope.$watch("language",function(v,p){v&&v!=p&&(["title","abstract"].forEach(function(d){$scope[d]=$scope.story.metadata[d][v]||$scope[d]}),$log.log("WritingCtrl @language"))}),$scope.$watch("title",function(v){$scope.language&&($scope.story.data.title[$scope.language]=v)}),$scope.$watch("abstract",function(v){$scope.language&&($scope.story.data["abstract"][$scope.language]=v)})}),angular.module("miller").controller("AddReviewModalCtrl",function($scope,$log,$q,story,ReviewFactory){$log.info("AddReviewModalCtrl ready with crazy scope",arguments),$scope.reviewers=[],$scope.confirm=function(){return $scope.reviewers.length?($log.info("AddReviewModalCtrl -> confirm()"),void $q.all(_($scope.reviewers).map(function(assignee){var p=ReviewFactory.save({},{assignee:assignee.id,story:story.id,category:"double",contents:""});return p.$promise}).value()).then(function(results){story.reviews=story.reviews.concat(results.map(function(a,i){return a.assignee=$scope.reviewers[i],a})),$scope.$hide()},function(){})):void $log.warn("AddReviewModalCtrl -> confirm() without any reviewers?")},$scope.dismiss=function(){}}),angular.module("miller").controller("CoversModalCtrl",function($scope,$log,QueryParamsService,DocumentFactory){$log.info("CoversModalCtrl ready with crazy scope, n. covers:",$scope.story.covers.length),$scope.tabs={favourite:{name:"favourite",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,isNextPage){var $s=this;$log.debug("CoversModalCtrl - tab.favourite > suggest",$s),$s.isLoadingNextItems=!0,isNextPage||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{caption__story__owner__username:$scope.user.username,contents__icontains:query}:{caption__story__owner__username:$scope.user.username})},function(res){$log.debug("CoversModalCtrl - tab.favourite > suggest loaded n.docs:",res.results.length,"- total:",res.count,"-filters:",QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.debug("CoversModalCtrl - tab.favourite > init"),this.suggest($scope.query||"")}},all:{name:"all",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,isNextPage){var $s=this;$log.debug("CoversModalCtrl - tab.all > suggest",$s),$s.isLoadingNextItems=!0,isNextPage||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.debug("CoversModalCtrl - tab.all > suggest loaded n.docs:",res.results.length,"- total:",res.count,"-filters:",QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.debug("CoversModalCtrl - tab.all > init"),this.suggest($scope.query||"")}}},$scope.selectDocument=function(doc){$log.debug("CoversModalCtrl -> selectDocument() id:",doc.id),$scope.selectedDocument&&$scope.selectedDocument.id==doc.id?($scope.isSomethingSelected=!1,$scope.selectedDocument=!1):($scope.isSomethingSelected=!0,$scope.selectedDocument=angular.copy(doc))},$scope.addDocument=function(){return $scope.selectedDocument?($log.debug("CoversModalCtrl -> addDocument() id:",$scope.selectedDocument.id),$scope.setCover($scope.selectedDocument),void $scope.$hide()):void $log.warn("CoversModalCtrl -> addDocument() no document has been selected")},$scope.setTab=function(tabname){$log.debug("CoversModalCtrl -> setTab() tab.name:",tabname),$scope.tab=$scope.tabs[tabname],$scope.tab.init()},$scope.suggest=function(query){$log.debug("CoversModalCtrl -> suggest() q:",query),$scope.tab.suggest(query)},$scope.more=function(query,tab){$log.debug("CoversModalCtrl -> more()"),$scope.tab.suggest(query,!0)},$scope.setTab("favourite")}),angular.module("miller").controller("EnrichModalCtrl",function($timeout,$scope,$log,QueryParamsService,DocumentFactory,StoryFactory,OembedSearchFactory,CrossRefFactory,localStorageService,Upload){$log.info("EnrichModalCtrl ready with crazy scope, language:",$scope.language),$scope.tabs={favourite:{name:"favourite",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggestions:[],suggest:function(query,keep){var $s=this,q=query&&query.length>2?query.replace("*","").trim()+"*":"";$log.log("tab.favourite > suggest",$s),$s.isLoadingNextItems=!0,keep||($s.next=void 0),DocumentFactory.get($s.next||{q:q,facets:"data__type"},function(res){$log.log("tab.favourite > suggest loaded n.docs:",res.results.length,QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1,$s.typeahead(query)})},suggestquery:function(q){var $s=this;$scope.query=q,$s.suggest(q)},typeahead:function(query){var $s=this;return!query||query.length<3?void($s.suggestions=[]):void DocumentFactory.suggest({q:query},function(res){$s.suggestions=res.results})},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.query||"")}},crossref:{name:"crossref",items:[],count:0,next:void 0,suggest:function(query,keep){var $s=this;$log.log("tab.crossref > suggest - query:",query,"- keep:",keep||!1,$s.next?"- next.page: "+$s.next.page:""),!query&&$s.next&&$s.next.query&&(query=$s.next.query||""),!query||query.length<3||$s.isLoadingNextItems||($s.isLoadingNextItems=!0,keep||($s.next={page:1,rows:4}),CrossRefFactory.search(query,$s.next.page,$s.next.rows).success(function(res){$s.items=$s.next.page>1?($s.items||[]).concat(res.items):res.items,$s.count=res.totalResults,$s.missing=res.totalResults-$s.items.length,$s.isLoadingNextItems=!1,$s.next.page=Math.min(Math.ceil(res.totalResults/res.itemsPerPage),Math.floor((res.startIndex+res.itemsPerPage)/res.itemsPerPage)+1),$s.next.rows=res.itemsPerPage,$s.next.query=query,console.log("next",$s.next)}).error(function(){$s.items=[],$s.isLoadingNextItems=!1,$s.items=[{id:"http://dx.doi.org/10.1007/bf02279529",doi:"http://dx.doi.org/10.1007/bf02279529",score:16.447716,normalizedScore:74,title:"Understanding (hyper) media: Required readings",fullCitation:"Allen Renear, 1995, 'Understanding (hyper) media: Required readings', <i>Computers and the Humanities</i>, vol. 29, no. 5, pp. 389-407",coins:"ctx_ver=Z39.88-2004&amp;rft_id=info%3Adoi%2Fhttp%3A%2F%2Fdx.doi.org%2F10.1007%2Fbf02279529&amp;rfr_id=info%3Asid%2Fcrossref.org%3Asearch&amp;rft.atitle=Understanding+%28hyper%29+media%3A+Required+readings&amp;rft.jtitle=Computers+and+the+Humanities&amp;rft.date=1995&amp;rft.volume=29&amp;rft.issue=5&amp;rft.spage=389&amp;rft.epage=407&amp;rft.aufirst=Allen&amp;rft.aulast=Renear&amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Ajournal&amp;rft.genre=article&amp;rft.au=Allen+Renear",year:"1995"},{id:"http://dx.doi.org/10.4242/balisagevol5.renear01",doi:"http://dx.doi.org/10.4242/balisagevol3.renear01",score:16.447716,normalizedScore:74,title:"Documents Cannot Be Edited",fullCitation:"Allen H. Renear, Karen M. Wickett, 'Documents Cannot Be Edited', <i>Proceedings of Balisage: The Markup Conference 2009</i>",coins:"ctx_ver=Z39.88-2004&amp;rft_id=info%3Adoi%2Fhttp%3A%2F%2Fdx.doi.org%2F10.4242%2Fbalisagevol3.renear01&amp;rfr_id=info%3Asid%2Fcrossref.org%3Asearch&amp;rft.atitle=Documents+Cannot+Be+Edited&amp;rft.jtitle=Proceedings+of+Balisage%3A+The+Markup+Conference+2009&amp;rft.aufirst=Allen+H.&amp;rft.aulast=Renear&amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Ajournal&amp;rft.genre=proceeding&amp;rft.au=Allen+H.+Renear&amp;rft.au=+Karen+M.+Wickett",year:null},{id:"http://dx.doi.org/10.4242/balisagevol5.renear02",doi:"http://dx.doi.org/10.4242/balisagevol5.renear02",score:16.447716,normalizedScore:74,title:"There are No Documents",fullCitation:"Allen H. Renear, Karen M. Wickett, 'There are No Documents', <i>Proceedings of Balisage: The Markup Conference 2010</i>",coins:"ctx_ver=Z39.88-2004&amp;rft_id=info%3Adoi%2Fhttp%3A%2F%2Fdx.doi.org%2F10.4242%2Fbalisagevol5.renear01&amp;rfr_id=info%3Asid%2Fcrossref.org%3Asearch&amp;rft.atitle=There+are+No+Documents&amp;rft.jtitle=Proceedings+of+Balisage%3A+The+Markup+Conference+2010&amp;rft.aufirst=Allen+H.&amp;rft.aulast=Renear&amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Ajournal&amp;rft.genre=proceeding&amp;rft.au=Allen+H.+Renear&amp;rft.au=+Karen+M.+Wickett",year:null},{id:"http://dx.doi.org/10.1142/9789812701527_0069",doi:"http://dx.doi.org/10.1142/9789812701527_0069",score:16.447716,normalizedScore:74,title:"SOME CONCEPTUAL MODELING ISSUES IN FRBR",fullCitation:"ALLEN RENEAR, YUNSEON CHOI, 2005, 'SOME CONCEPTUAL MODELING ISSUES IN FRBR', <i>Knowledge Management</i>",coins:"ctx_ver=Z39.88-2004&amp;rft_id=info%3Adoi%2Fhttp%3A%2F%2Fdx.doi.org%2F10.1142%2F9789812701527_0069&amp;rfr_id=info%3Asid%2Fcrossref.org%3Asearch&amp;rft.atitle=SOME+CONCEPTUAL+MODELING+ISSUES+IN+FRBR&amp;rft.jtitle=Knowledge+Management&amp;rft.date=2005&amp;rft.aufirst=ALLEN&amp;rft.aulast=RENEAR&amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Ajournal&amp;rft.genre=proceeding&amp;rft.au=ALLEN+RENEAR&amp;rft.au=+YUNSEON+CHOI",year:"2005"}],$s.count=6,$s.missing=2}))},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.query||"")}},glossary:{name:"glossary",items:[],count:0,next:void 0,suggest:function(query,keep){var $s=this;$log.log("tab.glossary > suggest",$s),$s.isLoadingNextItems=!0,keep||($s.next=void 0),StoryFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query,tags__category__in:["writing","blog"],status:"public"}:{tags__category__in:["writing","blog"],status:"public"})},function(res){$log.log("tab.glossary > suggest loaded n.docs:",res.results.length,QueryParamsService(res.next||"")),
$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.query||"")}},url:{name:"url",items:[],suggest:function(url,keep){},onEmbedChange:function(){$log.log("EMC @embed embed.type:",$scope.embed.type),$scope.embed.html&&"link"==$scope.embed.type&&($scope.embed.type="rich")},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.url||"")}},CVCE:{name:"CVCE",items:[],count:0,next:void 0,suggest:function(query,keep){var $s=this;return $log.log("tab.CVCE > suggest - query:",query),$s.isLoadingNextItems=!0,OembedSearchFactory.CVCE?void(!query||query.length<3||(keep||($s.next=void 0),OembedSearchFactory.CVCE($s.next||{q:query}).then(function(res){$log.log("tab.CVCE > suggest loaded n.docs:",res.data.count),$s.items=$s.next?($s.items||[]).concat(res.data.results):res.data.results,$s.count=res.data.count,$s.missing=res.data.count-$s.items.length,$s.next=QueryParamsService(res.data.next||""),$s.query=query,$s.isLoadingNextItems=!1},function(){}))):void $log.error("OembedSearchFactory.CVCE does not exist")},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.query||"")}},upload:{name:"upload",items:[],undo:function(){$scope.uploadable=null,$scope.uploadablefile={}},upload:function(){if(!$scope.uploadablefile)return void $log.warn("no file is selected");var types={"image/jpg":"image","image/png":"image","application/pdf":"pdf"};Upload.upload({url:"/api/document/",data:{title:$scope.uploadablefile.title||$scope.uploadablefile.name,type:types[$scope.uploadablefile.type]||$scope.uploadablefile.type.split("/").shift(),mimetype:$scope.uploadablefile.type,metadata:JSON.stringify({bibtex:$scope.reference,copyright:$scope.uploadablefile.copyright}),attachment:$scope.uploadablefile.f}}).then(function(res){$log.debug("UploadCtrl -> upload() status:",res.status),201==res.status?($log.debug("UploadCtrl -> upload() status:","success!",res.data),$scope.uploadablefile.progressPercentage=0,$scope.uploadablefile.document=res.data,$scope.selectDocument($scope.uploadablefile.document)):$log.error(res)},null,function(evt){$scope.uploadablefile.progressPercentage=parseInt(1e4*evt.loaded/evt.total)/100,$log.log("progress: "+$scope.uploadablefile.progressPercentage+"% "+evt.config.data,$scope.uploadablefile.name,evt)})},init:function(){$log.log("init",this),$scope.uploadable=null,$scope.uploadablefile={},localStorageService.set("lasttabname",this.name)}}},$scope.uploadablefile={},$scope.$watch("uploadable",function(v){v&&($log.debug("::mde @uploadable",v),$scope.uploadablefile.f=v,$scope.uploadablefile.name=v.name,$scope.uploadablefile.size=v.size,$scope.uploadablefile.type=v.type)});var timer_preview;$scope.previewUrl=function(url){timer_preview&&$timeout.cancel(timer_preview);var regexp=/^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;return regexp.test(url)?($scope.isUrlValid=!0,url=url.replace("#",".hash."),void(timer_preview=$timeout(function(){$log.debug("::mde -> previewUrl() url:",url),$scope.suggestMessage="(loading...)",DocumentFactory.oembed({url:url},function(data){$log.debug(":: mde -> previewUrl() received:",data),$scope.embed=data,$scope.suggestMessage="(<b>done</b>)"},function(err){$scope.suggestMessage="(<b>error</b>)"})},20))):($log.error("::mde -> previewUrl() url provided:",url,"is not valid"),$scope.suggestMessage="(url is not valid)",$scope.isUrlValid=!1,$scope.embed=null,!1)},$scope.setTab=function(tabname){$log.log("EnrichModalCtrl -> setTab() tab.name:",tabname),$scope.tab=$scope.tabs[tabname],$scope.tab.init()},$scope.suggest=function(query){$log.log("EnrichModalCtrl -> suggest() q:",query),$scope.tab.suggest(query)},$scope.upload=function(query){$log.log("EnrichModalCtrl -> upload()"),$scope.tab.upload()},$scope.undo=function(){$log.log("EnrichModalCtrl -> undo()"),$scope.tab.undo()},$scope.more=function(query,tab){$log.log("EnrichModalCtrl -> more()"),$scope.tab.suggest(query,!0)},$scope.setTab(localStorageService.get("lasttabname")||"favourite")}),angular.module("miller").controller("FinalDecisionModalCtrl",function($scope,$log,$q,story,ReviewFactory){$log.info("FinalDecisionModalCtrl ready with crazy scope",arguments),$scope.reviewers=[],$scope.review={status:!1,contents:""},$scope.availableStatus=["approved","bounce","refusal"],$scope.confirm=function(){return $scope.review.status?($scope.isSaving&&$log.warn("FinalDecisionModalCtrl -> confirm() please wait, is still saving data..."),$scope.isSaving=!0,$log.info("FinalDecisionModalCtrl -> confirm()",$scope.review.status),void ReviewFactory.close({story:story.id,contents:$scope.review.contents,status:$scope.review.status},function(){$scope.isSaving=!1,story.status="reviewdone",$scope.$hide()},function(){$scope.isSaving=!1})):void $log.warn("FinalDecisionModalCtrl -> confirm() without any finalStatus?")},$scope.dismiss=function(){}}),angular.module("miller").controller("SaveDoiModalCtrl",function($log,$scope,storyId,StoryDOIMetadataFactory,EVENTS){$scope.storyId=storyId,$scope.loadCurrentMetadata=function(options){return StoryDOIMetadataFactory.getMetadata(angular.extend({},options,{id:storyId}),function(res){$log.log("[GET] SaveDoiModalCtrl -> loadCurrentMetadata() success, doi:",res.DOI,"- with params:",options),$scope.currentMetadata=res,$scope.doi=res.DOI},function(res){$log.warn("[GET] SaveDoiModalCtrl -> loadCurrentMetadata() error, request status:",res.status,"with params:",res)}).$promise},StoryDOIMetadataFactory.get({id:storyId},function(res){$log.log("[GET] SaveDoiModalCtrl -> init remote doi SUCCESS :",{doi:res.doi,url:res.url}),$scope.should_update_doi=!0,$scope.loadCurrentMetadata({test:!0})},function(res){$log.warn("[GET] SaveDoiModalCtrl -> init remote doi FAILED:",res)}).$promise["finally"](function(){$scope.loadCurrentMetadata({test:!0})}),$scope.confirm=function(){$scope.is_saving=!0,StoryDOIMetadataFactory.updateMetadata({id:storyId},{},function(res){$log.log("[POST] SaveDoiModalCtrl updateMetadata() success, doi:",res.DOI),$scope.should_update_doi?($scope.localUpdateDoi($scope.doi),$scope.$hide(),$scope.$emit(EVENTS.MESSAGE,"DOI updated!")):StoryDOIMetadataFactory.save({id:storyId},{},function(res){$log.log("[POST] SaveDoiModalCtrl DOI save() success, doi:",res.DOI,"url:"),$scope.is_saving=!1,$scope.localUpdateDoi($scope.doi),$scope.$hide(),$scope.$emit(EVENTS.MESSAGE,"DOI created!")},function(err){$scope.is_saving=!1})},function(err){$scope.is_saving=!1,$scope.log_message=err.data,$log.warn("SaveDoiModalCtrl loadCurrentMetadata() error, request status:",err.status,"with params:",err)})}}),angular.module("miller").directive("biography",function($log,$rootScope,$window,$timeout,RUNTIME,EVENTS){var FRAME_MARGIN_TOP=15,FRAME_MARGIN=35,LIFESPAN_HEIGHT=90,ACTIVITY_HEIGHT=25,utils={};return utils.calculateBoundaries=function(from,to,offset,ratio){return console.log("♾ biography from:",from,"to:",yearTo,"w:",yearTo-from,"l:",from-biography.mindate),{width:lifespan.ratio*(yearTo-from),left:lifespan.ratio*(from-biography.mindate)}},{restrict:"A",scope:{data:"="},templateUrl:RUNTIME["static"]+"templates/partials/directives/biography.html",link:function(scope,element,attrs){var isReady=!1,biography={element:element.find(".biography"),tooltip:element.find(".biography-tooltip"),height:0,width:0,years:{min:0,max:0,delta:0},ratio:0},lifespan={years:{min:1/0,max:-(1/0),delta:0}};leftdate={},rightdate={},scope.tooltip={idx:-1},scope.init=function(){if(!scope.data.activities||!scope.data.activities.length)return void $log.warning("♾ biography init(), no activities data available! Skipping");scope.data.activities=scope.data.activities.sort(function(a,b){return a.start_date>b.start_date?1:a.start_date==b.start_date&&a.end_date>b.end_date?1:-1}),biography.height=Math.max(300,FRAME_MARGIN_TOP+LIFESPAN_HEIGHT+25*scope.data.activities.length),biography.element.height(biography.height),biography.years.max=("string"==typeof scope.data.end_date?new Date(scope.data.end_date):new Date).getFullYear(),biography.years.min=new Date(scope.data.start_date).getFullYear(),biography.years.delta=biography.years.max-biography.years.min;for(var i=0,l=scope.data.activities.length;i<l;i++)scope.data.activities[i].start_date&&(lifespan.years.min=Math.min(scope.data.activities[i].start_date,lifespan.years.min)),scope.data.activities[i].end_date?lifespan.years.max=Math.max(scope.data.activities[i].end_date,lifespan.years.max):scope.data.activities[i].start_date&&(lifespan.years.max=Math.max(scope.data.activities[i].start_date,lifespan.years.max));return lifespan.years.min&&lifespan.years.max?(lifespan.years.delta=lifespan.years.max-lifespan.years.min,$log.log("♾ biography -> init(), biography:",biography,"- lifespan:",lifespan),isReady=!0,void scope.render()):void $log.warning("♾ biography -> init(), error in boundaries")},scope.render=function(){if(isReady){var availableWidth=parseInt(biography.element.width());biography.width!=availableWidth&&(biography.width=availableWidth,biography.ratio=(biography.width-2*FRAME_MARGIN)/biography.years.delta,lifespan.width=biography.ratio*lifespan.years.delta,lifespan.left=biography.ratio*(lifespan.years.min-biography.years.min),lifespan.right=biography.ratio*(biography.years.max-lifespan.years.max),lifespan.ratio=(biography.width-2*FRAME_MARGIN-20)/lifespan.years.delta,$log.log("♾ biography -> render() \n  biography:\n  - width:",biography.width,"\n  - ratio:",biography.ratio,"\n  - delta:",biography.years.delta,"\n\n  lifespan:\n  - width:",lifespan.width,"\n  - ratio:",lifespan.ratio,"\n  - delta:",lifespan.years.delta),scope.data.activities=scope.data.activities.map(function(activity){activity.height=ACTIVITY_HEIGHT,activity.left=lifespan.ratio*(activity.start_date-lifespan.years.min),activity.right=lifespan.ratio*(lifespan.years.max-activity.end_date),activity.end_date||(activity.end_date=activity.start_date,activity.end_date_fuzzy=!0),activity.start_date||(activity.end_date=activity.end_date,activity.start_date_fuzzy=!0),activity.uniqdate=activity.start_date==activity.end_date,activity.nodate=!activity.start_date&&!activity.end_date,$log.log("♾ biography -> render()",activity.start_date,activity.end_date);var _left=activity.left+lifespan.ratio*(activity.end_date-activity.start_date)+10,_right=biography.width-2*FRAME_MARGIN-20-lifespan.ratio*(activity.start_date-lifespan.years.min)+40;return activity.uniqdate||(_left+=29),activity.description.alignment=_left>_right?"left":"right",activity.description.left=_left,activity.description.right=_right,activity}),scope.lifespan=lifespan,scope.biography=biography,$rootScope.$emit(EVENTS.RESIZE))}},scope.showTooltip=function(activity,idx,event,lock){scope.tooltip=activity,scope.tooltip.idx=idx;var left=activity.left,bottom=(scope.data.activities.length-idx)*ACTIVITY_HEIGHT+10;scope.tooltip.left=left,scope.tooltip.bottom=bottom,lock&&(scope.tooltip.locked=!0)},scope.hideTooltip=function(force){scope.tooltip.locked&&!force||scope.tooltip&&(scope.tooltip.idx=-1)},scope.cleanUp=function(){angular.element($window).off("resize",scope.render)},scope.init(),angular.element($window).on("resize",scope.render),scope.$on("$destroy",scope.cleanUp)}}}),angular.module("miller").directive("commenter",function($log,$rootScope,angularLoad,CommentFactory,EVENTS,RUNTIME){return{restrict:"AE",templateUrl:RUNTIME["static"]+"templates/partials/directives/commenter.html",scope:{target:"=",actor:"=",highlight:"=",commented:"&",discarded:"&",commentsSelected:"="},link:function(scope,element,attrs){scope.cachedCommentsUid=[],scope.cachedComments=[],scope.attachedComments=[],scope.disableClose=attrs.disableClose,scope.disableViewer=attrs.disableViewer,scope.leaveComment=function(comment){if($log.log(":: commenter > leaveComment() called"),scope.isLoading)return void $scope.warn(":: commenter is already doing something");scope.isLoading=!0;var highlights=scope.highlight?scope.highlight.s:"";if(!scope.highlight&&scope.attachedComments.length&&scope.commentSelectedHighlights){var highlightsParts=scope.commentSelectedHighlights.split("$");highlightsParts[3]="highlight",highlights=highlightsParts.join("$")}CommentFactory.save({contents:JSON.stringify({content:scope.content,quote:scope.quote||""}),highlights:highlights,version:scope.target.version,story:scope.target.id},function(res){scope.content="",scope.isLoading=!1,$log.log(":: commenter > leaveComment() success",res),scope.commented({error:null,comment:res})},function(err){err.data&&(scope.errors=err.data),scope.isLoading=!1,$log.error(":: commenter > leaveComment() failed",err),scope.commented({error:err,comment:null})})},scope.discard=function(event){$log.log(":: commenter > discard()"),scope.discarded(),event.stopImmediatePropagation()},scope.$watch("highlight",function(highlight){$log.log(":: commenter @highlight:",highlight),highlight&&highlight.h?scope.quote=highlight.h.getText():scope.quote=null,scope.content=""}),attrs.disableViewer||scope.$watchCollection("commentsSelected",function(uids){uids&&uids.length?CommentFactory.get({filters:JSON.stringify({short_url__in:uids}),limit:Math.max(uids.length,20),orderby:"-date"},function(res){scope.attachedTotalComments=res.count,scope.attachedComments=res.results;var com=_(scope.attachedComments,"contents.quote").map().first();com&&(scope.quote=com.contents.quote,scope.commentSelectedHighlights=com.highlights)}):(scope.attachedTotalComments=0,scope.attachedComments=[])}),$log.log(":: commenter ready")}}}).directive("commenterQuote",function(){return{restrict:"A",scope:{quote:"=commenterQuote"},link:function(scope,element,attrs){scope.$watch("quote",function(text){if(text){var words=text.trim().split(/\s+/),max_words=attrs.maxWords||3;element.html(words.length>2*max_words?_.take(words,max_words).concat(["[...]"],_.takeRight(words,max_words)).join(" "):text)}})}}}),angular.module("miller").directive("rewording",function($rootScope,EVENTS){return{restrict:"A",scope:{value:"=",follow:"=",highlight:"&?"},template:'<span ng-bind-html="renderedValue"></span>',link:function(scope,element,attrs){scope.render=function(event,language){if(language){var _renderedValue=attrs["default"];if("object"==typeof scope.value&&(_renderedValue=_.get(scope.value,language),_renderedValue||(_renderedValue=_(scope.value).filter().first())),attrs.markdown){var md=new window.markdownit({breaks:!0,linkify:!0,html:!1}).disable(["image","heading"]);_renderedValue=_renderedValue||"",_renderedValue="inline"==attrs.markdown?md.renderInline(_renderedValue):md.render(_renderedValue)}scope.highlight?scope.renderedValue=scope.highlight({text:_renderedValue}):scope.renderedValue=_renderedValue||attrs["default"]}},scope.$on(EVENTS.LANGUAGE_CHANGED,scope.render),attrs.follow?scope.$watch("follow",function(v){"true"===attrs.debug&&console.log("::: embedit @follow - value:",v),v&&scope.render(null,$rootScope.language)}):scope.render(null,$rootScope.language)}}}).directive("embedit",function($sce,$timeout,$filter){return{restrict:"A",scope:{embedit:"=",stretch:"=",language:"=",firstline:"="},link:function(scope,element,attrs){var stretching,options={breaks:!0,linkify:!0,html:!0},disable=["image","heading"],stretching_timeout=1e4,stretching_time=0;scope.do_strech=function(){var els=element.find("iframe").width("100%").height("100%").attr("height","100%");stretching&&$timeout.cancel(stretching),els.length?(element.css("opacity",1),console.log("embedit :: iframe Stretched.")):stretching_time>stretching_timeout?console.warn("embedit :: skipping stretching iframe, time exceeded."):(console.log("embedit :: iframe not found, but stretch is set to true. Calling do_stretch again in a few ms..."),stretching=$timeout(scope.do_strech,300),stretching_time+=300)},scope.render=function(language){if(scope.embedit){if(language&&"object"==typeof scope.embedit)var altlanguage=_.filter(scope.embedit,_.identity).pop(),contents=scope.embedit[language]||scope.embedit.en_US||altlanguage||"";else contents=scope.embedit;if(attrs.excerpt&&(contents=$filter("tokenize")(contents,parseInt(attrs.excerpt)||32)),attrs.markdown){var md=new window.markdownit(options).disable(disable);contents="inline"==attrs.markdown?md.renderInline(contents):md.render(contents)}else contents=contents.split(/[\n\r]+/).join("<br/>");if(scope.firstline&&(contents=contents.split(/<br\s?\/?>/).shift()),element.html(contents),scope.stretch&&scope.do_strech(),attrs.autoplay){var src=element.find("iframe").attr("src");element.find("iframe").attr("src",src+(src.indexOf("?")==-1?"?":"&")+"autoplay=1"),console.log("embedit :: Activating autoplay on iframe...",src)}}},scope.stretch,scope.language&&"object"==typeof scope.embedit?scope.$watch("language",scope.render):scope.$watch("embedit",scope.render)}}}),angular.module("miller").directive("footnote",function($compile,$rootScope,RUNTIME){return{restrict:"A",scope:{caption:"=",footnote:"="},templateUrl:RUNTIME["static"]+"templates/partials/directives/footnote.html",link:function(scope,element,attrs){var footnoteSl="#fn"+scope.footnote+" p",contents=$(footnoteSl).clone(),wrapper=element.find(".footnote-contents");wrapper.html(contents),$compile(wrapper.contents())(scope),scope.isOpened=!!attrs.isOpened,scope.toggleFootnote=function(){console.log("::footnote > toggleFootnote")},scope.fullsize=function(slug,type){scope.$parent.fullsize?scope.$parent.fullsize(slug,type):$log.error(":: footnote > fullsize is without hanlders.")}}}}),angular.module("miller").constant("LAZY",{QUALITY_HIFI:"hifi",QUALITY_SNAPSHOT:"snapshot"}).directive("lazyCover",function($log,$timeout,LAZY,RUNTIME){return{restrict:"A",templateUrl:RUNTIME["static"]+"templates/partials/directives/lazy-cover.html",scope:{media:"="},link:function(scope,element,attrs){scope.render=function(quality){if("video"==scope.media.type||"rich"==scope.media.type?scope.quality=LAZY.QUALITY_SNAPSHOT:scope.quality=attrs.quality||LAZY.QUALITY_HIFI,attrs.immediate&&(scope.immediate=!0),_.values(LAZY).indexOf(scope.quality)==-1)return void $log.error("lazy-cover: quality attribute should be one of these:",_.keys(LAZY),"- received:",attrs.quality);if("object"!=typeof scope.media)return void $log.error("lazy-cover: media attribute should be an object, received:",scope.media);switch(scope.media.data&&(scope.offsetx=scope.media.data.thumbnail_offset_x||"center",scope.offsety=scope.media.data.thumbnail_offset_y||"center"),scope.quality){case LAZY.QUALITY_HIFI:scope.src=scope.media.data?scope.media.data.media_url||_.get(scope.media,"metadata.urls.Publishable")||scope.media.data.thumbnail_url||scope.media.data.preview||scope.media.data.url||scope.media.attachment||scope.media.snapshot:scope.media.attachment||scope.media.snapshot;break;case LAZY.QUALITY_SNAPSHOT:scope.src=scope.media.data?scope.media.data.thumbnail_url||scope.media.data.preview||_.get(scope.media,"metadata.urls.Preview")||scope.media.snapshot||scope.media.attachment||scope.media.data.url:scope.media.snapshot||scope.media.attachment}$log.log("lazy-cover ready - src:",scope.src,"quality:",scope.quality)},$timeout(scope.render,0)}}}).directive("lazyImage",function($log){return{restrict:"A",scope:{src:"="},link:function(scope,element,attrs){function wakeup(){element.css({"background-size":attrs.size||"cover","background-position":"center center","background-repeat":"no-repeat","background-image":"url("+scope.src+")"}),element.find(".loading").hide()}$log.log(":::lazy on ",scope.src),element.addClass("lazy-box").css({"background-color":"#B7B2B2"}).html('<div class="loading">...</div>'),scope.$watch("src",function(v){v&&wakeup()})}}}).directive("lazyPlaceholder",function($log,$rootScope,$compile,LAZY,RUNTIME){return{scope:{},templateUrl:RUNTIME["static"]+"templates/partials/directives/lazy-placeholder.html",link:function(scope,element,attrs){var slug=element.attr("lazy-placeholder"),type=element.attr("type");scope.$parent.footnote?scope.quality=LAZY.QUALITY_SNAPSHOT:attrs.quality?scope.quality=attrs.quality:scope.quality=LAZY.QUALITY_HIFI,scope.type=type,scope.user=$rootScope.user,scope.language=$rootScope.language,$log.log("⏣ lazy-placeholder on type:",type,"- slug:",slug,"lang"),scope.complete=function(res){res?(scope.resolved=res,$log.log("⏣ lazy-placeholder resolved for type:",type,"- slug:",slug),$compile(element.contents())(scope)):$log.error("⏣ lazy-placeholder cannot find slug:",slug)},$rootScope.resolve&&"string"==typeof slug&&$rootScope.resolve(slug,type,scope.complete),scope.fullsize=function(slug,type){$rootScope.fullsize(slug,type)}}}}).directive("respectSibling",function($log,$timeout,$rootScope,EVENTS){return{scope:{update:"="},restrict:"A",link:function(scope,element,attrs){function setHeight(){$log.log("🚀 respect-next-sibling > setHeight()"),$timeout.cancel(p),p=$timeout(function(){var h="next"==_sibling?element.next()[0].offsetHeight:element.prev()[0].offsetHeight;element.height(Math.max(h,attrs.minHeight||300))},500)}$log.log("🚀 respect-next-sibling ready");var p,_sibling="next"==attrs.respectSibling?"next":"previous";setHeight(),angular.element(window).bind("resize",setHeight),$rootScope.$on(EVENTS.RESIZE,function(){setHeight()})}}}).directive("respectPreviousSibling",function($log,$timeout){return{scope:{update:"="},restrict:"A",link:function(scope,element,attrs){function setHeight(){$log.log("🚀 respect-previous-sibling > setHeight()"),$timeout.cancel(p),p=$timeout(function(){element.height(Math.max(element.prev()[0].offsetHeight,attrs.minHeight||300))},500)}$log.log("🚀 respect-previous-sibling ready");var p;setHeight(),angular.element(window).bind("resize",setHeight)}}}),angular.module("miller").directive("marginalia",function($log,$window,$timeout,CommentFactory,RUNTIME){return{restrict:"AE",templateUrl:RUNTIME["static"]+"templates/partials/directives/marginalia.html",scope:{whenvisible:"&"},link:function(scope,element,attrs){var wh,t_delay=600,w=angular.element(window);scope.is_visible=!1;var evaluate=function(){var ot=element.offset().top,ws=w.scrollTop(),is_visible=wh+ws-200>ot;is_visible!=scope.is_visible&&(scope.is_visible=is_visible,is_visible&&scope.whenvisible()),$log.log("::marginalia -> evaluate() is_visible:",is_visible,"- wh:",wh,"- ws:",ws)},resize=function(){$log.log("::marginalia -> resize()"),wh=w.height()};$timeout(function(){resize(),evaluate(),w.scroll(_.debounce(evaluate,t_delay)),w.on("resize",_.debounce(resize,t_delay))},200),$log.log("::marginalia ready.")}}}),angular.module("miller").directive("markdownit",function($compile,$log,$location,markdownItService,EVENTS){return{restrict:"A",scope:{markdownit:"=",settoc:"&",setdocs:"&",language:"=",watchlanguage:"=",listener:"&"},link:function(scope,element,attrs){function parse(){if(!scope.markdownit||"object"!=typeof scope.markdownit&&!scope.markdownit.length)return void $log.warn(":: markdownit parse() without any markdown text! Check the value for `markdownit`");var results="object"==typeof scope.markdownit?scope.markdownit:markdownItService(scope.markdownit,scope.language);scope.resources=results.docs,element.html(results.html),$compile(element.contents())(scope),scope.settoc&&scope.settoc({ToC:results.ToC}),scope.setdocs&&scope.setdocs({items:results.docs}),scope.isReady=!0}var previousFocus;scope.isReady=!1,scope.hash=function(what){$location.hash(what)},scope.focus=function(idx){$log.log(":: markdownit > focus - idx:",idx),previousFocus&&previousFocus==idx&&scope.listener?(previousFocus=0,scope.listener({event:EVENTS.MARKDOWNIT_FOCUS,data:{idx:0}})):scope.listener&&(previousFocus=idx,scope.listener({event:EVENTS.MARKDOWNIT_FOCUS,data:{idx:idx}}))},scope.fullsize=function(slug,type){scope.listener&&scope.listener({event:EVENTS.MARKDOWNIT_FULLSIZE,data:{slug:slug.replace(/^[^\/]*\//,""),type:type}})},scope.resolve=function(slug,type,notify){scope.listener&&scope.listener({event:EVENTS.MARKDOWNIT_RESOLVE,data:{slug:slug,type:type},callback:notify})},!attrs.watchmarkdownit&&scope.watchlanguage&&scope.language?scope.$watch("language",function(language){language&&parse()}):attrs.watchmarkdownit?scope.$watch("markdownit",function(){parse()},!0):parse()}}}).directive("marked",function($compile,$log,$location,markedService){return{restrict:"A",scope:{marked:"=",settoc:"&",setdocs:"&",language:"="},link:function(scope,element,attrs){function init(){if(!scope.marked||!scope.marked.length)return void $log.warn(":: marked init(), no text to be marked");var rendered=markedService(scope.marked,scope.language);element.html(rendered.html),$compile(element.contents())(scope),scope.settoc&&scope.settoc({ToC:rendered.ToC}),scope.setdocs&&scope.setdocs({items:rendered.docs})}new marked.Renderer;scope.hash=function(what){$location.hash(what)},scope.miller=function(url){},scope.language?scope.$watch("language",function(language){language&&init()}):init()}}}),angular.module("miller").directive("codediff",function($log,angularLoad,RUNTIME){return{restrict:"A",scope:{raw:"=",diff:"="},template:"<div ng-class='{\"ready\": isReady}' id='versioned-contents'><textarea></textarea></div>",link:function(scope,el,attributes){scope.isReady=!1,$log.log("::codediff loading..."),angularLoad.loadScript(RUNTIME["static"]+"js/lib/simplemde.min.js").then(function(){$log.log("::codediff lib loading done.");var cm=CodeMirror.fromTextArea(el.find("textarea")[0],{lineNumbers:!1,readOnly:!0,lineWrapping:!0,mode:"markdown"});cm.setValue(scope.raw);var displayDiff=function(diff){if("object"!=typeof diff)return $log.log("::codediff -> displayDiff() no diff to display, codediff is ready."),void(scope.isReady=!0);$log.log("::codediff -> displayDiff()");var lovely=/\[\-(.+?)\-\]|\{\+(.+?)\+\}/g;for(var i in diff){$log.log("::codediff",i,diff[i]);for(var loffset=i.match(/\+(\d+)[,\d\s]+?@@$/)[1]-1,lines=diff[i].split(/\n/),j=0,jl=lines.length;j<jl;j++){var hasDiffs=lines[j].match(lovely),line=loffset+j-1,contents=lines[j].replace(lovely,function(m,del,add){return del||add}),charoffset=0;for(hasDiffs&&(cm.replaceRange(contents,{line:line,ch:0},{line:line,ch:line.length}),cm.addLineClass(line,"wrap","mod"));null!=(match=lovely.exec(lines[j]));){var left=("undefined"!=typeof match[1],match.index-charoffset),right=match.index-charoffset+match[0].length-4;cm.doc.markText({line:line,ch:left},{line:line,ch:right},{className:"undefined"==typeof match[1]?"add":"del"}),charoffset+=4}scope.isReady=!0}}};scope.$watch("diff",displayDiff),$log.log("::codediff ready.")})}}}).directive("mde",function($log,$timeout,$modal,$filter,DocumentFactory,StoryFactory,markdownItService,angularLoad,RUNTIME){return{restrict:"AE",scope:{mde:"=",settoc:"&",setdocs:"&",setmarked:"&",language:"=",diffs:"="},templateUrl:RUNTIME["static"]+"templates/partials/directives/mde.html",link:function(scope,el,attributes){$log.log("::mde lib loading..."),angularLoad.loadScript(RUNTIME["static"]+"js/lib/simplemde.min.js").then(function(){function init(){function moveCurrentBlock(pos){var blockIndex=0;if(blockIndex!=currentBlockIndex&&(currentBlock&&currentBlock.removeClass("active"),currentBlock=contents.children().eq(blockIndex),currentBlock.length)){currentBlock.addClass("active");currentBlock[0].offsetTop,simplemde.codemirror.charCoords({line:pos.line,ch:0},"local").top}}function move(){timer&&clearTimeout(timer),timer=setTimeout(function(){simplemde.codemirror.display.cursorDiv.firstChild&&(cursor={top:simplemde.codemirror.display.cursorDiv.firstChild.offsetTop,left:simplemde.codemirror.display.cursorDiv.firstChild.offsetLeft,height:simplemde.codemirror.display.cursorDiv.firstChild.offsetHeight},wand.css("transform","translateY("+(cursor.top+cursor.height)+"px)"),followCursor&&toolbox.css("transform","translate("+cursor.left+"px,"+cursor.top+"px)"),pos=simplemde.codemirror.getCursor("start"),stat=simplemde.codemirror.getTokenAt(pos),moveCurrentBlock(pos),scope.activeStates=(stat.type||"").split(" "),scope.$emit("mde.activestates",scope.activeStates),scope.$apply())},20)}function beforeSelectionChange(e,sel){var isSelection=sel.ranges[0].head.ch-sel.ranges[0].anchor.ch!==0;isSelection&&isSelection!=_isSelection?toolbox.addClass("active"):isSelection||isSelection==_isSelection||toolbox.removeClass("active"),_isSelection=isSelection}function recompile(){var marked=markdownItService(simplemde.value(),!1,!0),ToCHash=md5(JSON.stringify(marked.ToC)),docsHash=md5(_.map(marked.docs,"slug").join("--"));_ToCHash!=ToCHash&&($log.log("::mde -> recompile() items ToC:",marked.ToC.length,"docs:",marked.docs.length,ToCHash),scope.settoc({items:marked.ToC})),_docsHash!=docsHash&&($log.log("::mde -> recompile() items docs:",_docsHash),scope.setdocs({documents:marked.docs})),scope.setmarked({marked:marked}),_ToCHash=ToCHash,_docsHash=docsHash,move()}function onUpdate(e){var value=simplemde.value();textarea.val()!=value&&(scope.mde=value,textarea.val(value)),move(),timer_recompile&&clearTimeout(timer_recompile),timer_recompile=setTimeout(function(){recompile(),scope.$apply()},100)}function onChange(e,change){var from=change.from,text=change.text.join("\n"),to=(change.removed.join("\n"),simplemde.codemirror.posFromIndex(simplemde.codemirror.indexFromPos(from)+text.length));simplemde.codemirror.markText(from,to,{className:"mde-modified"})}function beforeChange(){}textarea.show(),wand.show(),toolbox.show(),simplemde=new SimpleMDE({element:textarea[0],spellChecker:!1,status:!1,toolbar:!1,toolbarTips:!1,initialValue:scope.mde});var cursor,pos,stat,followCursor,currentBlock,_isSelection,_ToCHash,_docsHash,currentBlockIndex=-1;simplemde.codemirror.on("update",onUpdate),simplemde.codemirror.on("cursorActivity",move),simplemde.codemirror.on("beforeSelectionChange",beforeSelectionChange),simplemde.codemirror.on("beforeChange",beforeChange),simplemde.codemirror.on("change",onChange),scope.settoc&&(timer_recompile=setTimeout(recompile,20))}$log.log("::mde lib loading done."),scope.activeStates=[],scope.isReady=!0,scope.isPreviewEnabled=!1,$log.log("::mde @link, language:",scope.language);var simplemde,timer,timer_recompile,timer_preview,wand=el.find(".wand").hide(),textarea=el.find("textarea").hide(),toolbox=el.find(".toolbox").hide(),contents=$("#contents"),referenceModal=$modal({scope:scope,title:"h",controller:"EnrichModalCtrl",template:RUNTIME["static"]+"templates/partials/modals/mde-enrich.html",show:!1});scope.setTab=function(tab){scope.tab=tab},scope.tab="CVCE",scope.previewUrl=function(url){timer_preview&&$timeout.cancel(timer_preview);var regexp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;return regexp.test(url)?(url=url.replace("#",".hash."),void(timer_preview=$timeout(function(){$log.debug("::mde -> previewUrl() url:",url),scope.suggestMessage="(loading...)"},20))):($log.error("::mde -> previewUrl() url provided:",url,"is not valid"),!1)};scope.suggestResults=[],scope.suggestMessage="",scope.suggest=function(query,service){if($log.log("::mde -> suggest()",scope.query,query),query.length<3)return scope.suggestMessage="(write something more)",void(scope.suggestResults=[]);if(scope.lookups=[],scope.count=0,scope.next=void 0,scope.suggestMessage="(loading...)","favourite"==service)return void DocumentFactory.get({filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.log("::mde -> showReferenceModal documents loaded",res.results.length),scope.lookups=res.results,scope.suggestMessage="(<b>"+res.count+"</b> results)"});if("glossary"==service){var params={tags__slug:"glossary"};return query.length>2&&(params.contents__icontains=query),void StoryFactory.get({filters:JSON.stringify(params)},function(res){$log.log("::mde -> showReferenceModal documents loaded",res.results.length),scope.glossary=res.results,scope.suggestMessage="(<b>"+res.count+"</b> results)"})}},scope.showReferenceModal=function(){return scope.activeStates.indexOf("link")!==-1?void $log.warn("oh dear, you should not click on it"):void referenceModal.$promise.then(function(){
$log.log("::mde -> showReferenceModal called"),referenceModal.show()})},scope.addDocument=function(type,contents,reference,url,embed){var slug;return $log.debug("::mde -> addDocument() type:",type),"bibtex"==type?void $log.debug("    reference:",bibtexParse.toJSON(reference)):"glossary"==type?(referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:"voc/"+scope.selectedDocument.slug})):("crossref"==type&&(embed=angular.extend({type:type},scope.selectedDocument||{}),url=embed.doi,$log.debug("::mde -> addDocument() embed:",embed)),"url"==type||"crossref"==type?embed.title?(slug=$filter("slugify")(embed.title).substr(0,100),reference&&(embed.bibtex=reference),void DocumentFactory.save({title:embed.title,data:embed,type:(embed.type||"link").toLowerCase(),url:url},function(res){$log.debug("::mde -> addDocument() document saved:",res.slug,res.id,res.short_url),res.slug&&(referenceModal.hide(),"crossref"==type?simplemde.codemirror.replaceSelection(simplemde.codemirror.getSelection()+"\n\n"+embed.fullCitation+" [doi](doc/"+res.slug+")\n\n"):SimpleMDE.drawLink(simplemde,{url:"doc/"+res.slug}))},function(err){err.data.slug&&"slug"==_.keys(err.data).join("")?"crossref"==type?simplemde.codemirror.replaceSelection(simplemde.codemirror.getSelection()+"\n\n"+embed.fullCitation+" [doi](doc/"+slug+")\n\n"):SimpleMDE.drawLink(simplemde,{url:"doc/"+slug}):$log.error("::mde -> addDocument() cannot save document",err)})):(referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:url})):scope.selectedDocument?"CVCE"==type?(slug="cvce-"+scope.selectedDocument.details.doi,$log.debug("::mde -> addDocument() doc:",slug),void DocumentFactory.save({title:scope.selectedDocument.title,data:scope.selectedDocument,type:(scope.selectedDocument.type||"link").toLowerCase(),slug:slug,url:url},function(res){$log.debug("::mde -> addDocument() document saved:",res.slug,res.id,res.short_url),res.slug&&(referenceModal.hide(),SimpleMDE.drawLink(simplemde,{url:"doc/"+res.slug}))},function(err){err.data.slug&&($log.debug("::mde -> addDocument() document already saved:",slug),SimpleMDE.drawLink(simplemde,{url:"doc/"+slug}))})):("bibtex"==scope.selectedDocument.type&&SimpleMDE.drawLink(simplemde,{url:"doc/"+scope.selectedDocument.slug}),$log.debug("::mde -> addDocument() doc:",scope.selectedDocument),referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:"doc/"+scope.selectedDocument.slug})):void $log.warn("::mde -> addDocument() no document selected"))},scope.selectDocument=function(doc){$log.log("::mde -> selectDocument()",doc.id),scope.selectedDocument&&scope.selectedDocument.id==doc.id?(scope.isSomethingSelected=!1,scope.selectedDocument=!1):(scope.isSomethingSelected=!0,scope.selectedDocument=angular.copy(doc))},scope.$on("mde.toolbox",function(event,data){scope.action(data.action)}),scope.action=function(action){"togglePreview"==action&&(scope.isPreviewEnabled=!scope.isPreviewEnabled),SimpleMDE[action](simplemde)},$timeout(init,50)})}}}),angular.module("miller").directive("rangy",function($log,$rootScope,angularLoad,RUNTIME,EVENTS){return{restrict:"AE",templateUrl:RUNTIME["static"]+"templates/partials/directives/rangy.html",scope:{actor:"=",target:"=",highlights:"=",forwardCommented:"&commented"},link:function(scope,element,attrs){if(!attrs.container)return void $log.error("💾 rangy directive needs a container scope babe.");var container=angular.element("#"+attrs.container);document.getElementById(attrs.container);scope.isEnabled=!1,scope.serializedHighlights={},scope.commentsSelected=[],scope.commented=function(err,comment){return err?void $log.log("💾 rangy > commented() received an error:",err):($log.log("💾 rangy > commented() success:",comment),void scope.forwardCommented({error:err,comment:comment}))},scope.discarded=function(){$log.log("💾 rangy > discarded()"),scope.highlight&&(scope.highlight=null),$rootScope.rangy.highlighters.highlight.removeAllHighlights(),scope.hide()},scope.show=function(event){var offset=container.offset(),left=window.innerWidth-510-offset.left;element.css({"z-index":10,position:"absolute",top:event.pageY-offset.top,left:left}),scope.isEnabled=!0,scope.$apply()},scope.hide=function(){scope.isEnabled=!1,previousSelectedHighlight&&previousSelectedHighlight.removeClass("active"),scope.$apply()};var previousSelectedHighlight;$log.log("💾 rangy lazy loading rangy lib ... on: #"+attrs.container),angularLoad.loadScript(RUNTIME["static"]+"js/scripts.rangy.min.js").then(function(){function createHighlighter(classname){if($rootScope.rangy.highlighters[classname])return $rootScope.rangy.highlighters[classname];var h=rangy.createHighlighter();return h.addClassApplier(rangy.createClassApplier(classname,{ignoreWhiteSpace:!0,tagNames:["span","a"],exclusive:!0})),$rootScope.rangy.highlighters[classname]=h,h}function toggleFocus(el){previousSelectedHighlight&&previousSelectedHighlight.removeClass("active"),previousSelectedHighlight=el,previousSelectedHighlight.addClass("active")}function onEscapeKey(e){27===e.keyCode&&onBodyClick()}function onBodyClick(){$log.log("💾 rangy @onBodyClick"),scope.highlight&&scope.discarded(),scope.hide(),scope.$apply()}function onQuoteClick(event){var focus=event.currentTarget.getAttribute("rangy-highlight"),el=angular.element("#"+attrs.container).find("."+focus),top=el.offset().top;$log.log("💾 rangy div[rangy-highlight]@click, focus:",focus,"- scrollTop:",top-window.innerHeight/3),$("body,html").stop(!0,!0).animate({scrollTop:top-window.innerHeight/3},"360","swing",function(){}),toggleFocus(el),scope.commentsSelected=_.uniq(el[0].className.split(" ").concat([focus])),scope.show({pageY:top}),scope.$apply()}function onHighlightClick(event){toggleFocus($(event.currentTarget)),rangy.getSelection().isCollapsed?($log.log("💾 rangy span[hl]@click, no selection, view comment:",event.currentTarget.className),event.stopImmediatePropagation(),scope.commentsSelected=event.currentTarget.className.split(" ")):$log.log("💾 rangy span[hl]@click with selection"),scope.show(event),scope.$apply()}$log.log("💾 rangy lib loading done; rangy.initialized:",rangy.initialized),rangy.initialized||rangy.init(),$rootScope.rangy||($rootScope.rangy={},serializeHighlight=function(highlight){var h=this,characterRange=highlight.characterRange;return"type:"+h.converter.type+"|"+[characterRange.start,characterRange.end,highlight.id,highlight.classApplier.className,highlight.containerElementId,JSON.stringify(highlight.attrs)].join("$")}),$rootScope.rangy.highlighters||($rootScope.rangy.highlighters={},$rootScope.rangy.highlighters.highlight=rangy.createHighlighter(document,"TextRange"),$rootScope.rangy.highlighters.highlight.addClassApplier(rangy.createClassApplier("highlight",{ignoreWhiteSpace:!0,tagNames:["span","a"]}))),scope.prepareSelectedText=function(event){if(rangy.getSelection().isCollapsed)return $log.log("💾 rangy > prepareSelectedText() nothing selected..."),scope.highlight&&scope.discarded(),void scope.hide();scope.highlight&&$rootScope.rangy.highlighters.highlight.removeAllHighlights(),scope.commentsSelected=[],scope.show(event);var h=$rootScope.rangy.highlighters.highlight.highlightSelection("highlight",{containerElementId:attrs.container});h[0].attrs={hl:""},scope.highlight={h:h[0],s:$rootScope.rangy.highlighters.highlight.serializeHighlight(h[0])},$log.log("💾 rangy > prepareSelectedText() serialized:",scope.highlight.s)},scope.renderHighlights=function(serializeds){serializeds.forEach(function(d){var h,id=d.split("$")[3];id.length&&!scope.serializedHighlights[id]&&($log.log("rangy create highlighter"),h=createHighlighter(id),h.deserialize(d),scope.serializedHighlights[id]=h.highlights[0].characterRange)}),$log.log("💾 rangy -> renderHighlights() serializedHighlights:",scope.serializedHighlights)},container.on("click","[hl]",onHighlightClick),container.on("click",scope.prepareSelectedText),$(document).on("click","div[rangy-highlight]",onQuoteClick),$(document).keyup(onEscapeKey),$rootScope.$on(EVENTS.SOCKET_USER_COMMENTED_STORY,function(event,data){if(data.target.id==scope.target.id&&data.info.comment.highlights&&(scope.commentsSelected.length||scope.highlight)){$log.log("💾 rangy @EVENTS.SOCKET_USER_COMMENTED_STORY");var commentRange=data.info.comment.highlights.match(/\|(\d+)\$(\d+)\$/),sample=scope.commentsSelected.length?scope.serializedHighlights[scope.commentsSelected[0]]:scope.highlight.h.characterRange;commentRange[1]>=sample.start&&commentRange[2]<=sample.end&&scope.commentsSelected.push(data.info.comment.short_url)}}),$rootScope.$on(EVENTS.RANGY_FOCUS,function(event,focus){var el=angular.element("#"+attrs.container).find("."+focus);if(el.length){var top=el.offset().top;$log.log("💾 rangy @EVENTS.RANGY_FOCUS focus:",focus,"- scrollTop:",top-window.innerHeight/3),$("body,html").stop(!0,!0).animate({scrollTop:top-window.innerHeight/3},"360","swing",function(){}),toggleFocus(el),scope.commentsSelected=_.uniq(el[0].className.split(" ").concat([focus])),scope.show({pageY:top})}}),$rootScope.$on(EVENTS.SOCKET_USER_UNCOMMENTED_STORY,function(event,data){}),$rootScope.$on(EVENTS.RANGY_REFRESH,function(event){$log.log("💾 rangy @RANGY_REFRESH"),scope.highlights&&scope.highlights.length&&scope.renderHighlights(scope.highlights)}),scope.$watchCollection("highlights",function(highlights){highlights&&highlights.length?scope.renderHighlights(highlights):$log.log("💾 rangy @highlights no highlights found.")}),scope.$on("$destroy",function(){$log.log("💾 rangy @$destroy...")})})["catch"](function(){$log.warn("💾 rangy lib error","ooooo")})}}}),angular.module("miller").directive("rating",function(){return{restrict:"EA",template:'<ul class="star-rating" ng-class="{readonly: readonly}">  <li ng-repeat="star in stars" class="star" ng-class="{filled: star.filled}" ng-click="toggle($index)">    <i class="icon icon-star"></i>  </li></ul>',scope:{ratingValue:"=ngModel",max:"=?",onRatingSelect:"&?",readonly:"=?"},link:function(scope,element,attributes){function updateStars(){scope.stars=[];for(var i=0;i<scope.max;i++)scope.stars.push({filled:i<(scope.ratingValue||0)})}void 0==scope.max&&(scope.max=5),scope.toggle=function(index){if(void 0==scope.readonly||scope.readonly===!1){scope.ratingValue=index+1,"function"==typeof scope.onRatingSelect&&scope.onRatingSelect({rating:index+1});for(var i in scope.stars){if(!(i<scope.ratingValue))break;scope.stars[i].filled=!0}}},scope.$watch("ratingValue",function(oldValue,newValue){newValue&&updateStars()}),updateStars()}}}),angular.module("miller").directive("richOembed",function($sce,$log,$timeout,RUNTIME){return{restrict:"A",scope:{enabled:"=",oembed:"=",media:"=",autoplay:"=",fullscreen:"&"},templateUrl:RUNTIME["static"]+"templates/partials/directives/rich-oembed.html",link:function(scope,element,attrs){var timer;scope.iframeEnabled=!1,scope.quality=attrs.quality,scope.immediate=void 0!=typeof attrs.immediate,$log.log("🍩 rich-oembed ready, media:",scope.media,"- autoplay:",scope.autoplay,"- type:",scope.oembed.type,"- quality:",scope.quality),scope.$watch("enabled",function(v){$log.debug("🍩 rich-oembed @enabled:",v),scope.toggleEnable(!!v)}),scope.toggleFullscreen=function(){$log.debug("🍩 rich-oembed > toggleFullscreen:",typeof scope.fullscreen),scope.fullscreen()},scope.toggleEnable=function(enabled){$log.log("🍩 rich-oembed > toggleEnable()",enabled);var v=void 0===enabled?!scope.iframeEnabled:enabled;timer&&$timeout.cancel(timer),timer=$timeout(function(){$log.log("🍩 rich-oembed apply iframeEnabled:",v),scope.iframeEnabled=v},100)}}}}),angular.module("miller").directive("slides",function($log,$timeout,$rootScope){return{link:function(scope,element,attrs){scope.isVertical=!!attrs.vertical,scope.currentIndex=0,scope.numSlides=[0,1,2],scope.currentHeight=0,scope.currentOffset=0;var timer,UP=-1,DOWN=1;scope.direction=DOWN,scope.loop=function(){scope.direction==DOWN&&scope.currentIndex==scope.numSlides.length-1?scope.direction=UP:scope.direction==UP&&0==scope.currentIndex&&(scope.direction=DOWN);var index=scope.currentIndex+scope.direction;scope.jumpTo(index)},scope.next=function(){scope.jumpTo(scope.currentIndex+1)},scope.prev=function(){scope.jumpTo(scope.currentIndex-1)},scope.jumpTo=function(index){return scope.isDOMready?(index=Math.max(Math.min(index,scope.numSlides.length-1),0),void(index!=scope.currentIndex&&(scope.currentIndex=index,scope.slide()))):void $log.warn("No RAIL FOUND")},scope.pause=function(){timer&&$timeout.cancel(timer)},scope.play=function(){timer&&$timeout.cancel(timer),"undefined"!=typeof attrs.autoscroll&&(timer=$timeout(scope.loop,3e3))},scope.slide=function(){var slide=element.find(".slide").get(scope.currentIndex);scope.currentHeight=slide.clientHeight,scope.currentOffset=slide.offsetTop,attrs.adapt&&element.height(scope.currentHeight),$rootScope.$emit("lazyImg:refresh"),timer&&$timeout.cancel(timer),"undefined"!=typeof attrs.autoscroll&&(timer=$timeout(scope.loop,6e3))},$timeout(function(){scope.isDOMready=!0,$rootScope.$emit("lazyImg:refresh"),$log.log("slides ready!"),scope.slide()},0)}}}),angular.module("miller").directive("slidingSteps",function($log,$rootScope,RUNTIME,$timeout){return{restrict:"A",scope:{items:"=",focus:"=",language:"="},templateUrl:RUNTIME["static"]+"templates/partials/directives/sliding-steps.html",link:function(scope,element,attrs){function scrollTo(to,callback,duration){function move(amount){document.documentElement.scrollTop=amount,document.body.parentNode.scrollTop=amount,document.body.scrollTop=amount}function position(){return document.documentElement.scrollTop||document.body.parentNode.scrollTop||document.body.scrollTop}var start=position(),change=to-start,currentTime=0,increment=20;duration="undefined"==typeof duration?360:duration;var animateScroll=function(){currentTime+=increment;var val=easeInOutQuad(currentTime,start,change,duration);move(val),currentTime<duration?requestAnimFrame(animateScroll):callback&&"function"==typeof callback&&callback()};animateScroll()}$log.log("⏣ sliding-steps ready, items.length:",_.map(scope.items,"_index"),scope.items.length,scope.items);var lastIdxSelected,sideOffset=0,refOffset=0,parentOffset=element.offset().top,steps=element.find(".sliding-steps"),stepswrapper=steps.parent(),stepsHeight=steps[0].offsetHeight,stepswrapperHeight=stepswrapper[0].offsetHeight,translateY=0;scope.user=$rootScope.user;var requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}(),easeInOutQuad=function(t,b,c,d){return t/=d/2,t<1?c/2*t*t+b:(t--,-c/2*(t*(t-2)-1)+b)};scope.reach=function(idx,sideoffset,refOffset,step){stepswrapperHeight=stepswrapper[0].offsetHeight,stepsHeight=steps[0].offsetHeight;var expectedOffset=refOffset-sideoffset,visibleOffset=-(sideoffset+step[0].offsetHeight-stepswrapperHeight);$log.log("⏣ sliding-steps > reach idx:",idx,"- side offset:",sideoffset,"- ref offset:",refOffset,"- parentOffset:",parentOffset,"- expectedOffset:",expectedOffset,"- visibleOffset:",visibleOffset,"- step[0].offsetHeight: ",step[0].offsetHeight),translateY=Math.min(expectedOffset,visibleOffset),steps.css("transform","translateY("+translateY+"px)"),scope.isMoreTop=expectedOffset<-2,scope.isMoreBottom=stepsHeight+translateY>stepswrapperHeight},scope.prev=function(){$log.log("⏣ sliding-steps > prev - idx:",lastIdxSelected,"- isMoreTop:",scope.isMoreTop),scope.isMoreTop&&(steps.children().each(function(i,d){return d.offsetTop+translateY>0?(console.log("...",target),!1):void(target=+d.id.replace("step-",""))}),target&&scope.alignTo(target))},scope.next=function(){$log.log("⏣ sliding-steps > next - idx:",lastIdxSelected,"- steps",steps),steps.children().each(function(i,d){return i<lastIdxSelected||(console.log("...",d.offsetTop+d.offsetHeight+translateY,stepswrapperHeight,d.offsetTop+d.offsetHeight+translateY<stepswrapperHeight),d.offsetTop+d.offsetHeight+translateY>stepswrapperHeight?(scope.alignTo(+d.id.replace("step-","")),!1):void 0)})},scope.isMoreTop=!1,scope.isMoreBottom=stepsHeight>stepswrapperHeight,scope.fullsize=function(slug,type){$log.log("⏣ sliding-steps > fullsize slug:",slug),$rootScope.fullsize(slug,type)},scope.align=function(idx,_sideOffset,_refOffset){var item=angular.element("#item-"+idx),step=element.find("#step-"+idx);return sideoffset=_sideOffset||step[0].offsetTop,refOffset=_refOffset||item[0].offsetTop,lastIdxSelected==idx-1?void scope.reset(item):(void 0!==lastIdxSelected&&(scope.items[lastIdxSelected].isFocused=!1,angular.element("#item-"+(lastIdxSelected+1)).removeClass("active")),item.addClass("active"),lastIdxSelected=idx-1,scope.items[idx-1].isFocused=!0,void scope.reach(idx,sideoffset,refOffset,step))},scope.reset=function(){lastIdxSelected&&(scope.items[lastIdxSelected].isFocused=!1,angular.element("#item-"+(lastIdxSelected+1)).removeClass("active"),lastIdxSelected=void 0)},scope.alignTo=function(idx){$log.log("⏣ sliding-steps > alignTo -idx:",idx);var step=element.find("#step-"+idx);sideOffset=step[0].offsetTop,refOffset=angular.element("#item-"+idx)[0].offsetTop;var wrapperOffset=element.parent().offset().top;$log.log("⏣ sliding-steps > alignTo idx:",idx,"- side offset:",sideOffset,"- ref offset:",refOffset,"- win height:",window.innerHeight/3,"- parentOffset:",parentOffset,"- current scrollY:",window.scrollY),scrollTo(refOffset+wrapperOffset-window.innerHeight/2),scope.align(idx,sideOffset,refOffset,step)},scope.$watch("focus",function(idx){idx?($log.log("⏣ sliding-steps @focus - idx:",idx,scope.items[idx-1]),scope.align(idx)):0===idx&&scope.reset()}),scope.$watch("items",function(items){items&&items.length&&($log.log("⏣ sliding-steps @items",items),scope.items=items)}),$timeout(function(){stepsHeight=steps[0].offsetHeight,stepswrapperHeight=stepswrapper[0].offsetHeight,scope.isMoreBottom=stepsHeight>stepswrapperHeight},1e3)}}}),angular.module("miller").directive("sticky",function($log,$window,$timeout){return{restrict:"AE",scope:{},link:function(scope,element,attrs){var w=angular.element(window),pl=angular.element('<div class="sticky-placeholder"></div>'),offsetTop=parseInt(attrs.offset||100),_is_bottom_visible=!0,_is_top_visible=!1;pl.insertBefore(element),scope.is_top_visible=!1;var resize=function(){wh=w.height(),evaluate()},evaluate=function(){var ot=pl.offset().top,ws=w.scrollTop();_is_bottom_visible=wh+ws>ot,_is_top_visible=ws+offsetTop<ot,scope.is_top_visible!=_is_top_visible&&(_is_top_visible?element.removeClass("top-sticky"):element.addClass("top-sticky"),scope.is_top_visible=_is_top_visible),scope.is_visible!=_is_bottom_visible&&(_is_bottom_visible?element.removeClass("sticky"):element.addClass("sticky"),scope.is_visible=_is_bottom_visible)};$timeout(function(){w.on("scroll",evaluate),w.on("resize",resize),resize()},200),scope.$on("$destroy",function(){w.off("scroll",evaluate),w.off("resize",resize),$log.log("::sticky killed.")})}}}),angular.module("miller").run(["$templateCache",function($templateCache){$templateCache.put("/static/templates/assign.html",'<div class=\'container\'>\n  <div class=\'view\'>\n    <h1>\n      <a ng-if=\'state != "assign.all"\' href ui-sref=\'assign.all\'>../</a>\n      <span translate="headline.{{state}}.title"></span>\n    </h1>\n    <p translate="headline.{{state}}.abstract"></p>\n\n    <!-- Nav tabs -->\n    <ul class=\'nav nav-tabs\' style=\'margin-top:20px\'>\n      <li role="presentation" ui-sref-active="active" >\n        <a href ui-sref=\'assign.all\' aria-controls="home" role="tab" data-toggle="tab" translate="state.assign.all"></a>\n      </li>\n    </ul>\n\n    <table cellspacing="20">\n      <tr>\n        <td class=\'nav-filters\'>\n          <!-- <ul class=\'nav nav-tabs \'></ul> -->\n          <ul class=\'nav nav-tabs \'>\n            <li ng-repeat=\'link in links\' role="presentation" ui-sref-active="active" >\n              <a href ui-sref=\'assign.{{link.slug}}\' aria-controls="home" role="tab" data-toggle="tab" translate="state.assign.{{link.slug}}"></a>\n            </li>\n          </ul>\n        </td>\n        <td><div ui-view></div></td>\n      </tr>\n    </table>\n  </div>\n</div>'),$templateCache.put("/static/templates/author.edit.html","<div class='container'>\n  <div class='view'>\n    <h2>{{author.fullname}}</h2>\n<form ng-submit=\"save()\">\n  <div class=\"row\">\n    <div class=\"col-sm-6\">\n    <p>\n    <label>\n      <span translate=\"field.label.firstname\"></span>\n    </label>\n    <textarea class='elastic-textarea' rows=\"1\" msd-elastic ng-model='author.data.firstname'  type='text'></textarea>\n    </p>\n    </div>\n    <div class=\"col-sm-6\">\n    <p>\n    <label>\n      <span translate=\"field.label.lastname\"></span>\n    </label>\n    <textarea class='elastic-textarea' rows=\"1\" msd-elastic ng-model='author.data.lastname'  type='text'></textarea>\n    </p>\n    </div>\n  </div>\n  \n\n  <p>\n  <label>\n    <span translate=\"field.label.affiliation\"></span>\n  </label>\n  <textarea class='elastic-textarea' rows=\"1\" msd-elastic ng-model='author.affiliation'  type='text'></textarea>\n  </p>\n\n  <p>\n  <label>\n    <span translate=\"field.label.bio\"></span>\n  </label>\n  <textarea class='elastic-textarea' rows=\"1\" msd-elastic ng-model='author.data.biography'  type='text' placeholder='short biography'></textarea>\n  </p>\n\n  <div class=\"btn-line-group primary\">\n  <button class=\"btn-line\" type=\"submit\">\n    <span ng-if='!isSaving' translate='button.save'></span>\n    <span ng-if='isSaving' translate='button.issaving'></span>\n  </button>\n  </div>\n</form>\n</div>\n</div>"),$templateCache.put("/static/templates/author.html","<div class='container'>\n  <div class='view'>\n    <h2>{{author.fullname}}</h2>\n    <div class='affiliation sans-serif' embedit='author.affiliation' language='language'></div>\n    \n    <div embedit='author.data.biography' markdown='true' language='language'></div>\n    \n    <div ui-view></div>\n  \n    <div ng-if='isMe || user.is_staff' class='actions'>\n      <div class='btn-line-group primary'>\n        <button ui-sref='modifyauthor({slug: author.slug})' class='btn-line' translate=\"button.edit.author\"></button>\n      </div>\n    </div>\n    \n  </div>\n</div>"),$templateCache.put("/static/templates/author.publications.html",'\n\n<h3 ng-if=\'isMe\' translate="me.publications"></h3>\n<h3 ng-if=\'!isMe\' translate="latest publications"></h3>\n<!-- Nav tabs -->\n  <ul class=\'nav nav-tabs\'>\n    <li role="presentation" ui-sref-active="active" >\n      <a href ui-sref=\'author.publications.all\' aria-controls="home" role="tab" data-toggle="tab" translate="state.publications.all.label"></a>\n    </li>\n    \n\n    <li ng-repeat=\'link in urls.writing\' role="presentation" ui-sref-active="active">\n      <a ng-if=\'link.preventTranslation\' href ui-sref=\'author.publications.{{link.slug}}({username: author.profile.username})\' aria-controls="home" role="tab" data-toggle="tab">{{link.name}}</a>\n      <a ng-if=\'!link.preventTranslation\' href ui-sref=\'author.publications.{{link.slug}}({username: author.profile.username})\' aria-controls="home" role="tab" data-toggle="tab" translate="state.publications.{{link.name}}.label"></a>\n    </li>\n    \n    <li ng-if=\'isMe\' ui-sref-active="active">\n      <a href ui-sref=\'author.publications.drafts({username: author.profile.username})\' aria-controls="home" role="tab" data-toggle="tab" translate="drafts"></a>\n    </li>\n    <li ng-if=\'isMe\' ui-sref-active="active">\n      <a href ui-sref=\'author.publications.bin({username: author.profile.username})\' aria-controls="home" role="tab" data-toggle="tab" translate="bin"></a>\n    </li>\n  </ul>\n  \n\n<div ui-view></div>\n'),$templateCache.put("/static/templates/authors.html","\n<h2 translate=\"headline.authors\"></h2>\n<ul class=\"nav nav-tabs ng-scope\">\n</ul>\n<div ui-view>\n  <div class='post' ng-repeat='profile in items'>\n    <div class='wrapper'>\n      <div ng-if=\"!$first\" class=\"divider ng-scope\"></div>\n      <div class='tags'><span class='tag'>author</span></div>\n      <h3><a ui-sref=\"author.publications({username: profile.user.username})\">{{profile.user.first_name}} {{profile.user.last_name}}</a></h3>\n      <div class='type'>{{profile.user.username}}</div>\n      <div markdown='profile.bio|| \"...\"'></div>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/blog.html",'<div class=\'container tight-container\'>\n<div class=\'view\'>\n<div class=\'row\'>\n<div class=\'col-lg-8\'>\n  <div>\n    <h1 translate="headline.blog.title"></h1>\n\n    <!-- <blockquote translate="headline.blog.abstract"></blockquote> -->\n\n    </div>\n  </div>\n</div>\n<!-- Nav tabs -->\n<ul class="nav nav-tabs" role="tablist">\n  <li role="presentation" ui-sref-active="active"><a href ui-sref=\'blog.event\' aria-controls="home" role="tab" data-toggle="tab" translate="state.blog.events.label"></a></li>\n  <li role="presentation" ui-sref-active="active"><a href ui-sref=\'blog.news\' aria-controls="profile" role="tab" data-toggle="tab" translate="state.blog.news.label"></a></li>\n</ul>\n\n<div ui-view></div>\n</div>\n</div>'),$templateCache.put("/static/templates/collection.html","<div class=\"collection\" ng-class='state|statetoclass'>\n\n  \n\n  <div class='container'>\n    <div class=\"view\">\n      \n\n      <div class=\"actions\" >\n        <div ng-if='story.isWritable' class='btn-line-group primary'>\n          <button  class='btn-line' nref ui-sref='writing({storyId:story.slug})'>edit</button>\n        </div>\n\n        <div ng-if='user.is_staff' class='btn-line-group'>\n          <button class='btn-line' ng-click='setStatus(\"draft\")' ng-class='{\"active warning\": story.status==\"draft\"}' translate=\"story.status.draft\"></button>\n          <button class='btn-line' ng-click='setStatus(\"public\")' ng-class='{\"active\": story.status==\"public\"}' translate=\"story.status.public\"></button>\n        </div>\n      </div>\n    </div>\n\n\n  </div>\n  \n  \n\n  <div class='container'>\n    <div class='row'>\n      <div class='col-md-12'>\n        <div class=\"tags\" >\n          <!-- <span ng-if=\"story.tags.length\" class='tag sans-serif' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span> -->\n          <span class='tag sans-serif'>\n            <span class='tag writing'><a ui-sref='publications.collection'>collection</a></span>\n          </span>\n        </div>\n        <div class=\"issue\" embedit='story.data.issue'></div>\n        <h1 id='collection-title'><a ui-sref='story({storyId:story.slug})' embedit='story.data.title' language='language'></a></h1>\n        \n        <!-- <div class='authors' ng-if=\"story.authors.length\">\n          by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n        </div> -->\n        \n      </div>\n    </div>\n  </div>\n\n\n  <div id='collection-index' sticky offset='70'>\n  <div class='container' style=\"\">\n    <div class='row'>\n      <div class=\"col-sm-12\">\n        <ul class='pagination'>\n          <li ui-sref-active=\"active\" class='special'>\n            <a ui-sref='story({postId:story.slug})' translate='index'>&nbsp;</a>\n          </li>\n          <li ui-sref-active=\"active\" ng-repeat=\"chapter in story._chapters\">\n            <a ui-sref='story.story({postId:story.slug, chapterId:chapter.slug})'>{{$index + 1}}</a>\n          </li>\n\n        </ul>\n      </div>\n    </div>\n  </div>\n  </div>\n\n  <div ui-view  style='background: #f0f0f0; margin-top: 48px;'>\n    <div class='container'>\n    <div class=\"cover-wrapper\" ng-if='story.cover'>\n      <div class='image-wrapper cover' lazy-img='{{story.cover.attachment || story.cover.data.preview || story.cover.data.urls.Preview || story.cover.data.thumbnail_url || story.cover.data.url }}'></div>\n      <div class='metadata-wrapper' ng-init='document=story.cover' ng-include='\"templates/partials/document.metadata.linear.html\"|prefixTemplate''></div>\n    </div>\n    </div>\n    <div class='container'>\n      <div class='row'>\n        <div class=\"col-sm-12\">\n        <p id='collection-abstract' embedit='story.data.abstract' language='language'></p>\n        </div>\n      </div>\n    </div>\n    <div  ng-repeat=\"chapter in story._chapters\">\n      <div class='container'>\n        <div class=\"chapter\" ng-class='{\"last\": $last}'>\n\n          <a class=\"number\" ui-sref='story.story({postId:story.slug, chapterId:chapter.slug})'>{{$index + 1}}</a>\n          <div class='col-md-6'>\n            <div class=\"inner\">\n              <div class=\"divider\"></div>\n              <div class=\"tags\" ng-if=\"chapter.tags.length\">\n                <span class=\"tag\" ng-repeat='tag in chapter.tags|filter:{ category: \"writing\", status:\"public\" }' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n              </div>\n              <h2><a ui-sref='story.story({postId:story.slug, chapterId:chapter.slug})' embedit='chapter.data.title' language='language'></a></h2>\n              <blockquote embedit='chapter.data.abstract' language='language'></blockquote>\n            </div>\n          </div>\n          <div class='col-md-6' style='padding:0'>&nbsp;\n            <div ng-if='chapter.covers.length' class=\"cover\" ng-repeat='document in chapter.covers' class='fluid-container'>\n              <div class='image-wrapper cover' lazy-img='{{document|coverage}}'></div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    \n  </div>\n</div>"),$templateCache.put("/static/templates/doi.html","doi"),$templateCache.put("/static/templates/draft.html","<div class='container tight-container'>\n<div class='view'>\n  <p>\n    <label>\n      <span translate=\"field.label.title\"></span>\n    </label>\n    <textarea id='draft-title' class='elastic-textarea' rows=\"1\" msd-elastic ng-model='title'   type='text' placeholder='Untitled'></textarea>\n  </p>\n  <p>\n    <label>\n      <span translate=\"field.label.abstract\"></span>\n    </label>\n    <textarea id='draft-abstract' class='elastic-textarea' rows=\"1\" msd-elastic ng-model='abstract' type='text' placeholder='abstract'></textarea>\n  </p>\n\n  <div class='actions'>\n    <div class='btn-line-group primary'>\n      <button ng-click='save()' class='btn-line'><span translate=\"button.create\"></span></button>\n    </div>\n  </div>\n</div>\n</div>"),$templateCache.put("/static/templates/index.html","<div class=\"container\">\n  <div class=\"view\">\n    <div class=\"row\">\n      <div class=\"col-md-9\">\n        <div class=\"col-md-12\">\n          <h5 class='lined'><span translate='site.title'></span></h5>\n\n          <!-- CONVER STORY -->\n          <div class=\"row\" style=\"padding-top: 18px\">\n            <div class='slides-wrapper' slides autoscroll ng-mouseover='pause()' ng-mouseout='play()'>\n              <ul class='nav slides-nav'>\n                <li ng-repeat=\"n in numSlides\" ng-click='jumpTo(n)' ng-class='{\"active\": currentIndex == n}'></li>\n              </ul>\n              <div class='slides-inner'>\n                <div class='slides-rail' style='transform: translateY(-{{currentOffset}}px)'>\n                  <div class='slide' style='width: 100%' ng-repeat=\"coverstory in coverstories\" ng-include='\"templates/partials/coverstory.html\"|prefixTemplate'></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class=\"col-md-12\" style=\"margin-top: 28px\">\n          <div class=\"row\">\n          <!-- REMAINING STORIES -->\n            <div ng-repeat='story in otherstories' class=\"col-md-6 story-card\" ng-class-odd=\"'clear-left'\">\n              <div class=\"coverstory other story-card-inner\">\n                <div ui-sref=\"story({postId: story.slug})\" style='cursor:pointer' ng-if='story.covers.length' ng-repeat='document in story.covers | limitTo:1' class='fluid-container relative'>\n                  <div class='image-wrapper cover' lazy-img='{{document|coverage}}'></div>\n                  <div class='embedded-metadata' ng-include='\"templates/partials/document.metadata.embedded.html\"|prefixTemplate'></div>\n                </div>\n                <h4>\n                  <a ng-if='!story.is_collection' href ui-sref=\"story({postId: story.slug})\" rewording value='story.data.title' default='{{story.title}}'></a>\n                  <a ng-if='story.is_collection' href ui-sref=\"collection({collectionId: story.slug})\" rewording value='story.data.title' default='{{story.title}}'></a>\n                </h4>\n                <div class='authors' ng-if=\"story.authors.length\">\n                  by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"col-md-3\">\n        <div class=\"col-md-12\" style=\"height: 368px;\">\n          <h5 class='lined'><span>Popular topics</span></h5>\n          <canvas id=\"tagcloud\" style=\"width: 100%; margin-top: 45px;\"></canvas>\n        </div>\n        <div class=\"col-md-12\">\n          <h5 class='lined'><span translate='latest news'></span></h5>\n          <div style=\"background-color: #f0f0f0; padding: 18px\">\n            <div ng-repeat='story in news'>\n              <div class=\"coverstory news\">\n                <div ng-if='!$first' class=\"divider\"></div>\n                <div class=\"date\">{{story.date|date:\"yyyy'.'MM'.'dd\"}}</div>\n                <h4>\n                  <a ng-if='!story.is_collection' href ui-sref=\"story({postId: story.slug})\" rewording value='story.data.title' default='{{story.title}}'></a>\n                  <a ng-if='story.is_collection' href ui-sref=\"collection({collectionId: story.slug})\" rewording value='story.data.title' default='{{story.title}}'></a>\n                </h4>\n\n                <div class='contents'>\n                  <div class='authors' ng-if=\"story.authors.length\">\n                    by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n                  </div>\n                  <blockquote class=\"reduced\">\n                    <span embedit='story.excerpt' language='language'></span>\n                    <a href ui-sref=\"story({postId: story.slug})\"><span class='icon-arrow-right-circle'></span></a>\n                  </blockquote>\n                </div>\n\n                <div ui-sref=\"story({postId: story.slug})\" style='cursor:pointer' ng-if='story.covers.length' ng-repeat='document in story.covers | limitTo:1' class='fluid-container relative'>\n                  <div class='image-wrapper cover' lazy-img='{{document|coverage}}'></div>\n                  <div class='embedded-metadata' ng-include='\"templates/partials/document.metadata.embedded.html\"|prefixTemplate'></div>\n                </div>\n                <div style='clear:both'></div>\n\n              </div>\n            </div>\n          </div>\n\n          <div style='text-align: center; margin-top: 20px'>\n            <div class=\"btn-line-group primary dual\">\n              <button class='btn-line' ui-sref='blog.event'>\n                <span translate='button.more.events'></span>\n              </button>\n              <button class='btn-line' ui-sref='blog.news'>\n                <span translate='button.more.news'></span>\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>"),
$templateCache.put("/static/templates/items.html","<div ng-if='count == 0' translate='items.empty'></div>\n<div ng-if='itemTemplate == \"author.item\"' ng-repeat='author in items' ng-include='\"templates/partials/author.item.html\"|prefixTemplate'></div>\n\n<div ng-if='itemTemplate == \"story\"' ng-repeat='story in items' ng-include='\"templates/partials/story.html\"|prefixTemplate'></div>\n<div ng-if='itemTemplate == \"action\"' ng-repeat='action in items' ng-include='\"templates/partials/action.html\"|prefixTemplate'></div>\n<div ng-if='itemTemplate == \"review\"' ng-repeat='review in items' ng-include='\"templates/partials/review.html\"|prefixTemplate'></div>\n<div ng-if='itemTemplate == \"report\"' ng-repeat='review in items' ng-include='\"templates/partials/report.html\"|prefixTemplate'></div>\n<div ng-if='itemTemplate == \"story.pending\"' ng-repeat='story in items' ng-include='\"templates/partials/story.pending.html\"|prefixTemplate'></div>\n\n<div style='text-align: center'>\n  <div ng-if='items.length > 0 && items.length < count' class=\"btn-line-group primary\">\n    <button class='btn-line' ng-click='more()'>\n      <span ng-if='!isLoadingNextItems'>\n        <span translate='button.more'></span>\n        <span translate='missing' translate-values=\"{count: missing}\"></span>\n      </span>\n      <span ng-if='isLoadingNextItems' translate='button.loading'></span>\n    </button>\n  </div>\n  <!-- when count equals item length, we are at the end -->\n</div>"),$templateCache.put("/static/templates/listofitems.html","<div class='container listofitems'>\n  <div class='view'>\n    <h1>\n      <a ng-if='state != mainStatename' href ui-sref='{{mainStatename}}'><span class=\"icon icon-arrow-left-circle\"></a>\n      <span translate=\"state.{{state}}.title\"></span><span ng-if='tag' rewording value='tag.data.name' follow='tag' default='{{tag.name}}'></span>\n    </h1>\n    <p translate=\"state.{{state}}.abstract\"></p>\n    <!-- Nav tabs -->\n    <ul class='nav nav-tabs nav-top'>\n      <li role=\"presentation\" ui-sref-active=\"active\" >\n        <a href ui-sref='{{mainStatename}}' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"state.{{mainStatename}}.label\"></a>\n      </li>\n      <li ng-if='mainRoutes.length' role=\"presentation\" class='divider'></li>\n      <li ng-if='tag' ui-sref-active=\"active\">\n        <a href class='quick' ui-sref='{{rootStatename}}.tags({slug: tag.slug})' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\">\n          <span>{{tag.category}}</span>/<b rewording value='tag.data.name' follow='tag' default='{{tag.name}}'></b>\n        </a>\n      </li>\n      <li ng-if='tag' class='divider'></li>\n      <li ng-if='mainRoutes' ng-repeat='url in mainRoutes' role=\"presentation\" ui-sref-active=\"active\">\n        <a ng-if='url.name' href ui-sref='{{rootStatename}}.{{url.slug}}' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\">{{url.name}}</a>\n        <a ng-if='!url.name' href ui-sref='{{rootStatename}}.{{url.slug}}' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"state.{{rootStatename}}.{{url.slug}}.label\"></a>\n      </li>\n    </ul>\n    <!-- Nav tabs -->\n    <table cellspacing=\"20\">\n      <tr>\n        <td class='nav-filters'>\n          <ul class='nav nav-tabs' ng-if='availabileOrderby'>\n            <li class=\"dropdown\">\n              <a bs-dropdown placement='bottom-left' aria-haspopup=\"true\" aria-expanded=\"false\" style='position:relative; padding-right: 30px'>\n                <span class='username'><span class='ellipsis' translate='order.by.{{ordering}}'></span><span style='position:absolute; right:5px; top:0' class='icon icon-arrow-down-circle'></span></span>\n              </a>\n              <ul class=\"dropdown-menu\" role=\"menu\">\n                <li ng-repeat='orderby in availabileOrderby' ng-class='{\"active\":params.orderby==orderby.value}'><a ng-click='changeOrderby(orderby.value)' translate='order.by.{{orderby.label}}'></a></li>\n              </ul>\n            </li>\n          </ul>\n\n          <ul class='nav nav-tabs categoryFilters' ng-if=\"availableRoutes.length\">\n            <li ng-if=\"url.slug!='all'\" ng-repeat='url in availableRoutes' role=\"presentation\" ng-class='{\"active\": isTagActive(url.slug)}'>\n              <a ng-if='url.name'\n                 ng-click='selectTag(url.slug)'\n                 class=\"force-pointer\"\n                 aria-controls=\"home\"\n                 role=\"tab\"\n                 data-toggle=\"tab\">\n                {{url.name}}\n              </a>\n\n              <a ng-if='!url.name'\n                 ng-click='selectTag(url.slug)'\n                 class=\"force-pointer\"\n                 aria-controls=\"home\"\n                 role=\"tab\"\n                 data-toggle=\"tab\"\n                 translate=\"state.{{url.state}}.{{url.slug}}.label\">\n              </a>\n\n              <ul class='nav nav-tabs' ng-if='hallOfFame.publishings && state == \"publications.\"+url.slug && hallOfFame.publishings.count' style='border: 0px; border-left: 2px solid; padding-left: 10px'>\n                <li ng-class='{\"active\":(filters.tags__slug__all | inArray : tag.slug)}' ng-repeat='tag in hallOfFame.publishings.results'>\n                  <a class='tag with-number' ng-click='toggleFilter(\"tags__slug__all\", [tag.slug])'>{{tag.name}}\n                  <span class='number'>{{tag.stories}}</span>\n                  </a>\n                </li>\n              </ul>\n\n            </li>\n          </ul>\n\n          <h4 class='section' ng-if='hallOfFame.topAuthors.count' translate='top authors'></h4>\n          <ul class='nav nav-tabs' ng-if='hallOfFame.topAuthors.count'>\n            <li ng-class='{\"active\":isAuthorActive(author.slug)}' ng-repeat='author in hallOfFame.topAuthors.results'>\n              <a class='author with-number' ng-click='selectTag(author.slug, \"authors__slug__and\")'>{{author.fullname}}\n              <span class='number'>{{author.stories}}</span>\n              </a>\n            </li>\n          </ul>\n\n\n          <h4 class='section' ng-if='keywords'>Keywords</h4>\n          <ul class='nav nav-tabs' ng-if='keywords'>\n            <li ng-repeat='keyword in keywords' ng-class='{\"active\": isTagActive(keyword.slug)}'>\n              <a class='tag' ng-click=\"selectTag(keyword.slug, null, tagsStateurl)\">{{getTranslatedTag(keyword)}}</a>\n            </li>\n          </ul>\n        </td>\n        <td><div ui-view></div></td>\n      </tr>\n    </table>\n  </div>\n</div>"),$templateCache.put("/static/templates/login.html",'<div class="container">\n  <div class="view">\n    <div class="row">\n      <div class="col-md-6">\n        <h1 translate="login"></h1>\n\n        <form role="form" name="loginform" method="POST">\n          <div class="form-group">\n            <label for="id_login_username" translate="username"></label>\n            <input type="text" ng-model=\'username\' class="form-control" id="id_login_username" autofocus="autofocus" name="username" placeholder="username" required>\n          </div>\n\n          <div class="form-group">\n            <label for="id_login_password" translate="password"></label>\n            <input type="password" ng-model=\'pwd\' class="form-control" id="id_login_password" placeholder="Password" name="password" required>\n          </div>\n\n          <div class=\'btn-line-group primary\'>\n            <button class="btn btn-line" ng-click="login()" translate=\'button.login\'></button>\n          </div>\n        </form>\n      </div>\n    </div>\n\n    <div class="row">\n      <div class="col-sm-6 col-sm-offset-3">\n        <h3 translate=\'signup.with.social\'></h3>\n\n        <div class=\'btn-line-group\'>\n          <a class=\'btn btn-line\' href=\'/social/login/twitter\' translate=\'button.signup.with.twitter\'></a>\n        </div>\n        <div class=\'btn-line-group\'>\n          <a class=\'btn btn-line\' href=\'/social/login/google-oauth2\' translate=\'button.signup.with.google\'></a>\n        </div>\n\n      </div>\n    </div>\n  </div>\n</div>'),$templateCache.put("/static/templates/md.html","<div class=\"container tight-container\">\n<div class=\"view\">\n<div class='row'>\n  <div class='col-md-12'>\n    <div class=\"contents\">\n    <div markdownit='md' watchlanguage='true' language='language' settoc='setToC(ToC)'></div>\n    </div>\n  </div>\n</div>\n</div>\n</div>"),$templateCache.put("/static/templates/notfound.html","not found. \nGo back"),$templateCache.put("/static/templates/notifications.html",'<div class=\'container\'>\n  <div class=\'view\'>\n    <h2 translate=\'button.more.notification\'></h2>\n    <ul class="nav nav-tabs" style="margin-top: 20px;">\n      <li role="presentation" ui-sref-active="active">\n      <a href="/related-publications" ui-sref="notifications.activities" aria-controls="home" role="tab" data-toggle="tab" translate="state.notifications.activities.label" class="ng-scope"></a>\n    </ul>\n    <div ui-view></div>\n\n  </div>\n</div>'),$templateCache.put("/static/templates/profile.html","<div class='container'>\n  <div class='view'>\n    <h1>{{profile.username}}</h1>\n    <div ng-repeat='author in authors' style=\"position:relative; border-bottom:1px solid #ccc\">\n    \n      <h2>{{author.fullname}}</h2>\n      <div class='affiliation sans-serif' embedit='author.affiliation' language='language'></div>\n      \n      <div embedit='author.metadata.biography' markdown='true' language='language'></div>\n      \n      \n    \n      <div ng-if='isMe || user.is_staff' class='actions'>\n        <div class='btn-line-group primary'>\n          <button ui-sref='modifyauthor({slug: author.slug})' class='btn-line' translate=\"button.edit.author\"></button>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <h3 translate=\"latest publications\"></h3>\n  <!-- Nav tabs -->\n  <ul class='nav nav-tabs'>\n    <li role=\"presentation\" ui-sref-active=\"active\" >\n      <a href ui-sref='author.publications({slug: author.slug})' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"state.publications.all.label\"></a>\n    </li>\n    <li ng-if='isMe' ui-sref-active=\"active\">\n      <a href ui-sref='profile.publications({username: profile.username})' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"drafts\"></a>\n    </li>\n    <li ng-if='isMe' ui-sref-active=\"active\">\n      <a href ui-sref='profile.publications({username: profile.username})' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"bin\"></a>\n    </li>\n  </ul>\n  \n\n  <div ui-view></div>\n</div>"),$templateCache.put("/static/templates/review.html","\n<div ui-view>\n  <div class='container'>\n  <div class='view review'>\n    <div class=\"actions\" >\n      <div class='btn-line-group'>\n        <button ng-if='is_assignee && is_reviewed' class='btn-line' ui-sref=\"reviews.complete\" translate=\"button.backtoreviews\"></button>\n        <button ng-if='is_assignee && !is_reviewed' class='btn-line' ui-sref=\"reviews.pending\" translate=\"button.backtoreviews\"></button>\n        <button ng-if='!is_assignee && is_reviewed' class='btn-line' ui-sref=\"assign.all\" translate=\"button.backtoreviews\"></button>\n        <button ng-if='!is_assignee && !is_reviewed' class='btn-line' ui-sref=\"assign.pending\" translate=\"button.backtoreviews\"></button>\n      </div>\n      <div class='btn-line-group primary'>\n        <button class='btn-line' ui-sref=\"review.story({id:review.id})\" translate=\"button.viewmode\"></button>\n      </div>\n    </div>\n\n    <h1><span translate=\"headline.review.of\"></span></h1>\n    <div class='reviewed'>\n      <div class=\"date\">{{review.story.date|date:'mediumDate'}}</div>\n      \n      <h2><a ui-sref='review.story({id:review.id})' embedit='review.story.metadata.title' language='language'></a></h2>\n      <blockquote ng-if='review.story.metadata.abstract' embedit='review.story.metadata.abstract' language='language'></blockquote>\n      <div ng-if='!is_editable && review.category != \"editing\"'>\n        <h2 class='center' ><span translate='field.label.review.score'></span> <span ng-class='{\"error\": !is_valid}'>{{points}}</span> / {{fields.length * 5}}</span></h2>\n        <!-- final decision: -->\n        <h3 class='center'>\n          <span translate='field.label.review.status.{{review.status}}'></span>\n        </h3>\n      </div>\n    </div>\n\n    \n\n    <form class='generic-form-wrapper' name=\"createForm\" novalidate>\n      <div ng-if='review.category != \"editing\"' ng-repeat='field in fields' style='margin: 10px 0 20px 0px'>\n        <label style='margin-left:60px'>\n\n          <span class=\"number\" ng-class='{\"active\": review[field + \"_score\"] > 0, \"error\": createForm[field].$dirty && !createForm[field].$valid}'>{{$index+1}}<span class='todo' ng-class='{\"resolved\": review[field + \"_score\"] > 0}'></span></span>\n            <span translate=\"field.label.{{field}}\"></span>\n          <!-- <p class='description' translate=\"field.label.{{field}}.description\"></p> -->\n        </label>\n        <div rating readonly='!is_editable' ng-model='review[field + \"_score\"]'></div>\n        <div ng-show='is_editable' class='elastic-textarea-wrapper'>\n          <textarea placeholder='{{\"field.label.placeholder.review\" | translate}}' class='elastic-textarea' msd-elastic ng-model='review[field]' name='{{field}}' ng-model-options=\"{ debounce: 200 }\" ng-disabled='!is_editable'></textarea>\n\n        </div>\n        <div class='answer' ng-if='!is_editable && review[field].length' embedit='review[field]' markdown></div>\n      </div>\n\n      <div style='margin: 10px 0 20px 0px'>\n        <label ng-if='review.category != \"editing\"' style='margin-left:60px'>\n\n          <span class=\"number\" ng-class='{\"active\": createForm.reviewcontentstext.$valid, \"error\": createForm.reviewcontentstext.$dirty && !createFormreviewcontentstext.$valid}'>{{fields.length + 1}}</span>\n            <span translate=\"field.label.review.final\"></span>*\n          <p class='description' translate=\"field.label.review.final.description\"></p>\n        </label>\n\n        <label ng-if='review.category == \"editing\"'>\n          <span translate=\"field.label.review.final\"></span>\n          <p class='description' translate=\"field.label.review.final.description\"></p>\n        </label>\n        <div ng-show='is_editable' class='elastic-textarea-wrapper'>\n          <textarea rows=\"5\" placeholder='{{\"field.label.placeholder.review\" | translate}}' required class='elastic-textarea' msd-elastic ng-model='review.contents' name='reviewcontentstext' ng-model-options=\"{ debounce: 200 }\" ng-disabled='!is_editable' ></textarea>\n\n        </div>\n        <div class='answer' ng-if='!is_editable' embedit='review.contents' markdown></div>\n      </div>\n\n\n      <div style='margin: 20px 0'>\n        <h2 class='center' ng-if='review.category != \"editing\"' ><span translate='field.label.review.score'></span> <span ng-class='{\"error\": !is_valid}'>{{points}}</span> / {{fields.length * 5}}</span></h2>\n        <!-- final decision: -->\n        <h3 ng-if='!is_editable' class='center'>\n          <span translate='field.label.review.status.{{review.status}}'></span>\n        </h3>\n        <div ng-if='is_editable && is_valid && createForm.$valid'>\n          <p translate='field.label.review.final.decision'></p>\n          <div class=\"radio\" ng-repeat='status in availableStatuses'>\n            <label>\n              <input type=\"radio\"\n                ng-model=\"$parent.$parent.reviewStatus\"\n                value=\"{{status}}\"\n                name=\"reviewstatus\">\n              <span translate='field.label.review.status.{{status}}'></span>\n            </label>\n          </div>\n        </div>\n      </div>\n\n      <div ng-if='is_editable' class='center' style='margin: 20px 0'>\n        <div class='btn-line-group' ng-class='{\"primary\": is_valid && reviewStatus != \"intital\" && reviewStatus != \"draft\", \"disabled\": !is_valid}'>\n          <button class='btn-line' ng-click='finalize(reviewStatus)' ng-disabled='!is_valid || reviewStatus == \"intital\" || reviewStatus == \"draft\"'><span translate='button.reviewcompleted' translate-values='{is_valid: is_valid && reviewStatus != \"intital\" && reviewStatus != \"draft\"}'></span></button>\n        </div>\n\n        <div class='btn-line-group' ng-class='{\"primary\": reviewStatus == \"intital\" || reviewStatus == \"draft\"}'>\n          <button class='btn-line' ng-click='save()'><span translate='button.savedraft' translate-values='{isSaving: isSaving}'></span></button>\n        </div>\n      </div>\n    </form>\n\n  </div>\n</div>\n</div>"),$templateCache.put("/static/templates/search.html","<div class='container'>\n<div class='view'>\n<div class='row'>\n  <div class='col-md-8'>\n    <span translate='matchesfound' translate-values=\"{count: count, query: query}\"></span>\n    \n    <ul class=\"filters\">\n      <li class='filter' ng-class='k' ng-repeat=\"(k, v) in qs\">\n        <span ng-if='k == \"q\"'>{{v}}</span>\n        <span ng-if='k != \"q\"'>{{k}}: {{v}} <span ng-click=\"removeLocationFilter(k)\" class=\"icon icon-close\"></span></span>\n      </li>\n    </ul>\n  </div>\n</div>\n<!-- Nav tabs -->\n<ul class='nav nav-tabs'>\n</ul>\n  <div ui-view></div>\n</div>\n</div>"),$templateCache.put("/static/templates/story.chapter.html","<div class=\"story\" style='margin-top: 10px'>\n  \n  \n  \n\n  <div class='overlay'>\n    <div class='container'>\n      \n\n      <div class='row'>\n        <div class='col-md-12'>\n\n          <div class=\"actions\" style='top:10px'>\n            <div ng-if='chapter.isWritable' class='btn-line-group primary'>\n              <button  class='btn-line' nref ui-sref='writing({storyId:chapter.slug, collection:story.slug})'>edit</button>\n            </div>\n\n            <div ng-if='user.is_staff' class='btn-line-group'>\n              <button class='btn-line' ng-click='setStatus(\"draft\")' ng-class='{\"active warning\": chapter.status==\"draft\"}' translate=\"story.status.draft\"></button>\n              <button class='btn-line' ng-click='setStatus(\"public\")' ng-class='{\"active\": chapter.status==\"public\"}' translate=\"story.status.public\"></button>\n            </div>\n          </div>\n\n          <h1><span class=\"\" embedit='chapter.data.title' language='language'></span></h1>\n          \n          <!-- story reference and cite as buttons -->\n          <div embedit='chapter.data.reference' ng-if='chapter.data.reference' markdown='true' language='language'></div>\n          \n          <!-- social share buttons: -->\n          <div ng-if='chapter.status == \"public\"' ng-include='\"templates/partials/story.socialshare.html\"|prefixTemplate'></div>\n\n          \n          <blockquote embedit='chapter.data.abstract' language='language'></blockquote>\n          <div class='authors' ng-if=\"chapter.authors.length\">\n            by <span ng-repeat='author in chapter.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n          </div>\n\n\n        </div>\n\n        \n      </div>\n      <div ng-if='chapter.covers.length' class=\"main cover\" ng-repeat='document in chapter.covers'>\n        <div class='cover-oembed cover-chapter' rich-oembed fullscreen='fullsize(document.slug)' autoplay='true' oembed='document.data' media='document' coverquality='hifi'></div>\n        <div class='metadata-wrapper' ng-include='\"templates/partials/document.metadata.html\"|prefixTemplate''></div>\n      </div>\n     \n\n      <div class='row' style='margin-bottom: 50px'>\n        <div  ng-class='{\"col-md-12\": !documents.length, \"col-md-8 col-lg-7\": documents.length}'>\n          <div class=\"contents\">\n            <div markdownit='chapter.contents' language='language' listener='listener(event, data, callback)' settoc='setToC(ToC)' setdocs='setDocuments(items)'></div>\n          </div>\n        </div>\n        <div class='col-md-4 col-lg-5' ng-if='documents.length' respect-previous-sibling update=\"documents\">\n          <div sliding-steps data-language='language' data-focus='focusedIdx' style='height:100%' items='documents'></div>\n        </div>\n      </div>\n      <!-- <div style='margin-top: 50px' disqus=\"story.slug\"></div> -->\n    </div>\n  </div>\n</div>\n"),$templateCache.put("/static/templates/story.html","<div ng-if='story._isCollection' ng-include='\"templates/collection.html\"|prefixTemplate'></div>\n\n<div ng-if='!story._isCollection' class=\"story\">\n  <div class='container tight-container tight-container tight-container'>\n    <div class=\"view\">\n      <div class=\"actions\" >\n        <div ng-if='review' class='btn-line-group transparent'>\n          <button class='btn-line' ui-sref=\"reviews.pending\" translate=\"button.backtoreviews\"></button>\n        </div>\n        <div ng-if='review' class='btn-line-group primary transparent'>\n          <button class='btn-line' ui-sref=\"review({id:review.id})\" translate='button.completereview'></button>\n        </div>\n        <div class='btn-line-group transparent'>\n          <div class=\"dropdown\">\n            <!-- <li class=\"dropdown\" ng-class=\"{active: state.includes('me') || state.includes('draft')}\"> -->\n\n              <a class='btn-line' bs-dropdown placement='bottom-right' aria-haspopup=\"true\" aria-expanded=\"false\">\n                <span translate='button.downloadas'></span> <span class='icon icon-cloud-download'></span>\n              </a>\n\n              <ul class=\"dropdown-menu\" role=\"menu\">\n                <li>\n                  <a ng-href=\"/api/story/{{story.id}}/download/\" _target=\"blank\">pdf</a>\n                </li>\n                <li ng-if='story.source && (user.is_staff || user.is_chief_reviewer || user.is_reviewer)'>\n                  <a ng-href=\"/api/story/{{story.id}}/download/source\" _target=\"blank\"><span class='icon icon-lock'></span>&nbsp;&nbsp;<span translate='button.downloadsource.limited'></span> </a>\n                </li>\n              </ul>\n\n          </div>\n          <!-- <a  class='btn-line' ng-href=\"/api/story/{{story.id}}/download/\" _target=\"blank\">PDF <span class='icon icon-cloud-download'></span></a> -->\n        </div>\n\n        <div ng-if='story.isWritable && !story.isUnderReview' class='btn-line-group primary transparent'>\n          <button class='btn-line' nref ui-sref='writing({storyId:story.slug})'><span translate='edit'></span> <span class='icon icon-pencil'></span></button>\n        </div>\n\n\n        <div ng-if='story.isWritable && !story.isUnderReview' class='btn-line-group primary transparent'>\n          <button  class='btn-line' ng-if='story.status!=\"deleted\"' ng-click='setStatus(\"deleted\")' translate='remove'><span class='icon icon-bin'></span></button>\n          <button  class='btn-line' ng-if='story.status==\"deleted\"' ng-click='setStatus(\"draft\")' translate='recover'><span class='icon icon-bin'></span></button>\n        </div>\n\n\n        <div ng-if='!user.is_staff && !story.isUnderReview && story.isWritable' class='btn-line-group secondary'>\n          <button class='btn-line' ng-click='publish()'><span translate='button.askforpublication'></span><span class='icon icon-pencil'></span></button>\n        </div>\n        <div ng-if='story.status == \"pending\"  && !user.is_staff' class='btn-line-group primary transparent'>\n          <button class='btn-line' ng-disabled='true'><span translate='story.status.pending'></span></button>\n        </div>\n        <div ng-if='story.status == \"pending\" && user.is_staff' class='btn-line-group primary transparent'>\n          <button class='btn-line' ng-click='createReview()'><span translate='story.status.pending'></span></button>\n        </div>\n        <div ng-if='story.status == \"editing\"' class='btn-line-group primary transparent'>\n          <button class='btn-line' ng-disabled='true'><span translate='story.status.editing'></span></button>\n        </div>\n        <div ng-if='user.is_staff && !story.isUnderReview' class='btn-line-group'>\n          <button class='btn-line' ng-click='setStatus(\"draft\")' ng-class='{\"active warning\": story.status==\"draft\"}' translate=\"story.status.draft\"></button>\n          <button class='btn-line' ng-click='setStatus(\"public\")' ng-class='{\"active\": story.status==\"public\"}' translate=\"story.status.public\"></button>\n        </div>\n\n        <div ng-if='story.status == \"review\"' class='btn-line-group primary transparent'>\n          <button class='btn-line' ng-disabled='true'><span translate='story.status.review'></span></button>\n        </div>\n      </div>\n    </div>\n  </div>\n\n\n\n  <div class='overlay'>\n    <div class='container tight-container tight-container tight-container'>\n      <div class='row'>\n        <div class='col-md-8'>\n          <div class=\"tags\" >\n            <span class='tag sans-serif' ng-repeat='tag in story._tags.writing' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n            <span class='tag sans-serif' ng-repeat='tag in story._tags.blog' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n             <span class='date publication-date'>{{story.date|date:\"yyyy'.'MM'.'dd\"}}</span>\n\n          </div>\n\n          <div class='authors' ng-if=\"story.authors.length\">\n            by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n          </div>\n\n\n        </div>\n      </div>\n\n      <div class='row'>\n        <div class='col-md-12'>\n          <h1 rewording value='story.data.title' default='{{story.title}}'></h1>\n\n          <div class=\"pull-right\">\n<!--            <span ng-if=\"story.hitcount.read\" class=\"label label-default\">{{story.hitcount.read}}</span><span> Reads</span><span ng-if=\"story.hitcount.read && story.hitcount.download\">  </span> <span ng-if=\"story.hitcount.download\" class=\"label label-default\">{{story.hitcount.download}}</span><span> Downloads</span>-->\n            <div style=\"font-size: 11px\">\n              <span ng-if=\"story.hitcount.read\" style=\"margin-right: 2px\">Reads</span><span class=\"label label-default\">{{story.hitcount.read}}</span>\n              <span ng-if=\"story.hitcount.download\" style=\"margin-left: 15px; margin-right: 2px\">Downloads</span><span class=\"label label-default\">{{story.hitcount.download}}</span>\n            </div>\n          </div>\n\n          <!-- social share buttons: -->\n          <div ng-if='story.status == \"public\"' ng-include='\"templates/partials/story.socialshare.html\"|prefixTemplate'></div>\n\n          <!-- story reference and cite as buttons -->\n          <!-- <div embedit='story.data.issue' ng-if='story.data.issue' markdown='true' language='language'></div>\n          -->\n\n          <blockquote class='abstract' rewording markdown='inline' value='story.data.abstract' default='{{story.abstract}}'></blockquote>\n\n          <div class=\"tags keywords\">\n            <span ng-if=\"story._tags.keyword\" translate=\"keywords\" class='label'></span>\n            <span class='tag sans-serif' ng-repeat='tag in story._tags.keyword' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n          </div>\n          <div class='btn-line-group transparent toC'>\n            <button class='btn btn-line' ng-if='ToC.length' ng-click='toggleTableOfContents($event)'><span translate='table of contents'></span> <span class='icon icon-book-open'></span>\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n      <div ng-if='story._isBiography'>\n        <div class='container tight-container' >\n          <div class='row no-gutter biography-wrapper' >\n            <div class='col-sm-4' style='padding: 0' respect-sibling='next'>\n              <div ng-if='story.covers.length' class=\"main cover\" style='height: 100%' ng-repeat='document in story.covers'>\n                <div class='cover-oembed' rich-oembed fullscreen='fullsize(document.slug)' autoplay='true' oembed='document.data' media='document' quality='{{document.type==\"image\" || document.type==\"photo\"? \"hifi\":\"snapshot\"}}'></div>\n              </div>\n              <div ng-if='!story.covers.length' class=\"main cover\" style='height: 100%'>\n\n                <div class=\"lazy-cover\" style=\"background-position:{{story._biography.data.offsetx}} {{story._biography.data.offsety}};\" lazy-img=\"{{story._biography.data.url||story._biography.data.thumbnail_url}}\"></div>\n              </div>\n\n            </div>\n            <div class='col-sm-8' >\n              <div biography data='story._biography.data'></div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div ng-if='!story._isBiography && story.covers.length' class=\"main cover\" ng-repeat='document in story.covers'>\n        <div class='container tight-container'>\n\n          <div class='cover-oembed'  style='height: 400px' rich-oembed fullscreen='fullsize(document.slug)' autoplay='true' oembed='document.data' media='document' quality='{{document.type==\"image\" || document.type==\"photo\"? \"hifi\":\"snapshot\"}}'></div>\n\n          <!-- </div> -->\n\n          <!-- <div class='col-md-4'> -->\n          <div class='metadata-wrapper' ng-include='\"templates/partials/document.metadata.linear.html\"|prefixTemplate'></div>\n          <!-- </div> -->\n        <!-- </div> -->\n        </div>\n      </div>\n\n    <div class='container tight-container'>\n\n\n      <div class='row' style='margin-bottom: 100px'>\n        <div  ng-class='{\"col-md-12\": !sidedocuments, \"col-md-8 col-lg-7 col-xs-8\": sidedocuments}'>\n\n          <div style='position:relative' class=\"contents\">\n\n            <!-- contents of the story -->\n            <div id='contents' markdownit='story.contents' watchlanguage='true' language='language' listener='listener(event, data, callback)' settoc='setToC(ToC)' setdocs='setDocuments(items)'></div>\n\n            <!-- DOI / reference -->\n            <div class='ref' ng-if='story.data.reference'>\n              <span translate='ref' class='label'></span>\n              <a target='_blank' embedit='story.data.reference' markdown='true' language='language'></a>\n            </div>\n\n            <div class='ref' ng-if='story.data.doi'>\n              <span class='label' ng-if='story.data.doi' translate='doi'></span>\n              <a ng-if='story.data.doi' ng-href='https://doi.org/{{story.data.doi}}' target='_blank'><p>{{story.data.doi}}</p></a>\n            </div>\n            <!-- contains the commenter -->\n            <div ng-if='story.isWritable || story.isReviewable' rangy container tight-container='contents' highlights='story.highlights' commented='commented(error, comment)' target='story' actor='user' onCommentsSelected='commentsSelected(uids)'></div>\n\n\n          </div>\n        </div>\n        <div ui-view class='col-md-4 col-lg-5 col-xs-4' ng-if='sidedocuments' respect-previous-sibling update=\"documents\">\n          <div  sliding-steps data-language='language' data-focus='focusedIdx' style='height:100%' items='documents'></div>\n        </div>\n      </div>\n    </div>\n\n    <div  class='versioning' sticky >\n\n      <div ng-if='story.isWritable' class=\"btn-line-group transparent dropdown\">\n        <a class='btn-line' ng-click='loadVersions()' bs-dropdown placement='top-left' aria-haspopup=\"true\" aria-expanded=\"false\">\n          <span ng-if='state==\"story\"'>most recent version</span><span ng-if='state!=\"story\"'>version: {{story.version}}</span> <span class='icon icon-list'></span>\n        </a>\n\n        <ul class=\"dropdown-menu\" role=\"menu\">\n          <li ng-repeat='version in versions'>\n            <a ui-sref='storygit({id:story.slug, commit:version.tag})'>{{version.tag}} ({{version.date}})</a>\n          </li>\n          <li>\n            <a ui-sref='story({postId:story.slug})'>most recent version</a>\n          </li>\n        </ul>\n\n      </div>\n      <!-- <div>{{neighbors}}</div> -->\n      <div class=\"btn-line-group transparent black \" ng-if='neighbors.previous_sibling'>\n        <button class='btn-line' title='{{neighbors.previous_sibling.title}}'  ui-sref='story({postId:neighbors.previous_sibling.slug})'>\n          <span class='icon left icon-arrow-left-circle'></span>\n          <span class='truncate' rewording value='neighbors.previous_sibling.data.title' default='{{neighbors.previous_sibling.title}}'></span>\n        </button>\n      </div>\n      <div class=\"btn-line-group transparent black\" ng-if='neighbors.next_sibling'>\n        <button class='btn-line' title='{{neighbors.next_sibling.title}}' ui-sref='story({postId:neighbors.next_sibling.slug})'>\n          <span class='truncate' rewording value='neighbors.next_sibling.data.title' default='{{neighbors.next_sibling.title}}'></span>\n          <span class='icon icon-arrow-right-circle'></span>\n        </button>\n      </div>\n    </div>\n\n    <div marginalia whenvisible='loadComments()'></div>\n\n  </div>\n  <div class='responses' ng-if='story.isWritable || story.isReviewable'>\n    <div class='container tight-container' >\n      <div class='row' style='margin-bottom: 100px'>\n        <div class='col-md-12'>\n          <!-- comment list babe -->\n            <div  class='sliding-steps'>\n              <div class='step comment commenter-wrapper' commenter disable-close=\"true\" target=\"story\" disable-viewer=\"true\" actor=\"user\" commented=\"commented(error, comment)\"></div>\n\n              <div ng-repeat='comment in comments' ng-include='\"templates/partials/comment.html\"|prefixTemplate'></div>\n\n              <div class='more-wrapper'>\n                <div ng-if='comments.length > 0 && comments.length < commentsCount' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='moreComments()'>\n                    <span ng-if='!isLoadingComments'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: (commentsCount-comments.length)}\"></span>\n                    </span>\n                    <span ng-if='isLoadingComments' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n            </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n\n"),
$templateCache.put("/static/templates/tags.html",'<div class=\'container\'>\n<div class="view">\n<div class=\'row\'>\n<div class=\'col-lg-8\'>\n  <div>\n    <h1 translate="headline.publications.title"></h1>\n\n    <blockquote translate="headline.publications.abstract"></blockquote>\n\n    </div>\n  </div>\n</div>\n\n\n<!-- Nav tabs -->\n<ul class=\'nav nav-tabs\'>\n  <li role="presentation" ui-sref-active="active" >\n    <a href ui-sref=\'publications.all\' aria-controls="home" role="tab" data-toggle="tab" translate="state.publications.all.label"></a>\n  </li>\n  <li ng-repeat=\'link in urls\' role="presentation" ui-sref-active="active">\n    <a href ui-sref=\'publications.{{link.name}}\' aria-controls="home" role="tab" data-toggle="tab" translate="state.publications.{{link.name}}.label"></a>\n  </li>\n  <li ng-if=\'slug\' role="presentation" ui-sref-active="active" >\n    <a href ui-sref=\'publications.tags({slug: slug})\' aria-controls="home" role="tab" data-toggle="tab">/filter: <b>{{slug}}</b>/</a>\n  </li>\n</ul>\n\n\n<div ui-view></div>\n</div>\n</div>'),$templateCache.put("/static/templates/upload.html",'<div class=\'container\'>\n<div class=\'view\'>\n<div class="row">\n  <div class="col-lg-8">\n    <div>\n      <h1 translate="upload.title" class="ng-scope">Publications</h1>\n\n      <blockquote translate="upload.description" class="ng-scope"></blockquote>\n\n      </div>\n    </div>\n  </div>\n</div>\n \n\n<div ngf-no-file-drop>File Drag/Drop is not supported for this browser</div>\n\n<div class=\'drop-box-form-wrapper\'>\n  <form name="createForm" novalidate class="simple-form">\n    <label>\n      <span class="number" ng-class=\'{"active": createForm.utitle.$valid, "error": createForm.utitle.$dirty && !createForm.utitle.$valid}\'>1</span>\n      <span translate="field.label.upload.title"></span>\n    </label>\n    <textarea id=\'draft-title\' class=\'elastic-textarea\' rows="1" msd-elastic ng-model=\'uploadable.title\' name=\'utitle\' required type=\'text\' placeholder=\'Untitled\'></textarea>\n    \n    <label>\n      <span class="number" ng-class=\'{"active": createForm.uabstract.$valid, "error": createForm.uabstract.$dirty && !createForm.uabstract.$valid}\'>2</span>\n      <span translate="field.label.upload.abstract"></span>\n    </label>\n    <textarea id=\'draft-abstract\' class=\'elastic-textarea\' rows="1" msd-elastic ng-model=\'uploadable.abstract\' name=\'uabstract\' required type=\'text\' placeholder=\'abstract\'></textarea>\n\n    <label>\n      <span class="number" ng-class=\'{"active": uploadable.size}\'>3</span>\n      <span translate="field.label.upload.docx"></span>\n    </label>\n    <div ng-show=\'!uploadable.size\'>\n    <div ngf-drop ngf-select ng-model="docx" class="drop-box sans-serif" \n    ngf-drag-over-class="\'dragover\'" ngf-multiple="false" ngf-allow-dir="true"\n    accept="application/vnd.openxmlformats-officedocument.wordprocessingml.document" \n    ngf-pattern="application/vnd.openxmlformats-officedocument.wordprocessingml.document">Drop docx or click to upload</div>\n    </div>\n    <div ng-if="uploadable.size" class="uploadable">\n      <span class=\'icon-doc\'></span> \n      <span class=\'sans-serif\'>{{uploadable.name}}</span>\n      <span class="size">{{uploadable.size}}</span>\n    </div>\n\n    <div class=\'button-wrapper\'>\n      <span class="number" ng-class=\'{"active": createForm.$valid && uploadable.size}\'>4</span>\n      <div class=\'btn-line-group\' ng-class=\'{"primary": createForm.$valid && uploadable.size}\'>\n        <button class=\'btn-line\' type="submit" ng-click="upload()">\n          <span ng-if=\'createForm.$valid && uploadable.size\' translate=\'button.upload.story\'></span>\n          <span ng-if=\'!createForm.$valid || !uploadable.size\' translate-values=\'{ steps: (3 - +createForm.utitle.$valid - +createForm.uabstract.$valid - +!!uploadable.size)}\' translate=\'upload.missing.steps\'></span>\n        </button>\n      </div>\n    </div>\n    \n  </form>\n  \n</div>\n</div>\n</div>'),$templateCache.put("/static/templates/uploaded.html",'<div class="row">\n  <div class="col-lg-8">\n    <div>\n      <h1 translate="upload.success.title" class="ng-scope">Your content has been submitted</h1>\n\n      <blockquote translate="upload.success.description" class="ng-scope"></blockquote>\n\n      <div ng-include=\'"templates/partials/story.html"|prefixTemplate\'></div>\n\n      </div>\n    </div>\n  </div>\n</div>'),$templateCache.put("/static/templates/writings.compare.diff.html","<div codediff diff='diff' raw='story.contents'></div>"),$templateCache.put("/static/templates/writings.compare.html","<div style='position:relative; margin-top: 50px' class=\"contents versioned\" ng-class='{\"current\": version.version == story.version}'>\n  <div ng-if=\"version.version == story.version\">This is the current displayed version.</div>\n  <div class='log-version' ng-repeat='tag in version.logs'>\n    <span class='tag-version' >{{tag.tag}}</span>\n    <span class='date'> {{tag.date|date:\"yyyy'.'MM'.'dd\"}}</span> &mdash;<span class='message'> <span ng-if='user.username != tag.username'><b class='username'>{{tag.username}}</b>  &mdash;</span> \"{{tag.message}}\"</span>\n  </div>\n  <div class='actions'>\n    <div class='btn-line-group red transparent'>\n      <button class='btn-line mini' ui-sref='writing.compare.diff({storyId: story.slug, tag: version.version})' ng-class='{active: state==\"writing.compare.diff\"}'><span translate='diff'></span></button>\n      <button class='btn-line mini' ng-class='{active: state==\"writing.compare\"}' ui-sref='writing.compare({storyId: story.slug, tag: version.version})'><span translate='source' ></span></button>\n      <button class='btn-line mini' ui-sref='writing.compare.preview({storyId: story.slug, tag: version.version})' ng-class='{active: state==\"writing.compare.preview\"}'><span translate='preview' ></span></button>\n    </div>\n  </div>\n  <div class='ui-view'>\n    <div codediff raw='version.contents'></div>\n    <!-- <div class='ready' id='versioned-contents' markdownit='version.contents' watchlanguage='true' language='language'></div>\n    <div rangy container='versioned-contents' highlights='story.highlights' commented='commented(error, comment)' target='story' actor='user' onCommentsSelected='commentsSelected(uids)'></div> -->\n  </div>\n</div>\n"),$templateCache.put("/static/templates/writings.compare.preview.html","<div class='ready' id='versioned-contents' markdownit='version.contents' watchlanguage='true' language='language'></div>\n    <div rangy container='versioned-contents' highlights='story.highlights' commented='commented(error, comment)' target='story' actor='user' onCommentsSelected='commentsSelected(uids)'></div>"),$templateCache.put("/static/templates/writings.html","<div class='container tight-container'>\n<div class='view'>\n\n<!-- <span class='btn-line-group'><button class='btn-line active' ng-click='save()'>{{isSaving? \"saving...\":\"save\"}}</button></span> -->\n\n\n<div class=\"row\">\n  <div class='col-sm-8'>\n    <label>\n      <span translate=\"field.label.author\"></span>\n    </label>\n    <tags-input class='tags-input' on-tag-added='attachAuthor($tag)' on-tag-removed='detachAuthor($tag)' key-property='id' display-property='fullname' placeholder='Add an author' ng-model=\"story.authors\" template='{{\"templates/partials/author.input.html\"|prefixTemplate}}'>\n      <auto-complete source=\"suggestAuthors($query)\" template='{{\"templates/partials/author.autocomplete.html\"|prefixTemplate}}'></auto-complete>\n    </tags-input>\n\n    <label>\n      <span translate=\"field.label.title\"></span>\n    </label>\n    <textarea id='draft-title' class='elastic-textarea' rows=\"1\" msd-elastic ng-model='title'   type='text' placeholder='Untitled'></textarea>\n    <label></label>\n    <label>\n      <span translate=\"field.label.abstract\"></span>\n    </label>\n    <textarea id='draft-abstract' class='elastic-textarea' rows=\"1\" msd-elastic ng-model='abstract' type='text' placeholder='abstract'></textarea>\n\n    <div ng-repeat='tagField in tagFields|filter:{relevance:\"primary\"}' ng-include='\"templates/partials/tags.input.html\"|prefixTemplate'></div>\n\n  </div>\n  <div class='col-sm-4'>\n\n    <div class='cover-preview-wrapper'>\n      <label translate=\"field.label.cover\"></label>\n      <div class=\"cover-preview\" ng-repeat=\"document in story.covers\">\n        <div ng-if='document.data'>\n          <div lazy-img='{{document|coverage}}' class='lazy-box'></div>\n\n          <div class='tile'>\n            <div class='title' embedit='document.data.title' language='language'></div>\n            <div class='copyright' embedit='document.data.copyright'></div>\n            <div class='btn-line-group transparent'>\n              <button class='btn-line' ng-disabled='!story.covers.length' ng-click='\n              removeCover(document)' translate=\"button.removecover\"></button>\n            </div>\n          </div>\n        </div>\n\n      </div>\n      <div class=\"center\">\n        <div class='btn-line-group' style='width: 100%'>\n          <button   class='btn-line' ng-click='\n            openCoversModal()' translate=\"button.choosecover\"></button>\n        </div>\n      </div>\n    </div>\n\n    <div ng-if='user.is_staff'>\n      <!-- doi -->\n      <label>\n        <span translate=\"field.label.doi\"></span>\n      </label>\n      <div>\n      <span>{{story.data.doi}}</span>\n        <div class='btn-line-group transparent'><button class='btn-line' ng-click='openSaveDoiModal()' translate='button.createorupdate' translate-values='{create: !story.data.doi}'></button></div>\n      </div>\n      <!-- citation -->\n      <label>\n        <span translate=\"field.label.issue\"></span>\n      </label>\n      <textarea class='elastic-textarea' rows=\"1\" msd-elastic ng-model='story.data.issue' type='text' placeholder='issue n.'></textarea>\n\n\n      <!-- citation -->\n      <label>\n        <span translate=\"field.label.reference\"></span>\n      </label>\n      <textarea class='elastic-textarea' rows=\"1\" msd-elastic ng-model='story.data.reference' type='text' placeholder='reference'></textarea>\n\n\n      <!-- <label translate=\"staff.drafts.tags.placeholder\"></label>\n      <tags-input class='tags-input'  on-tag-added='attachTag($tag)' on-tag-removed='detachTag($tag)' key-property='id' display-property='name' ng-model=\"displayedTags\" add-from-autocomplete-only=\"true\">\n          <auto-complete template='{{\"templates/partials/tag.autocomplete.html\"|prefixTemplate}}' source=\"suggestTags($query, {category__in:['blog','writing', 'highlights', 'publishing']}, false)\" ></auto-complete>\n      </tags-input> -->\n    </div>\n\n    <!-- tags placeholder  -->\n    <div ng-repeat='tagField in tagFields|filter:{relevance:\"secondary\"}' ng-include='\"templates/partials/tags.input.html\"|prefixTemplate'></div>\n\n  </div>\n</div>\n\n\n<div class='actions'>\n  <!-- <div ng-if='metadata.owner.is_staff' class='btn-line-group'> -->\n\n  <div class='btn-line-group' ng-if='!isDraft && id'>\n    <button ng-if='!collection' class='btn-line' ui-sref=\"story({postId: story.slug})\" translate=\"button.viewmode\"></button>\n    <button ng-if='collection' class='btn-line' ui-sref=\"story.story({postId: collection, chapterId: story.slug})\" translate=\"button.viewmode\"></button>\n  </div>\n\n  <div class='btn-line-group primary'>\n    <button ng-if='!isDraft' ng-click='save()' class='btn-line'><span ng-if='!isSaving' translate=\"button.save\"></span><span ng-if='isSaving' translate=\"button.issaving\"></span></button>\n    <button ng-if='isDraft' ng-click='save()' class='btn-line'><span translate=\"button.create\"></span></button>\n\n\n\n  </div>\n  <!-- </div> -->\n\n</div>\n\n\n\n<!-- <div class='authors' ng-if='!isDraft'>\nby <a href>{{metadata.owner.username}}</a>\n</div>\n<div class='authors' ng-if='isDraft'>\n  <div ng-if='user.username'>\n    by <a href>{{user.username}}</a>\n  </div>\n  <div ng-if='!user.username'>\n    by <a href>anonymous</a>\n  </div>\n</div> -->\n\n<!-- <div ng-if='!isDraft'>\n  <form class=\"form-inline\">\n    <div class=\"form-group\">\n      <label translate='date'></label>\n      <input type=\"text\" class=\"form-control\" ng-model=\"date\" name=\"date\" data-max-date=\"today\" timezone='UTC' bs-datepicker data-autoclose=\"1\">{{date}}\n    </div>\n  </form>\n</div> -->\n\n</div>\n</div>\n\n<div class='fluid-container' style='padding: 0 50px 50px 100px; background: #efefef; overflow: hidden; position: relative'>\n  <div class='toolbox' sticky offset='70'>\n\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"strong\") != -1?\"active\": \"\"}}' ng-click='toolboxing(\"toggleBold\")'>B</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"em\") != -1?\"active\": \"\"}}' style='font-style:italic' ng-click='toolboxing(\"toggleItalic\")'>I</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"header-1\") != -1?\"active\": \"\"}}' ng-click='toolboxing(\"toggleHeading1\")'>H1</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"header-2\") != -1?\"active\": \"\"}}' ng-click='toolboxing(\"toggleHeading2\")'>H2</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"header-3\") != -1?\"active\": \"\"}}' ng-click='toolboxing(\"toggleHeading3\")'>H3</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"quote\") != -1?\"active\": \"\"}}' ng-click='toolboxing(\"toggleBlockquote\")'>Q</button>\n      &nbsp;&nbsp;\n      <div class='btn-line-group  transparent'>\n        <button class='btn-line' ng-click='save()'><span translate='button.save'></span> <span class='icon icon-disc'></span></button>\n        <button ng-click='openSaveVersionModal()' class='btn-line'><span translate=\"button.saveversion\"></span> <span class='icon icon-pin'></span></button>\n      </div>\n\n\n      <div class='float-right btn-line-group dropdown'>\n\n        <button class='btn-line' ng-class='{\"active\": state==\"writing\"}' ui-sref='writing({postId:story.slug})'><span translate='button.wmodenormal'></span></button>\n        <button class='btn-line' ng-class='{\"active\": state==\"writing.live\"}' ui-sref='writing.live({postId:story.slug})'><span translate='button.wmodepreview'></span></button>\n        <button class='btn-line dropdown' ng-class='{\"active\": state==\"writing.compare\" || state==\"writing.compare.diff\"}' ng-click='loadVersions()' bs-dropdown placement='bottom-right' aria-haspopup=\"true\" aria-expanded=\"false\" ><span translate='button.wmodecompare'></span> <span class='icon icon-list'></span></button>\n        <ul class=\"dropdown-menu\" role=\"menu\">\n          <!-- <li>\n            {{story.version}}\n          </li> -->\n          <li class='version' ng-repeat='version in versions'>\n            <div ng-repeat='tag in version.tags'>\n              <a class='tag-version' ui-sref='writing.compare({postId:story.slug, tag:version.hexsha})'>{{tag.tag}}</a>\n              <span class='date'>{{tag.date|date:\"yyyy'.'MM'.'dd\"}}</span>\n              <div>\n                <blockquote><span class='username'>{{tag.username}}</span> &mdash; {{tag.message}}</blockquote>\n              </div>\n            </div>\n          </li>\n        </ul>\n      </div>\n\n      <span class='float-right label'>writing mode:</span>\n\n      <!-- <button style='width:70px' class='sans-serif btn {{isPreviewEnabled? \"active\": \"\"}}' ng-click='action(\"togglePreview\")'>preview</button>\n\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"link\") != -1|| activeStates.indexOf(\"url\") != -1? \"active\": \"\"}}' ng-click='showReferenceModal()'><span class='icon-plus'></span></button> -->\n      <!-- {{activeStates}} -->\n\n  </div>\n  <!-- end of toolbox -->\n\n  <div class='row'>\n    <!-- <a ui-sref=\"writing.compare({storyId: story.slug, tag:'lof'})\">ooooooooo</a> -->\n\n    <div ng-class='{\"col-xs-6\": state !=\"writing\", \"col-xs-12\":state ==\"writing\"}' id=\"draft-contents\">\n\n      <div class='contents' style='margin-top: 50px; min-height: 50px; position:relative'>\n          <!-- <medium-editor ng-model='contents' bind-options=\"mediumOptions\"></medium-editor> -->\n          <div class='log-version' ng-if='story.logs.length' ng-repeat='tag in story.logs'>\n            <span class='tag-version' >{{tag.tag}}</span>\n            <span class='date'> {{tag.date|date:\"yyyy'.'MM'.'dd\"}}</span> &mdash; {{tag.message}}\n          </div>\n\n          <div class='log-version' ng-if='!story.logs.length'>\n            <span class='tag-version' >{{story.version}}</span>\n            <span class='date'> {{story.date_last_modified|date:\"yyyy'.'MM'.'dd\"}}</span>\n          </div>\n          <div mde='contents' style='margin-top:1px' language='language' setdocs='setDocuments(documents)' setmarked='setMarked(marked)' settoc='setToC(items)'></div>\n\n      </div>\n    </div>\n    <div ui-view ng-class='{\"col-xs-6\": state !=\"writing\", \"col-xs-12\":state ==\"writing\"}'><!-- 'nothing here babe' {{state}} --></div>\n    <!-- <div class='col-md-4 col-lg-5 col-xs-4' respect-previous-sibling update=\"sideItems\">\n      <div sliding-steps data-language='language' data-focus='focusedIdx' style='height:100%' items='sideItems'></div>\n    </div> -->\n    <!-- <div class='col-xs-6' style='padding-left:0'>\n      <div class='contents' id='contents' markdownit='marked' watchmarkdownit='true' watchlanguage='true' language='language' listener='listener(event, data, callback)'></div>\n      <div rangy container='contents' highlights='story.highlights' commented='commented(error, comment)' target='story' actor='user' onCommentsSelected='commentsSelected(uids)'></div>\n    </div> -->\n  </div>\n</div>\n\n\n\n"),$templateCache.put("/static/templates/writings.live.html","<div style='position:relative; margin-top: 50px' class=\"contents versioned\">\n  <div class='log-version current'>\n    <span class='tag-version'><span translate=\"preview\"></span></span>\n    <span class='date'>{{story.date_last_modified|date:\"yyyy'.'MM'.'dd\"}} ({{story.version}})</span>\n  </div>\n  <div class='ready' id='versioned-contents' markdownit='marked'  watchmarkdownit='true' watchlanguage='true' language='language'></div>\n</div>\n"),$templateCache.put("/static/templates/partials/action.html","<div class=\"stream-item\">\n  <span class='date'>{{action.timesince}}</span>\n  <span class='username'>{{action.actor.username}}</span>\n  <span translate='verb.{{action.verb}}'></span>\n  <a ng-if=\"action.target_content_type == 'story'\" ui-sref='story({postId: action.target.slug})'>{{action.target.title}}</a>\n  <a ng-if=\"action.target_content_type == 'document'\">document: {{action.target.title}}</a>\n  <div class='comment serif' ng-if='action.verb==\"commented\"' ng-click='rangyHighlight(action.info.comment.short_url)' rangy-highlight='{{action.info.comment.short_url}}'>\n    <span class='quote' ng-if='action.info.comment.contents.quote' max-words='4' commenter-quote='action.info.comment.contents.quote'></span>\n    <div max-words='5' commenter-quote='action.info.comment.contents.content'></div>\n  </div>\n\n</div>\n"),$templateCache.put("/static/templates/partials/author.autocomplete.html","<div class=\"item selectable sans-serif\" title='{{data.fullname}} - {{data.affiliation}}'>\n  <span rewording value='data.data.fullname' default='{{data.fullname}}' highlight='$highlight(text)'></span>\n  <br/>\n  <span class='description'>{{data.affiliation}}</span>\n  <!-- <span ng-bind-html=\"$highlight($getDisplayText())\"></span> -->\n</div>"),$templateCache.put("/static/templates/partials/author.html","<a class='author' ui-sref='author.publications.all({slug:author.slug})'>{{author.fullname}}</a>{{$last? '':', '}}"),$templateCache.put("/static/templates/partials/author.input.html","<span>\n  <span>{{data.fullname}}</span>\n  <span ng-if='data.affiliation.length > 0'>&mdash;\n    <span class='type'>{{data.affiliation|tokenize:4}}</span>\n  </span>\n  <a class=\"remove-button\" ng-click=\"$removeTag()\" ><span class='icon-close'></span></a>\n</span>"),$templateCache.put("/static/templates/partials/author.item.html","<div class='item stream-item'>\n <a class='author' ui-sref='author.publications.all({slug:author.slug})'>{{author.fullname}}</a>\n <div class='affiliation sans-serif'>{{author.affiliation}}</div>\n \n <blockquote class='reduced'><span embedit='author.data.biography || \"...\"' excerpt='true'></span> <a ui-sref='author.publications.all({slug:author.slug})'><span class=\"icon-arrow-right-circle\"></span></a></blockquote>\n</div>"),$templateCache.put("/static/templates/partials/breakingNews.html","<div class=\"wrapper\" style='    background-size: cover; background-image: url({{news.cover_url}})'>\n  <div class='overlay'>\n    <div class=\"type\">\n      <span ng-repeat='tag in news.tags | filter:{ category: \"writing\" }' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n    </div>\n    <h3><a ng-if='!news.isCollection' ui-sref=\"story({postId: news.slug})\" rewording value='news.data.title' default='{{news.title}}'></a><a ng-if='news.isCollection' ui-sref=\"collection({collectionId: news.slug})\" rewording value='news.data.title' default='{{news.title}}'></a></h3>  \n  </div>\n</div>"),$templateCache.put("/static/templates/partials/collection.html","<!-- <div ng-if='!$first' class=\"divider\"></div> -->\n<div class=\"story collection lite\">\n  \n  <div class=\"row\">\n    <div class=\"col-md-4\" ng-if='story.covers.length'>\n      <div  ng-repeat='document in story.covers' class='fluid-container relative'>\n        <div class='image-wrapper cover' lazy-img='{{document|coverage}}'></div>\n        <div class='embedded-metadata' ng-include='\"templates/partials/document.metadata.embedded.html\"|prefixTemplate'></div>\n      </div>\n    </div>\n\n    <div ng-class='story.covers.length?\"col-md-8\": \"col-md-12\"'>\n      <div class=\"divider\"></div>\n  \n      <div class=\"tags\" ng-if=\"story.tags.length\">\n        <span class='tag' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n      </div>\n      <!-- <div class=\"date\">{{story.date_created|date:'mediumDate'}}</div> -->\n      \n      <h3 class=\"title\"><a ui-sref=\"story({postId: story.slug})\"><span rewording value='story.data.title' default='{{story.title}}'></span> {{story.status != 'public'? '(DRAFT)': ''}}</a></h3>  \n      \n      <div class='authors' ng-if=\"story.authors.length\">\n        <span translate='by'></span> <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </div>\n      <blockquote ng-if='story.excerpt' class=\"reduced\"><span ng-bind-html='story.excerpt'></span>\n        <a href ui-sref=\"story({postId: story.slug})\">\n          <span class='icon-arrow-right-circle'></span>\n        </a>\n        <p>\n          <em ng-if=\"story.difference\">{{story.difference}}</em>\n        </p>\n      </blockquote>\n      \n      <blockquote ng-if='!story.excerpt' rewording value='story.data.abstract' markdown='inline' default='{{story.abstract}}'></blockquote>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/comment.html","<div class='step comment' ng-click='comment.unread = false' ng-class='{\"owned\": user.username == comment.owner.username, \"unread animated pulse\": comment.unread}'>\n  <div class='status float-right'><span translate='comment.status.{{comment.status}}'></span><div><a ng-href='/admin/miller/comment/{{comment.pk}}/change/' target='_blank'>edit (admin)</a></div>\n  </div>\n  <div class='username'>{{comment.owner.username}}</div>\n  <div class='date'>{{comment.date_created|date:\"yyyy'.'MM'.'dd hh:mm\"}}</div>\n  <div ng-if='!quote' class='quote' rangy-highlight='{{comment.short_url}}'>\n    <span  commenter-quote='comment.contents.quote'></span>\n  </div>\n  <div class='contents' embedit='comment.contents.content' markdown='inline'></div>\n  <div ng-if='user.username == comment.owner.username' class='actions'>\n    <div class='btn-line-group primary transparent'>\n      <button  class='btn-line' ng-click='removeComment(comment)' ng-disabled='isLoading'><span translate='button.comment.remove' translate-values='isLoading'></span> <span class='icon icon-bin'></span></button>\n    </div>\n  </div>\n</div>    "),$templateCache.put("/static/templates/partials/coverstory.html","<div class=\"coverstory story lite\">\n  \n    <div class='col-xs-6 col-sm-4'>\n      <div ng-if='coverstory.covers.length' ng-repeat='document in coverstory.covers' class='cover-wrapper row'>\n      <div class='cover-oembed' rich-oembed fullscreen='fullsize(document.slug)' autoplay='true' oembed='document.data' media='document' immediate quality=\"hifi\"></div>\n        <!-- <div class='cover' style='background-size: cover; height:300px; background-image:url({{coverstory.cover}})' ></div> -->\n      </div>\n    </div>\n    <div class='col-xs-6 col-sm-8'>\n      <div class=\"tags\" ng-if=\"coverstory.tags.length\">\n        <span class=\"tag\" ng-repeat='tag in coverstory.tags|filter:{ category: \"writing\" }' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n      </div>\n      <div class=\"issue\" embedit='coverstory.data.issue' ng-click='next()'></div>\n       \n      <h3>\n        <a ng-if='!story.is_collection' href ui-sref=\"story({postId: coverstory.slug})\" embedit='coverstory.data.title' language='language'></a>\n        <a ng-if='story.is_collection' href ui-sref=\"collection({collectionId: coverstory.slug})\" embedit='coverstory.data.title' language='language'></a>\n      </h3>\n      <div class='authors' ng-if=\"coverstory.authors.length\">\n        by <span ng-repeat='author in coverstory.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </div>\n      <blockquote>\n        <span embedit='coverstory.excerpt' language='language'></span>\n        <a ng-if='!coverstory.is_collection' href ui-sref=\"story({postId: coverstory.slug})\"><span class='icon-arrow-right-circle'></span></a>\n        <a ng-if='coverstory.is_collection' href ui-sref=\"collection({collectionId: coverstory.slug})\"><span class='icon-arrow-right-circle'></span></a>\n      </blockquote>\n    </div>\n    \n    <div style='clear:both'></div>\n</div>"),$templateCache.put("/static/templates/partials/crossref.html","<div ng-class='{\"active\": selectedDocument.doi == item.doi}' class='doc crossref oembedded' ng-click='selectDocument(item)'>\n  <div class='wrapper'>\n    <div class='lazy-box'></div>\n    <div class='tile'>\n      <div class='title' embedit='item.fullCitation'></div>\n      <div class='copyright'>\n        <a ng-href='{{item.doi}}' target='_blank'>{{item.doi}}</a>\n      </div>\n    </div>\n  </div>\n  <div class='excerpt'><span ng-if='item.year'><span class='type'>{{item.year}}</span> &mdash; </span> <span embedit='item.title'></span></div>\n</div>"),$templateCache.put("/static/templates/partials/document.html","<div class='doc doc-{{document.type}} {{document.isSelected?\"active\":\"\"}} orientation-{{document.data.layout.orientation||\"landscape\"}} caption-align-{{document.data.layout.caption_align||\"center\"}} size-{{document.data.layout.size||\"cover\"}}' ng-click='selectDocument(document)'>\n  <div class='switch' ng-if='document.type==\"image\" || document.type==\"rich\" || document.type==\"video\" || document.type==\"photo\"' rich-oembed fullscreen='fullsize(document.slug)' oembed='document.data' media='document' quality='{{quality}}'></div>\n\n  <div class='switch timeline' ng-if='document.type==\"timeline\"' stretch='true' embedit='document.data.html'></div>\n\n  <div class='switch' ng-if='document.type==\"picture\"' style='height: 400px; width:100%; background-position: center; background-color: #151515; background-size:contain; background-repeat: no-repeat;' lazy-img='{{document.src}}'></div>\n\n  <div ng-if='document.data' ng-include='\"templates/partials/document.metadata.html\"|prefixTemplate'></div>\n\n      <!-- this element has fixed height. -->\n      <div ng-if='document.type==\"video-cover\"'>\n        <div class='caption reference' markdown='document.data.reference.fr'></div>\n        <div class='copyright'>{{document.copyrights}}</div>\n      </div>\n\n      <div ng-if='document.type==\"pdf\"' lazy-image src='document.snapshot'></div>\n    \n      <blockquote ng-if='document.citation' markdown='document.citation'></blockquote>\n      \n      <div ng-if='!document.data'>\n        <div ng-if='document.title' class='title'>{{document.title}}</div>\n        <div ng-if='document.caption' class='caption'>{{document.caption}}</div>\n        <div ng-if='document.copyrights' class='copyright'>{{document.copyrights}}</div>\n      </div>\n\n      <div ng-if='document.type==\"bibtex\"'>\n        <div class='caption'>\n          <span ng-if='document.data.author'>{{document.data.author|bibtex}},</span>\n          <span ng-if='document.data.editor'>{{document.data.editor|bibtex}}</span>(edited by)</span> \n          \n          <em>{{document.data.title|bibtex}}</em>\n          <span>{{document.data.publisher|bibtex}}</span>\n          <span ng-if='document.data.year'>, <span>{{document.data.year|bibtex}}</span> \n        </div>\n      </div>\n\n      <div ng-if='document.type!=\"bibtex\" && document.data.title'>\n        <div class='caption' markdown='document.data.title'></div>\n        <div ng-if='document.data.reference' class='caption reference' markdown='document.data.reference'></div>\n        <div ng-if='document.data.copyright' class='copyright' markdown='document.data.copyright'></div>\n        <div ng-if='document.data.author_name' class='copyright'>\n          <a ng-href='{{document.data.author_url}}' target='_blank' markdown='document.data.author_name'></a>\n        </div>\n      </div>\n\n    </div>"),$templateCache.put("/static/templates/partials/document.metadata.embedded.html","<span class='oneline'><em ng-if='document.data.title' embedit='document.data.title' language='language' firstline='true'></em>\n<em ng-if='!document.data.title && document.title' embedit='document.title' language='language' firstline='true'></em>\n\n<span ng-if='document.data.author_name'>\n  <span translate='by'></span>\n  <a ng-href='{{document.data.author_url}}' target='_blank'>{{document.data.author_name}}</a>\n</span>\n</span>"),$templateCache.put("/static/templates/partials/document.metadata.html","<div class='metadata {{document.type}}'>\n  <div ng-if='!document.data.details.title'>\n    <button class='btn btn-line' ng-if='document._type == \"doc\"||document._type == \"voc\"' ng-click='alignTo(document._index, $event)'>\n      <span class='icon icon-type-{{document.type||document._type}}'></span><span class='type {{document.type}}'></span>\n    </button>\n    <span ng-if='document.type!=\"link\" && document.type!=\"crossref\"' class='title' embedit='document.data.title' language='language'></span>\n\n    <span ng-if='document.type==\"crossref\"'>\n      <span embedit='document.data.fullCitation' markdown='inline'></span> &mdash; <a ng-href='{{document.data.doi}}'>{{document.data.doi|smartUrl}}</a>\n    </span>\n\n    <a ng-if='document.type==\"link\"' target='_blank' ng-href='{{document.data.url}}'><span class='title' embedit='document.data.title' language='language'></span></a>\n    <a ng-if='document.type==\"entity\" && document.data.wiki_id' target='_blank' ng-href='https://dbpedia.org/page/{{document.data.wiki_id}}'><span class='title'><span translate='cfr'></span> dbpedia</a>\n    \n    <div ng-if='document.data.abstract'  class='abstract'>\n      <span embedit='document.data.abstract' language='language'></span>\n      \n    </div>\n    <div>\n      <div ng-if='document.data.type==\"link\" && document.data.thumbnail_url' class='snapshot' lazy-img='{{document.data.thumbnail_url}}'></div>\n      \n      <div ng-if='document.data.caption' class='caption' embedit='document.data.caption' language='language'></div>\n      <div ng-if='!document.data.caption && document.data.description' class='caption' embedit='document.data.description' language='language'></div>\n    </div>\n    <div style='clear:both' ng-if='document.data.copyright' embedit='document.data.copyright' language='language' firstline='true'></div>\n  </div>\n  \n  <!-- having details -->\n  <div ng-if='document.data.details.title'>\n    <button class='btn btn-line' ng-if='document._type == \"doc\"||document._type == \"voc\"' ng-click='alignTo(document._index, $event)'>\n      <span class='icon icon-type-{{document.type||document._type}}'></span>\n    </button>\n    <span class='title' embedit='document.data.details.title || document.data.title' language='language'></span>\n    <div class='caption' embedit='document.data.details.caption' language='language'></div>\n    <div class='copyright' ng-if='document.data.details.copyright' embedit='document.data.details.copyright' language='language' firstline='true'></div>\n  </div>\n\n   \n  <!-- author part -->\n  <div>\n    <span ng-if='document.data.author_name'>\n      <span translate='author'></span>\n      <a ng-href='{{document.data.author_url}}' target='_blank'>{{document.data.author_name}}</a>\n    </span>\n    <span ng-if='document.data.provider_name'>\n      <span translate='source'></span>:\n      <a ng-href='{{document.data.provider_url}}' target='_blank'>{{document.data.provider_name}}</a>\n    </span>\n  </div>\n  \n  <a ng-if='user.is_staff' target='_blank' ng-href='/admin/miller/document/{{document.document_id || document.id}}/change/'>modify (admin)</a>\n  <!-- <button ng-if='document.type != \"link\"' ng-click='fullsize(document.slug, document._type )' >preview</button> -->\n  \n</div>"),
$templateCache.put("/static/templates/partials/document.metadata.linear.html","<div class='metadata {{document.type}}'>\n  <em ng-if='document.data.title' embedit='document.data.title' language='language' firstline='true'></em>\n  <em ng-if='!document.data.title && document.title' embedit='document.title' language='language' firstline='true'></em>\n\n  <span ng-if='document.data.author_name'>\n    <span translate='by'></span>\n    <a ng-href='{{document.data.author_url}}' target='_blank'>{{document.data.author_name}}</a>\n  </span>\n  <span ng-if='document.data.provider_name'>\n    (<span translate='source'></span>:\n    <a ng-href='{{document.data.url || document.data.provider_url}}' target='_blank'>{{document.data.provider_name}}</a>)\n  </span>\n\n<span ng-if='document.data.copyright' embedit='document.data.copyright' language='language' firstline='true'></span>\n<span ng-if='user.is_staff' >&mdash; <a target='_blank' ng-href='/admin/miller/document/{{document.document_id || document.id}}/change/'>modify (admin)</a></span>\n</div>"),$templateCache.put("/static/templates/partials/hold.html","<div>\n  <span embedit='resource.metadata.title' language='language'></span>\n  <span ng-if='resource.metadata.abstract' embedit='resource.metadata.abstract' language='language'></span>\n  <span ng-if='resource.metadata.description' embedit='resource.metadata.description' language='language'></span>\n</div>"),$templateCache.put("/static/templates/partials/loader.html",'<div class="loader" ng-class=\'{"active":isLoading}\'>\n  <div class="dot"></div>\n  <div class="dot"></div>\n  <div class="dot"></div>\n</div>'),$templateCache.put("/static/templates/partials/more.html","<div class='more-wrapper'>\n  <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n    <button class='btn-line' ng-click='more()'>\n      <span ng-if='!tab.isLoadingNextItems'>\n        <span translate='button.more'></span>\n        <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n      </span>\n      <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n    </button>\n  </div>\n  <!-- when count equals item length, we are at the end -->\n</div>"),$templateCache.put("/static/templates/partials/oembed-search-results.html","<div class='oembedded doc doc-{{document.type}}' ng-class='{\"active\": document.url == selectedDocument.url}' ng-click='selectDocument(document)'>\n\n  <!-- <div class='divider'>&nbsp;</div> -->\n  \n  <div class='wrapper'>\n    <div ng-if='document.urls.Preview' lazy-image src='document.urls.Preview'></div>\n    <div class='tile'>\n      <div class='title' embedit='document.data.title' languagle='language'></div>\n      <div class='copyright' embedit='document.copyright'></div>\n    </div>\n  </div>\n  <div class='excerpt' embedit='document.title'></div>\n</div>"),$templateCache.put("/static/templates/partials/pulsations.html","<div class=\"popover\" tabindex=\"-1\">\n  <div class=\"arrow\"></div>\n  <h3 class=\"popover-title\">\n    <span  ng-bind=\"title\" ng-show=\"title\"></span>\n    <div class='btn-line-group primary transparent float-right'>\n      <button class='btn-line ' translate='button.clearlist' ng-click='resetPulsations()'></button>\n    </div>\n  </h3>\n  <div ng-include='\"templates/partials/loader.html\"|prefixTemplate'></div>\n  <div class='stream-items'>\n    <div ng-repeat='action in pulsations' ng-include='\"templates/partials/action.html\"|prefixTemplate'></div>\n  </div>\n  <div class='center' style='padding-bottom: 5px;'>\n    <div class='btn-line-group primary transparent'>\n      <button class='btn-line ' ui-sref='notifications.activities' translate='button.more.notification'></button>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/report.html","<div class=\"review stream {{review.status}}\">\n  <div class=\"row\">\n    <div class='col-xs-4 col-sm-4 col-md-3'>\n      <table class=\"table\">\n        <tr>\n          <th><span>type</span></th>\n          <td><span>{{review.category}}</span></td>\n        </tr>\n        <tr>\n          <th><span>status</span></th>\n          <td><span class='status'>{{review.status}}</span></td>\n        </tr>\n        <tr>\n          <th><span>score</span></th>\n          <td><span>{{review.score}}</span></td>\n        </tr>\n      </table>\n    </div>\n    <div class='col-xs-8 col-sm-6 col-md-5'>\n      <div class='reviewed'>\n        <div class=\"date\">{{review.story.date|date:'mediumDate'}}</div>\n\n        <h2 class=\"title\">\n          <a ui-sref=\"story({postId: review.story.slug})\"><span embedit='review.story.metadata.title' language='language'></span></a>\n        </h2>  \n      \n        <blockquote ng-if='review.story.metadata.abstract' embedit='review.story.metadata.abstract' language='language'></blockquote>\n      </div>\n    </div>\n\n    <div class='col-sm-2 col-md-4'>\n      <div class='center'  style='    margin-top: 35px;'>\n        <div class='btn-line-group primary'>\n          <button class='btn-line' ui-sref='report({id: review.id})' translate='button.viewreport'></button>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/review.html","<div class=\"review {{review.status}}\">\n  <div class=\"row\">\n    <div class='col-xs-4 col-md-3'>\n      <table class=\"table\">\n        <tr>\n          <th><span>type</span></th>\n          <td><span>{{review.category}}</span></td>\n        </tr>\n        <tr>\n          <th><span>status</span></th>\n          <td><span class='status'>{{review.status}}</span></td>\n        </tr>\n        <tr>\n          <th><span>due date</span></th>\n          <td><span>{{review.due_date|date:'mediumDate'}}</span></td>\n        </tr>\n        <tr ng-if='review.category != \"editing\"'>\n          <th><span>score</span></th>\n          <td><span>{{review.score}}</span></td>\n        </tr>\n      </table>\n    </div>\n    <div class='col-xs-8 col-md-9'>\n      <div class='reviewed'>\n        <div class=\"date\">{{review.story.date|date:'mediumDate'}}</div>\n\n        <h2 class=\"title\">\n          <a ui-sref=\"review.story({id: review.id})\"><span embedit='review.story.metadata.title' language='language'></span></a>\n        </h2>  \n      \n        <blockquote ng-if='review.story.metadata.abstract' embedit='review.story.metadata.abstract' language='language'></blockquote>\n      </div>\n      <div>\n\n        <div ng-if='review.story.source' class='btn-line-group primary transparent'>\n          <a class='btn-line ' ng-href=\"/api/story/{{story.id}}/download/source\" _target=\"blank\"><span class='icon icon-arrow-down-circle'></span><span translate='button.downloadsource'></span></a>\n        </div>\n        <div class='btn-line-group primary transparent'>\n          <button class='btn-line' ui-sref='review.story({id: review.id})' translate='button.viewforreview'></button>\n        </div>\n        <div ng-if='review.status == \"initial\" || review.status == \"draft\"' class='btn-line-group primary'>\n          <button class='btn-line' ui-sref='review({id: review.id})' translate='button.completereview'></button>\n        </div>\n        \n        <div ng-if='review.status != \"initial\" && review.status != \"draft\"' class='btn-line-group primary'>\n          <button class='btn-line' ui-sref='review({id: review.id})' translate='button.viewreport'></button>\n        </div>\n      </div>\n    </div>\n\n    \n  </div>\n</div>"),$templateCache.put("/static/templates/partials/story.html","<div ng-if='!story._isCollection' class=\"story item\">\n  <div class=\"row\">\n    <div class=\"col-md-4\" ng-if='story.covers.length'>\n      <div  ng-repeat='document in story.covers' class='fluid-container relative'>\n        <div class='image-wrapper cover' lazy-img='{{document|coverage}}'></div>\n        <div class='embedded-metadata' ng-include='\"templates/partials/document.metadata.embedded.html\"|prefixTemplate'></div>\n      </div>\n    </div>\n    <div ng-class='{\"col-md-12\":!story.covers.length, \"col-md-8\":story.covers.length}'>\n    <div ng-if='!$first' class=\"divider\"></div>\n    <div class=\"tags\" ng-if=\"story.tags.length && !story.matches\">\n      <span class='tag' ng-repeat='tag in story.tags|filter:{status:\"public\",category:\"writing\"}' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n    </div>\n    <div class=\"tags\" ng-if=\"story.tags.length && story.matches\">\n      <span class='tag' ng-click='setLocationFilter(\"tags\",tag.slug)' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n    </div>\n    <div ng-if='story.data.issue' class=\"issue\">&mdash; {{story.data.issue}}</div>\n    <div class=\"date\">{{story.date|date:\"yyyy'.'MM'.'dd\"}}</div>\n\n\n\n\n    <h3 class=\"title\"><a ui-sref=\"story({postId: story.slug})\"><span rewording value='story.data.title' default='{{story.title}}'></span> {{story.status != 'public'? '['+story.status+']': ''}}</a></h3>\n    <div class='authors' ng-if=\"story.authors.length\">\n      <span translate=\"written.by\"></span> <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n    </div>\n    <blockquote ng-if='story.excerpt' class=\"reduced\"><span ng-bind-html='story.excerpt'></span>\n      <a href ui-sref=\"story({postId: story.id})\">\n        <span class='icon-arrow-right-circle'></span>\n      </a>\n    </blockquote>\n\n    <blockquote ng-if='!story.excerpt && !story.matches' class=\"reduced\" rewording value='story.data.abstract' default='{{story.abstract}}'></blockquote>\n\n    <blockquote class=\"reduced matches\" ng-if=\"story.matches.highlights\">\n      <div embedit='story.matches.highlights'></div>\n    </blockquote>\n\n    <div ng-if=\"story._tags.keyword.length\" class=\"tags keywords\" ng-if=\"story.tags.length && !story.matches\">\n      <span translate=\"keywords\" class='label'></span> <span class='tag' ng-repeat='tag in story._tags.keyword' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n    </div>\n    <p>\n\n      <!-- <span class='creator' ng-if=\"!story.authors.length\">\n        created by <span ng-init='author=story.owner;$last=true' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </span> -->\n\n      <a ng-if='user.is_staff' target='_blank' ng-href='/admin/miller/story/{{story.id}}/change/'>modify (admin)</a>\n\n    </p>\n    </div>\n  </div>\n</div>\n\n<div ng-if='story._isCollection' ng-include='\"templates/partials/collection.html\"|prefixTemplate'></div>"),$templateCache.put("/static/templates/partials/story.pending.html","<div class=\"story item\">\n  <div class=\"row\">\n    <div class=\"col-md-3\" ng-if='story.covers.length'>\n      <div  ng-repeat='document in story.covers' class='fluid-container relative'>\n        <div class='image-wrapper cover' lazy-img='{{document|coverage}}'></div>\n        <div class='embedded-metadata' ng-include='\"templates/partials/document.metadata.embedded.html\"|prefixTemplate'></div>\n      </div>\n    </div>\n    <div ng-class='{\"col-md-8\":!story.covers.length, \"col-md-5\":story.covers.length}'>\n      <div ng-if='!$first' class=\"divider\"></div>\n      <div class=\"tags\">\n        <span class='tag' translate='story.status.{{story.status}}'></span>\n      </div>\n      \n\n      <div class=\"date\">{{story.date|date:\"yyyy'.'MM'.'dd\"}}</div>\n\n      \n\n\n      <h3 class=\"title\"><a ui-sref=\"story({postId: story.slug})\"><span embedit='story.data.title' language='language'></span> {{story.status != 'public'? '['+story.status+']': ''}}</a></h3>  \n      <div class='authors' ng-if=\"story.authors.length\">\n        <span translate=\"written.by\"></span> <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </div>\n      <blockquote ng-if='story.excerpt' class=\"reduced\">{{story.excerpt}}.\n        <a href ui-sref=\"story({postId: story.id})\">\n          <span class='icon-arrow-right-circle'></span>\n        </a>\n      </blockquote>\n      \n      <blockquote ng-if='!story.excerpt && !story.matches' class=\"reduced\" embedit='story.data.abstract' language='language'></blockquote>\n\n      <blockquote class=\"reduced matches\" ng-if=\"story.matches.highlights\">\n        <div embedit='story.matches.highlights'></div>  \n      </blockquote>\n\n      <p>\n        \n        <!-- <span class='creator' ng-if=\"!story.authors.length\">\n          created by <span ng-init='author=story.owner;$last=true' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n        </span> -->\n        \n        <a ng-if='user.is_staff' target='_blank' ng-href='/admin/miller/story/{{story.id}}/change/'>modify (admin)</a>\n      \n      </p>\n    </div>\n\n    \n  </div>\n\n  <div class=\"row\">\n    <div  class='col-xs-12'>\n      <table class='table'>\n        <tr>\n          <td colspan=\"4\">\n            <div ng-if='story.status != \"reviewdone\"' class='btn-line-group primary transparent'>\n              <button class='btn-line ' ng-click='addReview(story)'><span class='icon icon-plus'></span><span translate='button.assignforreview'></span></button>\n            </div>\n            <div ng-if='story.status != \"reviewdone\"' class='btn-line-group primary transparent'>\n              <button class='btn-line ' ng-click='finalDecision(story)'><span class='icon icon-plus'></span><span translate='button.finaldecision'></span></button>\n            </div>\n          </td>\n        </tr>\n        <tr ng-repeat='review in story.reviews | filter:{ category: \"!closing\"}' class='stream review' ng-class='review.status'>\n          <td>\n            <div><span class='status'>{{review.status}}</span></div>\n            <div><span>{{review.score}}/55</span></div>\n            <div>{{review.date_last_modified}}<div>\n          </td>\n          <td colspan=\"2\"><a class='author'>{{review.assignee.username}}</a> ({{review.due_date}}) &mdash; <span embedit='review.contents'></span></td>\n          <td><a ui-sref='review({id: review.id})' translate='review.category.{{review.category}}'></a></td>\n        </tr>\n        <tr ng-repeat='review in story.reviews | filter:{ category: \"closing\"}' class='review' ng-class='review.status'>\n          <td>\n            <div><span class='status'>{{review.status}}</span></div>\n          </td>\n          <td colspan=\"3\"><a class='author'>{{review.assignee.username}}</a> &mdash; <span embedit='review.contents'></span></td>\n        </tr>\n      </table>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/story.socialshare.html",'<div class="share" >\n  <span translate=\'share\'></span>\n  <a class=\'btn btn-line btn-share\' socialshare socialshare-provider="twitter" socialshare-text="{{OG.title}}" socialshare-via="{{settings.twitter.username}}" socialshare-hashtags="{{settings.twitter.socialtags}}" socialshare-url="{{absoluteUrl}}"><span class=\'icon icon-social-twitter\'></span></a>\n\n  <a class=\'btn btn-line btn-share\' socialshare socialshare-provider="facebook" socialshare-text="{{OG.title}}" socialshare-title="{{OG.title}}" socialshare-description="{{OG.description}}"  socialshare-hashtags="{{settings.socialtags}}" socialshare-media="{{OG.image}}" socialshare-via="{{settings.facebook}}" socialshare-type="feed" socialshare-url="{{absoluteUrl}}"><span class=\'icon icon-social-facebook\'></span></a>\n\n  <a class=\'btn btn-line btn-share\' socialshare socialshare-provider="linkedin" socialshare-text="{{OG.title}}" socialshare-description="{{OG.description}}"  socialshare-source="{{OG.image}}" socialshare-url="{{absoluteUrl}}"><span class=\'icon icon-social-linkedin\'></span></a>\n\n   <a class=\'btn btn-line btn-share\' socialshare socialshare-provider="email" socialshare-body="{{OG.title}} ({{absoluteUrl}}) by RESuME" socialshare-source="{{OG.image}}" socialshare-url="{{absoluteUrl}}"><span class=\'icon icon-envelope\'></span></a>\n</div>'),$templateCache.put("/static/templates/partials/table-of-contents.html","<h2>table of contents</h2>\n<div class='actions'>\n  <a class='action' ng-click='toggleTableOfContents()'>\n    <span class='icon icon-close'></span>\n  </a>\n</div>\n<ul>\n  <li bs-scrollspy data-offset='100' data-target='#h-{{heading.slug}}' ng-repeat='heading in ToC' class='heading heading-{{heading.level}}'>\n    <a ng-click='setHash(heading.slug)' bs-tooltip data-placement='right'>{{heading.text}}</a>\n  </li>\n</ul>"),$templateCache.put("/static/templates/partials/table-of-documents.html","<!-- <h2>table of documents</h2>\n -->\n\n<!-- <div>\n  <div ng-repeat=\"document in documents\">\n    {{language}}\n    <span embedit='document.data.title' language='language'></span>\n  </div>\n</div> -->"),$templateCache.put("/static/templates/partials/tag.autocomplete.html","<div ng-if='data.type == \"__new__\"' class=\"item create-new sans-serif\">\n  <span translate='or'></span> <div class='btn-line-group transparent'><button class='btn-line' translate='button.createnewtag' ng-click='openAddTagModal()'></button></div>\n</div>\n<div ng-if='data.type != \"__new__\"' class=\"item selectable sans-serif\">\n  <span rewording value='data.data.name' default='{{data.name}}' highlight='$highlight(text)'></span>\n  <!-- <span ng-bind-html=\"$highlight($getDisplayText())\"></span> -->\n</div>"),$templateCache.put("/static/templates/partials/tag.html","<span ng-if='tag.category != \"keyword\" && tag.category != \"blog\"' class='tag' ng-class='tag.category'><a href=\"{{getTagRoute(tag)}}\" rewording value='tag.data.name' default='{{tag.name}}'></a></span><span ng-if='tag.category == \"keyword\"' class='tag' ng-class='tag.category'><a href=\"{{getTagRoute(tag)}}\" rewording value='tag.data.name' default='{{tag.name}}'></a></span><span ng-if='tag.category == \"blog\"' class='tag' ng-class='tag.category'><a href ui-sref='blog.{{tag.slug}}' rewording value='tag.data.name' default='{{tag.name}}'></a>\n</span><span>{{$last? \"\": \" &mdash; \"}}</span>"),$templateCache.put("/static/templates/partials/tag.input.html","<span ng-class='data.category'>\n  <span class='type'>{{data.category}}/</span>\n  <span rewording value='data.data.name' default='{{data.name}}'></span>\n\t<a class=\"remove-button\" ng-click=\"$removeTag()\" ><span class='icon-close'></span></a>\n</span>"),$templateCache.put("/static/templates/partials/tags.input.html","<label translate=\"{{tagField.label}}\"></label>\n<tags-input class='tags-input' on-tag-adding='beforeAttachTag($tag)' on-tag-removed='detachTag($tag)' key-property='id' display-property='name' ng-model=\"tagField.tags\" add-from-autocomplete-only=\"true\">\n    <auto-complete template='{{\"templates/partials/tag.autocomplete.html\"|prefixTemplate}}' source=\"suggestTags($query, tagField.filters, !tagField.addFromAutocompleteOnly)\" ></auto-complete>\n</tags-input>"),$templateCache.put("/static/templates/partials/term.html","<div ng-class='{\"active\": selectedDocument.id == term.id}' class='doc term oembedded' ng-click='selectDocument(term)'>\n  <!-- this element has fixed height. -->\n  <!-- {{term}} -->\n  <div class='wrapper'>\n    <div class='lazy-box'>\n      \n      <div ng-if='!term.covers.length' class='title' rewording value='term.data.title'></div>\n      <div ng-if='!term.covers.length' class='copyright' rewording value='term.data.abstract'></div>\n      <!-- {{term.covers}} -->\n      <div class='cover' ng-repeat='cover in term.covers' lazy-img='{{cover|coverage}}'></div>\n    </div>\n    <div class='tile'>\n      <div class=\"tags\" ng-if=\"term.tags.length\">\n        <span class=\"tag\" ng-repeat='tag in term.tags|filter:{ category: \"writing\", status:\"public\" }' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n      </div>\n      <div class='title' rewording value='term.data.title'></div>\n      <div class='abstract' rewording value='term.data.abstract'></div>\n      <div class='authors' ng-if=\"term.authors.length\">\n        by <span ng-repeat='author in term.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </div>\n      \n    </div>\n  </div>\n  <div class='excerpt' rewording value='term.data.title'></div>\n</div>"),$templateCache.put("/static/templates/partials/term.placeholder.html","<a ui-sref='story({postId: resolved.id})'>{{resolved.title}}</a>\n"),$templateCache.put("/static/templates/partials/typeahead.html",'<ul tabindex="-1" class="typeahead dropdown-menu" ng-show="true" show="$isVisible()" role="select" aria-hidden="true">\n  <li role="presentation" ng-repeat="match in $matches" ng-class="{active: $index == $activeIndex}">\n    <a role="menuitem" tabindex="-1" ng-click="$select($index, $event)" ng-bind="match.label"></a>\n  </li>\n</ul>'),$templateCache.put("/static/templates/partials/user.input.html","<span ng-class='{\"staff\": data.is_staff}'>\n  <span class='type'>{{data.username}}\n  <a class=\"remove-button\" ng-click=\"$removeTag()\" ><span class='icon-close'></span></a>\n</span>"),$templateCache.put("/static/templates/partials/directives/biography.html","<div class=\"biography\">\n  <div class='biography-tooltip' ng-class='{\"hide\": tooltip.idx  < 0}' style='left:{{tooltip.left}}px;bottom:{{tooltip.bottom}}px;top:initial'>\n    <div class='inner'>\n      <div class='date' rewording value='tooltip.date' follow='tooltip'></div>\n      <div class='type' ng-class='tooltip.type' ng-if='tooltip.type' translate='biography.activitytype.{{tooltip.type}}'></div>\n      <div class='description' rewording value='tooltip.description' follow='tooltip'></div>\n      <div class='arrow'></div>\n    </div>\n  </div>\n  <div class='frame'>\n    <label class='birth'>\n        <div class='place'>{{data.birth_place}}</div>\n        <div class='date'>{{data.start_date|date:\"yyyy\"}}</div>\n    </label>\n\n    <label class='death'>\n        <div class='place'>{{data.death_place}}</div>\n        <div class='date'>{{data.end_date|date:\"yyyy\"}}</div>\n      </label>\n\n    <div class='lifespan'>\n      \n      <div class='line'></div>\n      \n      <div class='line offset'></div>\n\n      \n      \n\n      \n\n      <div class='bar-wrapper' style='left: {{lifespan.left}}px; right: {{lifespan.right}}px'>\n        <div class='date left'>{{lifespan.years.min}}</div>\n        <div class='date right'>{{lifespan.years.max}}</div>\n        <div class='bar'></div>\n        <div class='border left'></div>\n      <div class='border right'></div>\n        <!-- <div class='border left'></div>\n        <div class='border right'></div> -->\n      </div>\n\n    </div>\n\n    <div class='activities'>\n\n      <div class='date left'><span>{{lifespan.years.min}}</span></div>\n      <div class='date right'><span>{{lifespan.years.max}}</span></div>\n\n      <div class='activity' ng-class='{\"active\": $index == tooltip.idx}' ng-mouseover='showTooltip(activity, $index, $event)'  ng-mouseleave='hideTooltip()' style='top:{{$index * activity.height}}px;height:{{activity.height}}px' ng-repeat='activity in data.activities'>\n      <div class='description' ng-if='activity.description.alignment==\"left\"|| activity.nodate' style='left:5px; right: {{activity.description.right}}px;text-align:right' rewording value='activity.description'></div>\n        <div class='description' ng-if='activity.description.alignment==\"right\"' style='left: {{activity.description.left}}px' rewording value='activity.description'></div>\n\n        <div class='bar-wrapper' style='left: {{activity.left}}px; right: {{activity.right}}px; min-width: 3px'>\n          <div class='date left'>{{activity.start_date}}</div>\n          <div class='date right' ng-show='!activity.uniqdate'>{{activity.end_date}}</div>\n          <div class='bar' ng-class='activity.type'></div>\n        </div>\n        <div class='line'></div>\n      </div>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/directives/commenter.html","<div class=\"commenter\" ng-click='$event.stopImmediatePropagation()'>\n  <div class='leave'>\n    <div class='actions float-right' ng-if='!disableClose'>\n      <div ng-click='discard($event)'><span class='icon icon-close'></span></div>\n    </div>\n    <h4 class=\"sans-serif\"><span translate='comment.leave'></span></h4>\n    <div class='section quote' ng-if='quote'>\n      <span max-words='5' commenter-quote=\"quote\"></span>\n    </div>\n    \n    <div class='section'>\n      <label>{{actor.username}}</label>\n      <textarea rows=\"3\" placeholder='... write here' class='elastic-textarea' msd-elastic ng-model='content' ng-model-options=\"{ debounce: 200 }\"></textarea>\n    </div>\n    <div class=\"actions\">\n      <div class='btn-line-group primary transparent'>\n        <button  class='btn-line' ng-click='leaveComment()' ng-disabled='isLoading'><span translate='button.comment.leave' translate-values='isLoading'></span> <span class='icon icon-pencil'></span></button>\n      </div>\n      <div class='btn-line-group  transparent float-right'>\n        <button  class='btn-line'>\n          <span translate='comment.status.private'></span><span class='icon icon-eye'></span>\n        </button>\n      </div>\n    </div>\n  </div>\n  <!-- view comment -->\n  <div class='section comments' ng-if='!disableViewer'>\n    <div ng-repeat='comment in attachedComments' ng-include='\"templates/partials/comment.html\"|prefixTemplate'></div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/directives/footnote.html",'<span class="footnote">\n  <!-- <a ng-click="toggleFootnote()">{{caption}}</a> -->\n  <div class="footnote-contents" ng-show="isOpened"></div>\n</span>'),$templateCache.put("/static/templates/partials/directives/lazy-cover.html",'<div ng-if="!immediate" class="lazy-cover" style="background-position:{{offsetx}} {{offsety}};" lazy-img="{{src}}"></div>\n<div ng-if="immediate" class="lazy-cover loaded" style="background-position:{{offsetx}} {{offsety}}; background-image: url({{src}})"></div>\n      '),$templateCache.put("/static/templates/partials/directives/lazy-placeholder.html","<div class='placeholder' ng-if='type==\"doc\"' ng-init='document=resolved' ng-include='\"templates/partials/document.html\"|prefixTemplate'></div>\n<span class='placeholder' ng-if='type==\"voc\"' ng-include='\"templates/partials/term.placeholder.html\"|prefixTemplate'></span>"),$templateCache.put("/static/templates/partials/directives/marginalia.html",'<div id="marginalia"></div>'),$templateCache.put("/static/templates/partials/directives/mde.html","<div ng-show='isReady' class='mde'>\n  <div class='wand' >\n    <button class='btn' ng-disabled='isPreviewEnabled' ng-click='showReferenceModal()'><span class='icon-plus'></span></button>    \n  </div>\n\t<textarea class='mde-textarea' placeholder=\"write something...\"></textarea>\n</div>"),$templateCache.put("/static/templates/partials/directives/rangy.html",'<div class="rangy" ng-class=\'{"enabled":isEnabled}\'>\n  <div commenter target="target" actor="actor" highlight=\'highlight\' discarded=\'discarded()\' comments-selected=\'commentsSelected\' commented="commented(error, comment)"></div>\n</div>\n      '),$templateCache.put("/static/templates/partials/directives/rich-oembed.html","<div class='rich-oembed-iframe-wrapper {{oembed.type}}' ng-class='{\"with-thumbnail\": with-thumbnail}'>\n  <div ng-click='toggleEnable()' class=\"shadow\">\n    <div class='toggler' ng-if='oembed.type == \"video\"' ><span class='icon icon-control-play'></span></div>\n  </div>\n  <div class='rich-oembed-iframe-viewport' ng-class='{\"active\":iframeEnabled}'>\n    <div  style='height: 100%; width: 100%; ' >\n      <div class='image-wrapper cover' lazy-cover media='media' immediate='{{immediate}}' quality='{{quality}}'></div>\n    </div>\n    <div ng-if='iframeEnabled' style='height: 100%; position: absolute; top:0; left:0;width: 100%' stretch='true' autoplay='{{autoplay}}' embedit='oembed.html' language='language'></div>\n  </div>\n  <div class='actions'>\n    <a ng-if='(oembed.type == \"rich\" && oembed.html) || iframeEnabled'  class=\"action\" ng-click=toggleEnable()>\n      <span class='icon' ng-class='{\"icon-control-play\": !iframeEnabled, \"icon-close\": iframeEnabled}'></span>\n    </a>\n    <a class='action' ng-if='fullscreen' ng-click=\"toggleFullscreen()\">\n      <span class='icon icon-size-fullscreen'></span>\n    </a>\n\n  </div> \n</div>"),$templateCache.put("/static/templates/partials/directives/sliding-steps.html","<div class='sliding-steps-direction top' ng-class='{\"active\":isMoreTop}'>\n  <div class='btn-line-group'>\n    <button class=\"btn btn-line\" ng-click='prev()'>\n      <span class=\"icon icon-arrow-up-circle\"></span>\n      <span translate='button.previous'></span> \n    </button>\n  </div>\n</div>\n\n<div class=\"sliding-steps-wrapper\" ng-class='{\"more-top\":isMoreTop, \"more-bottom\":isMoreBottom}'>\n  <div class='sliding-steps'>\n    <div id='step-{{item._index}}' class='step {{item._type}}' ng-class='{active: item.isFocused}' ng-repeat=\"item in items\" ng-init='document=item' ng-if='item._type != \"block-doc\"'>\n      <div class=\"thumbnail\" ng-class='item.type' ng-if='item._type==\"doc\" && item.type != \"link\" && item.type != \"crossref\"' >\n        <div class=\"thumbnail-image\"  rich-oembed autoplay='true' fullscreen='fullsize(document.slug, document._type)' enabled='item.isFocused' media='document' quality='snapshot' oembed='document.data'></div>\n      </div>\n\n      <!-- glossary items -->\n      <div ng-if=\"item._type=='voc'\" class='metadata' ng-class='item.type || item._type'>\n        <button class='btn btn-line' ng-click='alignTo(item._index, $event)'>\n          <span class='icon icon-type-{{item.type||item._type}}'></span><span class='type {{document.type}}'></span>\n        </button>\n       \n        <span class='title' embedit='item.data.title' language='language'></span>\n          \n        \n        <!-- glossary contents -->\n        <div class='contents'>\n          \n          <span class=\"tags\" ng-if=\"item.tags.length\">\n            <span class='tag' ng-repeat='tag in item.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n          </span>\n          | \n          <span class='authors' ng-if=\"item.authors.length\">\n            <span translate=\"written.by\"></span> <span ng-repeat='author in item.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n          </span>\n          \n          <div class='caption'>\n            <span rewording value='item.data.abstract' default='{{item.abstract}}'></span>\n            <span>\n              <a ui-sref='story({postId:item.slug})'>\n                <span translate='more'></span>\n                <!-- <span class=\"icon icon-arrow-right-circle\"></span> -->\n              </a>\n            </span>\n          </div>\n    \n        </div>\n      </div>\n\n\n      <div ng-if=\"item._type=='footnote'\" class=\"metadata footnote-wrapper\">\n        <button class='btn btn-line' ng-click='alignTo(item._index, $event)'>\n        <span>{{item.caption}}</span>\n        </button>\n        <span footnote='item.id' caption='item.caption' is-opened='true'></span>\n      </div>\n      <!-- <div ng-if=\"item.type=='image'\">\n        {{item.data}}\n      </div> -->\n      <div ng-if='item.data && item._type!=\"voc\"' ng-include='\"templates/partials/document.metadata.html\"|prefixTemplate'></div>\n    </div>\n  </div>\n</div>\n\n<div class='sliding-steps-direction bottom' ng-class='{\"active\":isMoreBottom}'>\n  <div class='btn-line-group'>\n    <button class=\"btn btn-line\" ng-click='next()'>\n      <span class=\"icon icon-arrow-down-circle\"></span>\n      <span translate='button.next'></span> \n    </button>\n  </div>\n</div>\n\n<div id='sliding-steps-line'></div>"),
$templateCache.put("/static/templates/partials/embeds/Flickr.html","<div ng-if='embed.html' style='height: 200px; width: 100%; overflow: hidden' embedit='embed.html' stretch=\"true\"></div>\n<div ng-if='!embed.html' style='height: 200px; width:100%; background-position: center; background-color: #151515; background-size:contain; background-repeat: no-repeat;' lazy-img='{{embed.url}}'></div>\n<a class='permalink' target='_blank' ng-href='{{embed.url}}'>{{embed.title}}</a>\n<div class='description'>{{embed.description}} <a target='_blank' ng-href='{{embed.url}}'>{{embed.url|smartUrl}}</a> <span translate=\"by\"></span> <a ng-href='embed.author_url' target='_blank'>{{embed.author_name}}</a> <span translate=\"on\"></span> <a ng-href='embed.provider_url' target='_blank'>{{embed.provider_name}}</a></div>\n"),$templateCache.put("/static/templates/partials/embeds/Ina.fr.html","<div class='caption title' embedit='embed.title'></div>\n<div class='caption reference' embedit='embed.description'></div>\n<img lazy-img src='{{embed.thumbnail_url}}' />\n\n"),$templateCache.put("/static/templates/partials/embeds/YouTube.html","\n<div class='caption title' markdown='embed.title'></div>\n<div class='copyright'><a ng-href='embed.author_url'>{{embed.author_name}}</a></div>\n\n\n<div lazy-image src='embed.thumbnail_url'></div>\n\n"),$templateCache.put("/static/templates/partials/embeds/cvce.html","\n<div class='caption title' markdown='embed.title.fr'></div>\n<div class='caption reference' markdown='embed.reference.fr'></div>\n<div class='copyright'>{{embed.copyrights}}</div>\n\n\n <div ng-if='embed.urls.Preview'>\n  <div lazy-image src='embed.urls.Preview'></div>\n </div>\n\n"),$templateCache.put("/static/templates/partials/embeds/document.html","<div class='oembedded doc doc-{{document.type}}' ng-class='{\"active\": document.id == selectedDocument.id}' ng-click='selectDocument(document)'>\n\n  <!-- <div class='divider'>&nbsp;</div> -->\n  \n  <div class='wrapper'>\n    <div ng-if='document.data'>\n      <div src='document.data.thumbnail_url || document.data.urls.Preview || document.snapshot || document.data.url' lazy-image></div>\n      <!-- <div ng-if='document.data.thumbnail_url' lazy-image src='document.data.thumbnail_url'></div>\n\n      <div ng-if='!document.data.thumbnail_url && document.data.urls.Preview' lazy-image src='document.data.urls.Preview'></div>\n\n      <div ng-if='!document.data.thumbnail_url && !document.data.urls.Preview' class='lazy-box'></div>\n -->\n      <div class='tile'>\n        <div class='title' embedit='document.data.title' language='language'></div>\n        <div class='copyright' embedit='document.data.copyright'></div>\n      </div>\n    </div>\n    <div ng-if='!document.data'>\n      <div ng-if='document.urls.Preview' lazy-image src='document.urls.Preview'></div>\n      <div ng-if='document.src' lazy-image src='document.src'></div>\n      <!-- {{document}} -->\n      <div class='tile'>\n        <div class='title' embedit='document.title'></div>\n        <div class='copyright' embedit='document.copyright'></div>\n      </div>\n    </div>\n  </div>\n\n  <div class='excerpt'><span class='type'>{{document.type}}</span> <span embedit='document.title'></span></div>\n</div>"),$templateCache.put("/static/templates/partials/embeds/metadata.html","<div>\n  <a class='permalink' ng-if='embed.title' target='_blank' ng-href='{{embed.url}}'>{{embed.title}}</a>\n  <span class='permalink' ng-if='!embed.title' translate='enrich.type.notitle'></span>\n</div>\n<div class='description'>{{embed.description}} <span ng-if='embed.description'> &mdash;</span> <a target='_blank' ng-href='{{embed.url}}'>{{embed.url|smartUrl}}</a>\n  <span ng-if=\"embed.author_url\">\n    <span translate=\"by\"></span> <a ng-href='embed.author_url' target='_blank'>{{embed.author_name}}</a> \n  </span>\n  <span ng-if=\"embed.provider_url\">\n    <span translate=\"on\"></span> <a ng-href='embed.provider_url' target='_blank'>{{embed.provider_name}}</a>\n  </span>\n</div>"),$templateCache.put("/static/templates/partials/modals/add-review.html",'<div class="modal" tabindex="-1" role="dialog" aria-hidden="true" style="z-index: 1051; display: block;">\n  <div class="modal-dialog">\n    <div class="modal-content">\n      <div class="modal-header">\n        <button type="button" class="close" aria-label="Close" ng-click="$hide()">\n        <span aria-hidden="true" class=\'icon-close\'></span>\n        </button>\n        <h4 class="modal-title" translate="modals.addreview.title"></h4>\n      </div>\n\n      <div class="modal-body">\n        <div class="container-fluid">\n          <div class=\'row\'>\n            <div  class=\'col-md-12\'>\n              <label translate="modals.addreview.field.reviewers.label"></label>\n              <tags-input class=\'tags-input\' key-property=\'username\' template=\'{{"templates/partials/user.input.html"|prefixTemplate}}\' display-property=\'username\' placeholder="{{modals.addreview.field.reviewers.placeholder|translate}}" ng-model="reviewers" add-from-autocomplete-only="true">\n                <auto-complete source="suggestReviewer($query, {groups__name:\'reviewers\'})"></auto-complete>\n              </tags-input>\n            </div>\n\n            <!-- <div  class=\'col-md-12\'>\n            <p>{{reviewers}}</p>\n            </div> -->\n          </div>\n        </div>\n      </div>\n\n      <!-- eof body -->\n      <div class="modal-footer">\n        <span class=\'btn-line-group\' ng-class=\'{"primary": reviewers.length}\'><button type="submit" class="btn-line " ng-class="{\'active\':reviewers.length}" ng-disabled=\'!reviewers.length\' ng-click="confirm()" translate=\'button.assignforreview\'></button>\n        </span>\n        <span class=\'btn-line-group transparent\'>\n        <button type="button" class="btn-line" ng-click="$hide()" translate=\'button.dismiss\'></button>\n        </span>\n      </div>\n      <!-- eof footer -->\n    </div>\n\n  </div>\n</div>\n\n\n'),$templateCache.put("/static/templates/partials/modals/add-tag.html","<div class=\"modal\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1051; display: block;\">\n  <div class=\"modal-dialog\">\n    <form name=\"addTagForm\">\n      <div class=\"modal-content\">\n        <div class=\"modal-header\">\n          <button type=\"button\" class=\"close\" aria-label=\"Close\" ng-click=\"$hide()\">\n          <span aria-hidden=\"true\" class='icon-close'></span>\n          </button>\n          <h4 class=\"modal-title\" translate=\"modals.addtag.title\"></h4>\n        </div>\n        \n        <div class=\"modal-body\">\n          <div class=\"container-fluid\" style='padding-bottom: 20px'>\n            <div class='row' ng-if='tag.id && !tag.created'>\n              <div class='modal-message' translate='modals.addtag.tagexist'></div>\n            </div>\n            <div class='row'>\n              <div  class='col-md-12'>\n                <label translate=\"modals.addtag.field.name.label\"></label>\n                <input placeholder='...' required ng-model='name' class='form-control' >\n              </div>\n\n              <div ng-repeat='lang in settings.languages' class='col-md-6'>\n                <label><span translate=\"modals.addtag.field.name.label\"></span> (<span translate='language.{{lang}}'></span>)</label>\n                <input placeholder='...'  ng-model='data.name[lang]' class='form-control'>\n                <div class='conflict sans-serif' ng-if='conflicts[lang]' translate='conflict.before' translate-values='{ value: conflicts[lang] }'></div>\n              </div>\n\n              <div  class='col-md-12'>\n                <label translate=\"modals.addtag.field.provider.label\"></label>\n                <input placeholder='EUROVOC, EUR-LEX ...' ng-model='data.provider'  class='form-control' >\n              </div>\n            </div>\n          </div>\n        </div>\n        \n        <!-- eof body -->\n        <div class=\"modal-footer\">\n          <span class='btn-line-group' ng-class='{\"primary\": addTagForm.$valid}'><button ng-if='!tag.id' type=\"submit\" class=\"btn-line \" ng-class=\"{'active':addTagForm.$valid}\" ng-disabled='!addTagForm.$valid || is_saving' ng-click=\"confirm()\" translate='button.create'></button>\n          <button ng-if='tag.id' type=\"submit\" class=\"btn-line \" ng-class=\"{'active':addTagForm.$valid}\" ng-disabled='!addTagForm.$valid || is_saving' ng-click=\"update()\" translate='button.updateandattachtag'></button>\n          </span>\n          <span class='btn-line-group transparent'>\n          <button type=\"button\" class=\"btn-line\" ng-click=\"$hide()\" translate='button.dismiss'></button>\n          </span>\n        </div>\n        <!-- eof footer -->\n      </div>\n    </form>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/modals/confirm.html",'<div class="modal" tabindex="-1" role="dialog" aria-hidden="true" style="z-index: 1051; display: block;">\n  <div class="modal-dialog">\n    <div class="modal-content">\n      <div class="modal-header">\n        <button type="button" class="close" aria-label="Close" ng-click="$hide()">\n        <span aria-hidden="true" class=\'icon-close\'></span>\n        </button>\n        <h4 class="modal-title" translate="{{title}}"></h4>\n      </div>\n\n      <div class="modal-body">\n        <p translate="{{question}}"></p>\n      </div>\n\n      <!-- eof body -->\n      <div class="modal-footer">\n        <span class=\'btn-line-group primary\'><button type="submit" class="btn-line " ng-class="{\'active\':isSomethingSelected}" ng-click="confirm()" translate=\'button.confirm\'></button>\n        </span>\n        <span class=\'btn-line-group transparent\'>\n        <button type="button" class="btn-line" ng-click="dismiss()" translate=\'button.dismiss\'></button>\n        </span>\n      </div>\n      <!-- eof footer -->\n    </div>\n\n  </div>\n</div>'),$templateCache.put("/static/templates/partials/modals/covers.html","<div class=\"modal\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1051; display: block;\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n      <button type=\"button\" class=\"close\" aria-label=\"Close\" ng-click=\"$hide()\">\n      <span aria-hidden=\"true\" class='icon-close'></span>\n      </button>\n      <h4 class=\"modal-title\" translate=\"modal.covers.title\"></h4></div>\n      \n      <div class=\"modal-body\">\n        <div class='section padded' style='padding-bottom: 0'>\n          <label>\n            <span translate='search'></span>{{isSomethingSelected}}\n            <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n          </label>\n          <input placeholder='....' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 200 }\" ng-change='suggest(query)'>\n        </div>\n\n        <ul class=\"nav nav-tabs\" style='margin-bottom: 20px; padding-left:15px;' role=\"tablist\">\n          <li role='presentation' ng-class='{\"active\": _tab.name == tab.name}' ng-repeat='_tab in tabs'>\n            <a ng-click='setTab(_tab.name)' translate='tab.{{_tab.name}}' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\"></a>\n          </li>\n        </ul>\n\n        <div>\n          <ul class='list-of-documents'><li ng-repeat='document in tab.items' ng-include='\"templates/partials/embeds/document.html\"|prefixTemplate'></li>\n              </ul>\n          <div class='more-wrapper'>\n                <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='more()'>\n                    <span ng-if='!tab.isLoadingNextItems'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n                    </span>\n                    <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n        </div>\n      </div>\n      <!-- eof body -->\n      <div class=\"modal-footer\">\n        <span class='btn-line-group' ng-class=\"{'primary':isSomethingSelected}\"><button type=\"button\" class=\"btn-line \" ng-class=\"{'active':isSomethingSelected}\" ng-click=\"addDocument(tab.name, contents, reference, url, embed)\" translate='button.add'></button>\n        </span>\n        <span class='btn-line-group'>\n        <button type=\"button\" class=\"btn-line\" ng-click=\"$hide()\">Close</button>\n        </span>\n      </div>\n      <!-- eof footer -->\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/modals/final-decision.html",'<div class="modal" tabindex="-1" role="dialog" aria-hidden="true" style="z-index: 1051; display: block;">\n  <div class="modal-dialog">\n    <form name="fdForm">\n      <div class="modal-content">\n        <div class="modal-header">\n          <button type="button" class="close" aria-label="Close" ng-click="$hide()">\n          <span aria-hidden="true" class=\'icon-close\'></span>\n          </button>\n          <h4 class="modal-title" translate="modals.finaldecision.title"></h4>\n        </div>\n\n        <div class="modal-body">\n          <div class="container-fluid" style=\'padding-bottom: 20px\'>\n            <div class=\'row\'>\n              <div  class=\'col-md-12\'>\n                <label>\n                  <span translate="modals.finaldecision.field.status.label"></span>\n                  <p class=\'description\' translate=\'modals.finaldecision.field.status.abstract\'>\n                </p>\n                </label>\n                <p>\n                <select name=\'finalStatus\' required ng-model="review.status">\n                  <option ng-repeat=\'status in availableStatus\' ng-value=\'status\' translate=\'field.label.review.status.{{status}}\'></option>\n                </select>\n                </p>\n                <!-- final comments -->\n                <label>\n                  <span translate="field.label.review.final"></span>\n                  <p class=\'description\' translate="field.label.review.final.description"></p>\n                </label>\n                <div class=\'elastic-textarea-wrapper\'>\n                  <textarea required rows="10" required class=\'elastic-textarea\' msd-elastic ng-model=\'review.contents\' name=\'reviewcontentstext\' ng-model-options="{ debounce: 200 }"></textarea>\n                </div>\n                \n\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <!-- eof body -->\n        <div class="modal-footer">\n          <span class=\'btn-line-group\' ng-class=\'{"primary": fdForm.$valid && review.status}\'><button type="submit" class="btn-line " ng-class="{\'active\':fdForm.$valid && review.status}" ng-disabled=\'!fdForm.$valid || !review.status\' ng-click="confirm()" translate=\'button.confirm\' translate-values=\'{is_saving:isSaving}\'></button>\n          </span>\n          <span class=\'btn-line-group transparent\'>\n          <button type="button" class="btn-line" ng-click="$hide()" translate=\'button.dismiss\'></button>\n          </span>\n        </div>\n        <!-- eof footer -->\n      </div>\n    </form>\n\n  </div>\n</div>\n\n\n'),$templateCache.put("/static/templates/partials/modals/fullsize.html","<div ng-class='{\"with-cover\":fullsized.data.thumbnail_url}' class=\"modal fullsize {{fullsized.type}}\"  tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1050; display: block;\">\n  <div ng-click='$hide()' class='close'>\n  <span class='icon-close'></span>\n  </div>\n  <div ng-class='fullsized.type' class='oversize' style=''>\n    <div class=\"wrapper\">\n      <div class=\"header\">\n        <div class=\"inner\" style='display: table-cell'>\n          <h2 embedit='fullsized.data.title'></h2>\n          <div ng-init='document=fullsized' ng-include='\"templates/partials/document.metadata.linear.html\"|prefixTemplate''></div>\n        </div>\n      </div>\n      <div class=\"main\">\n        <div class=\"box sidebar\"></div>\n        <div class=\"box content\" ng-if='fullsized.type != \"text\"'>\n          <div class='embedded' ng-if='fullsized.data.html && !fullsized.data.urls' stretch='true' embedit='fullsized.data.html'></div>\n          <div class='embedded' ng-if='fullsized.data.html && fullsized.data.urls'>\n            <!-- ex cvce -->\n            <div class='image-wrapper cover' style='background-size:contain; background-color: #151515; background-image:url({{fullsized|coverage:\"hifi\"}})'></div>\n          </div>\n          <div class='embedded' ng-if='!fullsized.data.html'>\n            <div class='image-wrapper cover' style='background-size:contain; background-color: #151515; background-image:url({{fullsized|coverage:\"hifi\"}})'></div>\n\n          </div>\n          <!-- {{fullsized}} -->\n        </div>\n        <div class=\"box content\" ng-if='fullsized.type == \"text\"'>\n          <div class='embedded' stretch='true' embedit='fullsized.data.caption'></div>\n        </div>\n        \n        <div class=\"box sidebar\"></div>\n      </div>\n      <div class=\"footer\">\n        <div class='inner' >\n          <div ng-if='fullsized.data.copyright' class='text copyright' embedit='fullsized.data.copyright' language=\"language\" firstline='true'></div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/modals/mde-enrich.html","<div class=\"modal\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1050; display: block;\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\" ng-show=\"title\">\n      <button type=\"button\" class=\"close\" aria-label=\"Close\" ng-click=\"$hide()\">\n      <span aria-hidden=\"true\" class='icon-close'></span>\n      </button>\n      <h4 class=\"modal-title\">add resource</h4></div>\n      \n      <div class=\"modal-body\">\n\n        \n        <!-- <input type='text' class=\"form-control\" placeholder=\"search ...\"> -->\n        <ul class=\"nav nav-tabs\" style='padding-left:15px; margin-bottom:0' role=\"tablist\">\n          <li role='presentation' ng-class='{\"active\": _tab.name == tab.name}' ng-repeat='_tab in tabs'>\n            <a ng-click='setTab(_tab.name)' translate='tab.{{_tab.name}}' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\"></a>\n          </li>\n        </ul>\n\n        \n          <div ng-show=\"tab.name == 'favourite'\" class=\"tab-content\">\n            <div class='section padded' ng-class='{\"last\": !lookups.length}'>\n              <label>\n                <span translate='search'></span>\n                <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n              </label>\n              <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 450 }\" ng-change='suggest(query)'>\n              <ul class=\"suggestions\">\n                <li ng-repeat='suggestion in tab.suggestions'><a href='' ng-click='tab.suggestquery(suggestion)'>{{suggestion}}</a></li>\n              </ul>\n              <!-- <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 450 }\" ng-change='suggest(query)' bs-options=\"item in tab.typeahead($viewValue)\" bs-typeahead data-template='{{\"templates/partials/typeahead.html\"|prefixTemplate}}'> -->\n              <!-- <input placeholder='...' class='form-control' type='text' ng-model='ghh' bs-options=\"item as item.label in tab.typeahead($viewValue)\" bs-typeahead> -->\n            </div>\n            <div class='section last'>\n              <ul class='list-of-documents'><li ng-repeat='document in tab.items' ng-include='\"templates/partials/embeds/document.html\"|prefixTemplate'></li>\n              </ul>\n              <div class='more-wrapper'>\n                <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='more()'>\n                    <span ng-if='!tab.isLoadingNextItems'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n                    </span>\n                    <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'crossref'\" class=\"tab-content\">\n            <div class='section padded' ng-class='{\"last\": !lookups.length}'>\n              <label>\n                <span translate='search'></span>\n                <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n              </label>\n              <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 450 }\" ng-change='suggest(query)'>\n            </div>\n            <div class='section last'>\n              <ul class='list-of-documents'><li ng-repeat='item in tab.items' ng-include='\"templates/partials/crossref.html\"|prefixTemplate'></li>\n              </ul>\n              <div ng-include='\"templates/partials/more.html\"|prefixTemplate'></div>\n            </div>\n          </div>\n          <div ng-show=\"tab.name == 'glossary'\" class=\"tab-content\">\n            <div class='section padded' ng-class='{\"last\": !glossary.length}'>\n              <label>\n                <span translate='search'></span>\n                <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n              </label>\n              <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 250 }\" ng-change='suggest(query)'>\n            </div>\n            <div class='section last'>\n              <ul class='list-of-documents'><li ng-repeat='term in tab.items' ng-include='\"templates/partials/term.html\"|prefixTemplate'></li>\n              </ul>\n              <div ng-include='\"templates/partials/more.html\"|prefixTemplate'></div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'CVCE'\" class=\"tab-content\">\n            <div class='section padded' ng-class='{\"last\": !suggestResults.length}'>\n              <label>\n                <span translate='search'></span>\n                <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n              </label>\n              <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 250 }\" ng-change='suggest(query)'>\n            </div>\n            <div class='section last'>\n              <ul class='list-of-documents'>\n                <li ng-repeat='document in tab.items' ng-include='\"templates/partials/oembed-search-results.html\"|prefixTemplate'>\n                </li>\n              </ul>\n              <div class='more-wrapper'>\n                <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='more()'>\n                    <span ng-if='!tab.isLoadingNextItems'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n                    </span>\n                    <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'url'\" class=\"tab-content\">\n            <div class='section padded'>\n              <label translate='url'></label>\n              <span style='color: #b7b7b7' translate='{{suggestMessage}}'></span>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea monospace\" rows=\"3\" msd-elastic ng-model='url' ng-change='previewUrl(url)' type='text' placeholder='http://'></textarea>\n              </div>\n              \n              \n\n              <div class='preview' ng-show='embed.url' ng-class='embed.type'>\n                <!-- <div ng-if='embed.provider_name==\"CVCE\"' ng-include='\"templates/partials/embeds/cvce.html\"|prefixTemplate'></div> -->\n                <!-- <div ng-if='embed.provider_name==\"YouTube\"' ng-include='\"templates/partials/embeds/YouTube.html\"|prefixTemplate'></div> -->\n                <div ng-if='embed.type == \"photo\"' ng-include='\"templates/partials/embeds/Flickr.html\"|prefixTemplate'></div>\n                <div ng-if='embed.provider_name==\"Ina.fr\"' ng-include='\"templates/partials/embeds/Ina.fr.html\"|prefixTemplate'></div>\n\n                <div ng-if='embed.type == \"link\"'>\n                  <!-- <p translate='enrich.url.noembedfound'></p> -->\n                  <div ng-if='embed.thumbnail_url' class='image-wrapper'>\n                    <div lazy-img='{{embed.thumbnail_url}}' class='cover' style='height: 100%'></div>\n                  </div>\n                  \n                  <a class='permalink' target='_blank' ng-href='{{embed.url}}'>{{embed.title}}</a>\n                  <div class='description'>{{embed.description}} <a target='_blank' ng-href='{{embed.url}}'>{{embed.url|smartUrl}}</a></div>\n                  \n                  \n                </div>\n\n                <div ng-if='embed.type == \"rich\" || embed.type == \"video\" || embed.type == \"timeline\"'>\n                  <div ng-if='embed.html' class='embed' style='height: 300px; width: 100%; overflow: auto' embedit='embed.html' stretch=\"true\"></div>\n                  <div ng-include='\"templates/partials/embeds/metadata.html\"|prefixTemplate'></div>\n\n                </div>\n                <div style='clear:both'></div>\n              </div>\n            </div>\n            <div class='section padded'>\n              <label>\n                <div translate='enrich.url.iframe.description'></div>\n                <span ng-if='!url' translate='enrich.url.embedRequiresUrl'></span><span ng-if='url && !isUrlValid' translate='enrich.url.notvalid'></span>\n              </label>\n              <div class='elastic-textarea-wrapper' ng-class='{\"disabled\": !isUrlValid}'>\n                <textarea class=\"elastic-textarea monospace limited\" ng-change='tab.onEmbedChange()' ng-disabled='!isUrlValid' rows=\"3\" msd-elastic  ng-model='embed.html' type='text' placeholder=''></textarea>\n              </div>\n            </div>\n            <div class='section padded'>\n              <label translate='title'></label>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model='embed.title' type='text' placeholder='untitled'></textarea>\n              </div>\n            </div>\n            <div class='section padded'>\n              <label translate='description'></label>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model='embed.description' type='text' placeholder='untitled'></textarea>\n              </div>\n            </div>\n            <div class='section padded last'>\n              <label translate='bibtex reference'></label>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea bibtex\" rows=\"3\" msd-elastic ng-model='reference' type='text' placeholder='@{}'></textarea>\n              </div>\n              <div class='sans-serif description' translate='bibtex.howto'></div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'upload'\" class=\"tab-content\">\n            <div class='section padded'>\n              <div class='drop-box-form-wrapper'>\n                <form name=\"createForm\" novalidate class=\"simple-form\">\n                  <div ng-show='!uploadablefile.size'>\n                    <div ngf-drop ngf-select ng-model=\"uploadable\" class=\"drop-box sans-serif\" \n                         ngf-drag-over-class=\"'dragover'\" ngf-multiple=\"false\" ngf-allow-dir=\"true\"\n                         accept=\"image/*,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document\" \n                         ngf-pattern=\"'image/*,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document'\"><span translate=\"drop.to.upload\"></span>\n                    </div>\n                  </div>\n                  <div class=\"uploadable\" ng-show='uploadablefile.size'>  \n                    <div ng-if='!uploadablefile.document'>\n                      <span>{{uploadablefile.name}}</span>\n                      <span>{{uploadablefile.type}}</span>\n                      <span>{{uploadablefile.size}}</span>\n                      <div class='btn-line-group'><a class='btn-line' ng-click='undo()' translate='button.undo'></a></div>\n                      \n                    </div>\n                    <div class=\"loading-bar\" style='width:{{uploadablefile.progressPercentage|| 0}}%'></div>\n                    \n                    <div class='doc-uploaded' ng-if='uploadablefile.document' ng-init='document=uploadablefile.document'>\n                      <div class=\"row\">\n                        <div class=\"col-sm-5\">\n                          <div class=\"cover\" style='height: 180px;' lazy-img='{{document.snapshot}}'></div>\n                        </div>\n                        <div class=\"col-sm-7\">\n                          <div class='title sans-serif' embedit='document.data.title'></div>\n                          <div class='copyright' embedit='document.data.copyright'></div>\n                        </div>\n                      </div>\n\n                    </div>\n                  </div>\n                </form>\n              </div>\n              <div ngf-no-file-drop><span translate='feature.unsupported.dragdrop'></span></div>\n            </div>\n            <!-- @todo -->\n            <div class='section padded' ng-show='!uploadablefile.document'>\n\n              <label translate='title'></label>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model='uploadablefile.title' type='text' placeholder='untitled'></textarea>\n              </div>\n            </div>\n            <div class='section padded' ng-show='!uploadablefile.document'>\n              <label translate='copyright'></label>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model='uploadablefile.copyright' type='text' placeholder='untitled'></textarea>\n              </div>\n            </div>\n            <div class='section padded last' ng-show='!uploadablefile.document'>\n              <label translate='bibtex reference'></label>\n              <div class='sans-serif description' translate='bibtex.howto'></div> \n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" style='max-height: 200px;' rows=\"3\" msd-elastic ng-model='reference' type='text' placeholder='@{}'></textarea>\n              </div>\n              \n            </div>\n            <div class='section padded last center' ng-show='!uploadablefile.document'>\n              <div class='btn-line-group' ng-class='{\"primary\":uploadablefile.size}'>\n                <button class='btn-line' ng-click='upload()' translate='button.upload'></button>\n              </div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'iframe'\" class=\"tab-content\">\n            <!-- @todo -->\n          </div>\n\n          <div ng-show=\"tab.name == 'bibtex'\" class=\"tab-content\">\n            <span translate='bibtex.howto'></span>\n            <label translate='bibtex'></label>\n            <div class='elastic-textarea-wrapper'>\n              <textarea class=\"elastic-textarea\" style=\"font-family: monospace;\" rows=\"8\" msd-elastic ng-model='reference' type='text' placeholder='@BOOK {}'></textarea>\n            </div>\n          </div>\n          <div style='clear:both'></div>\n\n\n      </div>\n      <div class=\"modal-footer\">\n        <span class='btn-line-group' ng-class='{\"primary\": isSomethingSelected}'>\n          <button type=\"button\" class=\"btn-line\" ng-class='{\"active\": isSomethingSelected}' ng-click=\"addDocument(tab.name, contents, reference, url, embed)\" translate='button.add'></button>\n        </span>\n        <span class='btn-line-group'>\n        <button type=\"button\" class=\"btn-line\" ng-click=\"$hide()\">Close</button>\n        </span>\n      </div>\n    </div>\n  </div>\n</div>"),
$templateCache.put("/static/templates/partials/modals/save-doi.html","<div class=\"modal save-doi\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1051; display: block;\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <button type=\"button\" class=\"close\" aria-label=\"Close\" ng-click=\"$hide()\">\n        <span aria-hidden=\"true\" class='icon-close'></span>\n        </button>\n        <h4 class=\"modal-title\"><span translate=\"modals.savedoi.title\"></span><span ng-if='doi'> ({{doi}})</span></h4>\n      </div>\n      <div class=\"modal-body\" style='padding: 20px 0'>\n        <div class=\"container-fluid\" >\n          <div class='row'>\n            <div  class='col-md-12'>\n            <p translate='modals.savedoi.description' class='sans-serif' style='font-size:11px; line-height:18px; margin-bottom:10px'>\n            </p>\n            <div>\n              <div class='btn-line-group'>\n                <a class='btn-line' target='_blank' href=\"/admin/miller/story/{{storyId}}/change/\">change metadata (admin)</a>\n              </div>\n              <div class='btn-line-group transparent' ng-if='should_update_doi'>\n                <a class='btn-line' target='_blank' href=\"/api/story/{{storyId}}/doi/metadata/\">verify remote metadata</a>\n              </div>\n              <div class='btn-line-group transparent' ng-if='doi'>\n                <a class='btn-line' target='_blank' href=\"/api/story/{{storyId}}/doi/metadata/?test=true&content-type=xml\">preview metadata</a>\n              </div>\n            </div>\n              <table class='table async' ng-class='{\"loading\": !currentMetadata}'>\n                <tr><th>DOI</th><td><span>{{currentMetadata.DOI}}</span><span class='badge' ng-if='should_update_doi'><span class='icon icon-check'></span>public</span><span class='badge badge-warning' ng-if='!should_update_doi && currentMetadata'><span class='icon icon-exclamation'></span>not yet created</span></td></tr>\n                <tr><th>publisher</th><td><span>{{currentMetadata.publisher}}</span></td></tr>\n                <tr><th>resourceType</th><td><span>{{currentMetadata.resourceType}}</span></td></tr>\n                <tr><th>publicationYear</th><td><span>{{currentMetadata.publicationYear}}</span></td></tr>\n                <tr><th>lastUpdate</th><td><span>{{currentMetadata.lastUpdate}}</span></td></tr>\n                <tr><th>title</th><td><span>{{currentMetadata.title}}</span></td></tr>\n                <tr><th>abstract</th><td style='font-size:11px;line-height:18px'><span>{{currentMetadata.abstract}}<span></td></tr>\n                <tr><th>subjects</th><td style='font-size:11px;line-height:18px'><span>{{currentMetadata.subjects}}<span></td></tr>\n                <tr>\n                  <th>creators</th>\n                  <td>\n                    <ol ng-repeat='person in currentMetadata.creators'><li><b>{{person.creatorName}}</b><br/><em>affiliation</em>: {{person.affiliation || \"*no affiliation*\"}}<br/><em>ORCID</em>: {{person.ORCID || \"*no orcid*\"}}</li></ol>\n                  </td>\n                </tr>\n                <tr>\n                  <th>contributors</th>\n                  <td>\n                    <ol ng-repeat='person in currentMetadata.contributors'><li><b>{{person.contributorName}}</b><br/><em>role</em>: {{person.contributorType}}<br/><em>affiliation</em>: {{person.affiliation || \"*no affiliation*\"}}<br/><em>ORCID</em>: {{person.ORCID || \"*no orcid*\"}}</li></ol>\n                    \n                  </td>\n                </tr>\n              </table>\n              \n            </div>\n          </div>\n          <div class='row' ng-if='log_message.error'>\n            <div class='modal-message error'>{{log_message.error}}, {{log_message.errorDescription}}</div>\n          </div>\n        </div>\n      </div>\n      <div class=\"modal-footer\">\n        <span class='btn-line-group primary'>\n          <button type=\"submit\" class=\"btn-line \" ng-disabled='is_saving && !doi' ng-click=\"confirm()\" translate='button.createorupdate' translate-values='{create: !should_update_doi}'></button>\n        </span>\n        <span class='btn-line-group transparent'>\n          <button type=\"button\" class=\"btn-line\" ng-click=\"$hide()\" translate='button.dismiss'></button>\n        </span>\n      </div>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/modals/save-version.html",'<div class="modal" tabindex="-1" role="dialog" aria-hidden="true" style="z-index: 1051; display: block;">\n  <div class="modal-dialog">\n    <form name="f">\n      <div class="modal-content">\n        <div class="modal-header">\n          <button type="button" class="close" aria-label="Close" ng-click="$hide()">\n          <span aria-hidden="true" class=\'icon-close\'></span>\n          </button>\n          <h4 class="modal-title" translate="modals.saveversion.title"></h4>\n        </div>\n        \n        <div class="modal-body">\n          <div class="container-fluid" style=\'padding-bottom: 20px\'>\n            <div class=\'row\' ng-if=\'errors && errors.tag\'>\n              <div class=\'modal-message error\'><span translate=\'modals.saveversion.tagexist\'></span></div>\n            </div>\n            <div class=\'row\'>\n              <div  class=\'col-md-12\'>\n                <label><span translate="modals.saveversion.field.version.tag.label"></span>\n                  <div class="description"><span translate="modals.saveversion.field.version.tag.description"></span></div>\n                </label>\n                <div class="elastic-textarea-wrapper">\n                  <textarea required ng-model=\'version.tag\' ng-pattern=\'/^[A-Za-z\\d\\._\\-]+$/\' class=\'elastic-textarea\' style=\'min-height: 25px\' msd-elastic></textarea>\n                </div>\n              </div>\n\n\n              <div  class=\'col-md-12\'>\n                <label>\n                  <span translate="modals.saveversion.field.version.message.label"></span>\n                  {{version.message.length > 120? "> 120" : version.message.length}} / 120\n                </label>\n                <div class="elastic-textarea-wrapper">\n                <textarea ng-model=\'version.message\' class=\'elastic-textarea\' style=\'min-height: 50px\' ng-maxlength=\'120\' rows="3" msd-elastic></textarea>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n        \n        <!-- eof body -->\n        <div class="modal-footer">\n          <span class=\'btn-line-group\' ng-class=\'{"primary": f.$valid}\'><button type="submit" class="btn-line " ng-class="{\'active\':f.$valid}" ng-disabled=\'!f.$valid || is_saving\' ng-click="confirm()" translate=\'button.create\'></button>\n          </span>\n          <span class=\'btn-line-group transparent\'>\n          <button type="button" class="btn-line" ng-click="$hide()" translate=\'button.dismiss\'></button>\n          </span>\n        </div>\n        <!-- eof footer -->\n      </div>\n    </form>\n  </div>\n</div>')}]);